<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MarketPlanner OS</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0d6efd">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js').catch(err => console.log("SW error", err));
            });
        }
    </script>
    <style>
        body {
            background-color: #f8f9fa;
        }

        .card-resumen {
            background-color: #ffffff;
            border-left: 5px solid #0d6efd;
        }

        .precio-bs {
            color: #6c757d;
            font-size: 0.9em;
        }

        .nav-link.active {
            font-weight: bold;
        }

        /* Bot√≥n flotante para agregar */
        .fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>

<body>

    <div id="loginWall" class="position-fixed w-100 h-100 bg-white" style="z-index: 2000; top: 0; left: 0;">
        <div class="container h-100 d-flex justify-content-center align-items-center">
            <div class="card shadow-lg p-4" style="max-width: 400px; width: 100%;">
                <div class="text-center mb-4">
                    <i class="bi bi-shield-lock-fill text-primary" style="font-size: 3rem;"></i>
                    <h3 class="mt-2">MarketPlanner OS</h3>
                    <p class="text-muted">Inicia sesi√≥n para continuar</p>
                </div>
                <form id="formLogin">
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" id="loginEmail" class="form-control" required placeholder="tu@email.com">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Contrase√±a</label>
                        <input type="password" id="loginPass" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 py-2">Entrar</button>
                </form>
            </div>
        </div>
    </div>

    <nav class="navbar navbar-dark bg-primary sticky-top">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1"><i class="bi bi-cart4"></i> MarketPlanner</span>
            <div class="d-flex align-items-center">
                <button id="btnInstalar" class="btn btn-sm btn-outline-light me-2 d-none">
                    <i class="bi bi-download"></i> Instalar App
                </button>
                <div class="text-white text-end">
                    <small>BCV: <span id="displayTasa">0.00</span> Bs</small>
                </div>
            </div>
        </div>
    </nav>

    <ul class="nav nav-tabs nav-justified bg-white shadow-sm" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="lista-tab" data-bs-toggle="tab" data-bs-target="#lista" type="button">üõí
                Lista</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="finanzas-tab" data-bs-toggle="tab" data-bs-target="#finanzas" type="button">üí∞
                Finanzas</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="config-tab" data-bs-toggle="tab" data-bs-target="#config" type="button">‚öôÔ∏è
                Ajustes</button>
        </li>
    </ul>

    <div class="container mt-3 tab-content" id="myTabContent">

        <div class="tab-pane fade show active" id="lista" role="tabpanel">

            <div class="input-group mb-3">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input type="text" class="form-control" placeholder="Buscar producto o mercado..." id="buscador">
            </div>

            <div class="card card-resumen mb-3 shadow-sm">
                <div class="card-body py-2 d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="m-0 text-primary">Total Estimado</h6>
                        <small class="text-muted">Incidencia incluida</small>
                    </div>
                    <div class="text-end">
                        <h4 class="m-0" id="totalGeneralUSD">$0.00</h4>
                        <span class="precio-bs" id="totalGeneralBS">Bs 0.00</span>
                    </div>
                </div>
            </div>

            <div id="contenedorProductos" class="list-group">
                <div class="list-group-item d-flex justify-content-between align-items-start">
                    <div class="ms-2 me-auto">
                        <div class="fw-bold">Harina Pan <span class="badge bg-success rounded-pill">Vital</span></div>
                        <small>Mercado: Mayorista</small><br>
                        <small>Cant: 2 | $1.50 c/u</small>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-primary">$3.00</span><br>
                        <small class="text-muted">Bs 180.00</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="finanzas" role="tabpanel">

            <div class="card mb-3 shadow-sm">
                <div class="card-header bg-light fw-bold">üìâ Calculadora de Incidencia</div>
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-6">
                            <label class="form-label">Costo Inicial ($)</label>
                            <input type="number" class="form-control" id="costoInicial" placeholder="0.00">
                        </div>
                        <div class="col-6">
                            <label class="form-label">% Incidencia</label>
                            <input type="number" class="form-control" id="porcentajeIncidencia" value="10">
                        </div>
                    </div>
                    <div class="mt-2 p-2 bg-light border rounded text-center">
                        <strong>Costo Final: <span id="costoFinalCalc">$0.00</span></strong>
                    </div>
                </div>
            </div>

            <div class="card mb-3 shadow-sm border-primary">
                <div class="card-header bg-primary text-white fw-bold">üîµ Asistente de Compra Cashea</div>
                <div class="card-body">
                    <div class="row g-2 mb-3">
                        <div class="col-12">
                            <label class="form-label">Monto Total de la Compra ($)</label>
                            <input type="number" class="form-control" id="casheaMontoTotal" placeholder="0.00">
                        </div>
                        <div class="col-6">
                            <label class="form-label">L√≠nea de Compra</label>
                            <select class="form-select" id="casheaLinea" onchange="actualizarCuotasCashea()">
                                <option value="cotidiana">Cotidiana (1 cuota)</option>
                                <option value="principal" selected>Principal (Var. cuotas)</option>
                            </select>
                        </div>
                        <div class="col-6" id="contenedorCuotasPrincipal">
                            <label class="form-label">Nro. de Cuotas</label>
                            <select class="form-select" id="casheaCuotas">
                                <option value="3">3 Cuotas</option>
                                <option value="6">6 Cuotas</option>
                                <option value="9">9 Cuotas</option>
                                <option value="12">12 Cuotas</option>
                            </select>
                        </div>
                    </div>
                    <div id="resultadoCashea" class="p-2 bg-light border rounded small d-none">
                        <div class="d-flex justify-content-between"><span>Pago Inicial (40%):</span> <strong
                                id="casheaInicial">$0.00</strong></div>
                        <div class="d-flex justify-content-between"><span>Monto por Cuota:</span> <strong
                                id="casheaMontoCuota">$0.00</strong></div>
                        <hr class="my-1">
                        <button class="btn btn-sm btn-outline-primary w-100 mt-1" onclick="registrarCashea()">Registrar
                            Todo en Finanzas</button>
                    </div>
                </div>
            </div>

            <h5 class="border-bottom pb-2">Planificaci√≥n de Pagos</h5>
            <div class="alert alert-info py-2">
                <small>üí∞ Disponible: <strong id="dineroDisponible">$0.00</strong> (Ingresos - Deudas)</small>
            </div>

            <ul class="list-group mb-5" id="listaFinanzas">
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    Tarjeta de Cr√©dito
                    <span class="badge bg-danger rounded-pill">-$50.00 (15/12)</span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    Sueldo Quincena
                    <span class="badge bg-success rounded-pill">+$200.00</span>
                </li>
            </ul>
        </div>

        <div class="tab-pane fade" id="config" role="tabpanel">
            <div class="card p-3 shadow-sm mb-3" id="seccionAdmin">
                <h5><i class="bi bi-person-plus"></i> Registrar Usuario</h5>
                <form id="formNuevoUsuario" class="row g-2">
                    <div class="col-6">
                        <input type="text" id="regNombre" class="form-control form-control-sm" placeholder="Nombre"
                            required>
                    </div>
                    <div class="col-6">
                        <input type="email" id="regEmail" class="form-control form-control-sm" placeholder="Email"
                            required>
                    </div>
                    <div class="col-6">
                        <input type="password" id="regPass" class="form-control form-control-sm"
                            placeholder="Contrase√±a" required>
                    </div>
                    <div class="col-6">
                        <button type="submit" class="btn btn-success btn-sm w-100">Crear Usuario</button>
                    </div>
                </form>
            </div>

            <div class="card p-3 shadow-sm mb-3">
                <h5><i class="bi bi-share"></i> Privacidad de Mis Finanzas</h5>
                <p class="small text-muted">Selecciona qui√©n puede ver tus deudas e ingresos:</p>
                <div id="listaUsuariosCompartir" class="list-group list-group-flush">
                    <div class="text-center p-2">Cargando usuarios...</div>
                </div>
            </div>

            <div class="mt-4">
                <button class="btn btn-outline-danger w-100" onclick="cerrarSesion()">
                    <i class="bi bi-box-arrow-right"></i> Cerrar Sesi√≥n
                </button>
            </div>
        </div>
    </div>

    <button class="btn btn-primary fab" data-bs-toggle="modal" data-bs-target="#modalNuevo">
        <i class="bi bi-plus-lg"></i>
    </button>

    <div class="modal fade" id="modalNuevo" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nuevo Producto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formProducto">
                        <div class="mb-2">
                            <label>Producto</label>
                            <input type="text" class="form-control" required>
                        </div>
                        <div class="row mb-2">
                            <div class="col">
                                <label>Precio ($)</label>
                                <input type="number" step="0.01" class="form-control" required>
                            </div>
                            <div class="col">
                                <label>Cantidad</label>
                                <input type="number" class="form-control" value="1" required>
                            </div>
                        </div>
                        <div class="mb-2">
                            <label>Mercado</label>
                            <input type="text" class="form-control" list="mercadosList">
                            <datalist id="mercadosList">
                                <option value="Supermercado A">
                                <option value="Mercado Municipal">
                            </datalist>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary w-100">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx1J1hxN5wb6evXxenQTcfvZZ0htOz1z2_s4fnrk-L0nck84iCBXdMw5OCCMACTj0ec/exec"; // <--- ASEG√öRATE DE PEGARLA
        let currentUser = null;
        let tasaBCV = 0;

        // --- FUNCI√ìN PARA ENVIAR DATOS AL BACKEND ---
        async function llamarBackend(accion, payload = {}) {
            const url = SCRIPT_URL;
            const data = { action: accion, ...payload };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(data)
                });
                if (!response.ok) throw new Error("Error en la red");
                return await response.json();
            } catch (err) {
                console.warn("Error backend:", err);
                if (!navigator.onLine) {
                    alert("‚ö†Ô∏è Est√°s offline. Algunas funciones requieren internet.");
                }
                throw err;
            }
        }

        // --- L√ìGICA DE LOGIN ---
        document.getElementById('formLogin').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPass').value;

            try {
                const data = await llamarBackend('login', { email, password: pass });
                if (data.success) {
                    currentUser = data.user;

                    // --- PERSISTENCIA DE SESI√ìN ---
                    localStorage.setItem('plannerUser', JSON.stringify({
                        user: currentUser,
                        timestamp: new Date().getTime()
                    }));

                    document.getElementById('loginWall').classList.add('d-none'); // Quita el muro
                    cargarDatosIniciales();
                } else {
                    alert("Error: " + data.message);
                }
            } catch (err) {
                console.error(err);
                alert("Error de conexi√≥n con el servidor.");
            }
        });

        // --- SISTEMA DE NOTIFICACIONES ---
        async function verificarNotificaciones(finanzas) {
            if (!("Notification" in window)) return;

            if (Notification.permission === "default") {
                await Notification.requestPermission();
            }

            if (Notification.permission === "granted") {
                const hoy = new Date();
                // Buscar deudas que venzan en los pr√≥ximos 3 d√≠as
                const deudasProntas = finanzas.filter(f => {
                    const fecha = new Date(f[3]);
                    const difDias = Math.ceil((fecha - hoy) / (1000 * 60 * 60 * 24));
                    return f[0].toLowerCase() === 'egreso' && difDias >= 0 && difDias <= 3;
                });

                if (deudasProntas.length > 0) {
                    const nombresDeudas = deudasProntas.map(f => f[1]).join(", ");
                    new Notification("MarketPlanner: Pagos Pr√≥ximos", {
                        body: `Vencen pronto: ${nombresDeudas}. Revisa tu flujo de caja.`,
                        icon: 'app_icon_marketplanner_1766378047051.png'
                    });
                }
            }
        }

        // --- CARGAR DATOS (PRODUCTOS Y FINANZAS) ---
        async function cargarDatosIniciales() {
            try {
                const data = await llamarBackend('getInitialData', { userId: currentUser.id });
                if (!data.success) throw new Error(data.message);

                tasaBCV = data.tasa;
                document.getElementById('displayTasa').innerText = tasaBCV.toFixed(2);

                renderizarProductos(data.products);
                renderizarFinanzas(data.finanzas);

                // Nuevas funciones integradas
                verificarNotificaciones(data.finanzas);
                cargarListaCompartir();
            } catch (err) {
                console.error("Error al cargar datos:", err);
            }
        }

        // --- RENDERIZADO DE PRODUCTOS (CON B√öSQUEDA) ---
        let productosCache = []; // Para filtrar localmente

        function renderizarProductos(productos) {
            productosCache = productos;
            const contenedor = document.getElementById('contenedorProductos');
            const termino = document.getElementById('buscador').value.toLowerCase();

            contenedor.innerHTML = "";
            let totalUSD = 0;

            productos.forEach(p => {
                // p[1]=nombre, p[4]=mercado
                const coincide = p[1].toLowerCase().includes(termino) || p[4].toLowerCase().includes(termino);
                if (!coincide) return;

                const subtotal = p[2] * p[3];
                totalUSD += subtotal;

                contenedor.innerHTML += `
                    <div class="list-group-item d-flex justify-content-between align-items-start">
                        <div class="ms-2 me-auto">
                            <div class="fw-bold">${p[1]} <span class="badge bg-info">${p[5] || 'General'}</span></div>
                            <small class="text-muted">üìç ${p[4]}</small><br>
                            <small>${p[2]} x $${p[3]}</small>
                        </div>
                        <div class="text-end">
                            <span class="fw-bold text-primary">$${subtotal.toFixed(2)}</span><br>
                            <small class="precio-bs">Bs ${(subtotal * tasaBCV).toFixed(2)}</small>
                            <div class="mt-1">
                                <button class="btn btn-sm btn-outline-secondary py-0 px-1" onclick="prepararEdicion(${p[0]})"><i class="bi bi-pencil small"></i></button>
                                <button class="btn btn-sm btn-outline-danger py-0 px-1" onclick="eliminarProducto(${p[0]})"><i class="bi bi-trash small"></i></button>
                            </div>
                        </div>
                    </div>
                `;
            });

            document.getElementById('totalGeneralUSD').innerText = `$${totalUSD.toFixed(2)}`;
            document.getElementById('totalGeneralBS').innerText = `Bs ${(totalUSD * tasaBCV).toFixed(2)}`;
        }

        // Evento de b√∫squeda
        document.getElementById('buscador').addEventListener('input', () => renderizarProductos(productosCache));

        // --- MANEJO DE FORMULARIO DE PRODUCTO ---
        document.getElementById('formProducto').addEventListener('submit', async (e) => {
            e.preventDefault();
            const inputs = e.target.elements;

            // Seguridad: Validaci√≥n b√°sica antes de enviar
            const nombre = inputs[0].value.trim();
            const precio = parseFloat(inputs[1].value);
            const cantidad = parseInt(inputs[2].value);
            const mercado = inputs[3].value.trim();

            if (!nombre || isNaN(precio) || cantidad <= 0) {
                alert("Por favor, completa los campos correctamente.");
                return;
            }

            const payload = {
                userId: currentUser.id,
                nombre,
                precio,
                cantidad,
                mercado
            };

            try {
                const action = currentEditId ? 'updateProduct' : 'saveProduct';
                const payloadFinal = currentEditId ? { id: currentEditId, payload } : { payload };

                const res = await llamarBackend(action, { ...payloadFinal, userId: currentUser.id });
                if (res.success) {
                    bootstrap.Modal.getInstance(document.getElementById('modalNuevo')).hide();
                    e.target.reset();
                    currentEditId = null;
                    document.querySelector('#modalNuevo .modal-title').innerText = "Nuevo Producto";
                    cargarDatosIniciales();
                } else {
                    alert("Error servidor: " + res.message);
                }
            } catch (err) {
                console.error(err);
                alert("Error cr√≠tico al procesar producto");
            }
        });

        let currentEditId = null;

        function prepararEdicion(id) {
            const p = productosCache.find(prod => prod[0] == id);
            if (!p) return;

            currentEditId = id;
            document.querySelector('#modalNuevo .modal-title').innerText = "Editar Producto";

            const inputs = document.getElementById('formProducto').elements;
            inputs[0].value = p[1]; // nombre
            inputs[1].value = p[3]; // precio
            inputs[2].value = p[2]; // cantidad
            inputs[3].value = p[4]; // mercado

            bootstrap.Modal.getOrCreateInstance(document.getElementById('modalNuevo')).show();
        }

        async function eliminarProducto(id) {
            if (!confirm("¬øSeguro que deseas eliminar este producto?")) return;
            try {
                const res = await llamarBackend('deleteProduct', { id, userId: currentUser.id });
                if (res.success) {
                    cargarDatosIniciales();
                } else {
                    alert("No se pudo eliminar: " + res.message);
                }
            } catch (err) {
                console.error(err);
            }
        }

        // --- COMPARATIVA DE PRECIOS ---
        document.querySelector('#formProducto input[type="text"]').addEventListener('blur', async (e) => {
            const nombre = e.target.value.trim();
            if (nombre.length < 3) return;

            try {
                const res = await llamarBackend('getPriceHistory', { nombreProducto: nombre });
                if (res.success && res.history.length > 0) {
                    mostrarComparativa(res.history);
                }
            } catch (err) {
                console.warn("Error historial:", err);
            }
        });

        function mostrarComparativa(historial) {
            // Agrupar por mercado y quedarnos con el √∫ltimo precio
            const mercados = {};
            historial.forEach(h => {
                mercados[h.mercado] = h.precio;
            });

            // Encontrar el precio m√°s bajo
            const precios = Object.values(mercados);
            const minPrecio = Math.min(...precios);

            let html = '<div class="mt-2 small border rounded p-2 bg-light"><strong><i class="bi bi-info-circle"></i> Comparativa de Mercados:</strong><br>';
            for (const [mer, pre] of Object.entries(mercados)) {
                const esMejor = pre === minPrecio;
                html += `<div class="d-flex justify-content-between ${esMejor ? 'text-success fw-bold' : ''}">
                            <span>${mer}:</span>
                            <span>$${pre.toFixed(2)} ${esMejor ? 'üöÄ' : ''}</span>
                         </div>`;
            }
            if (precios.length > 1) {
                html += `<div class="mt-1 text-muted text-center" style="font-size: 0.8em;">* Basado en tus compras anteriores</div>`;
            }
            html += '</div>';

            const existing = document.getElementById('historialContenedor');
            if (existing) existing.remove();

            const div = document.createElement('div');
            div.id = 'historialContenedor';
            div.innerHTML = html;
            document.getElementById('formProducto').appendChild(div);
        }

        // Vincular bot√≥n guardar del modal
        document.querySelector('#modalNuevo .btn-primary').addEventListener('click', () => {
            document.getElementById('formProducto').requestSubmit();
        });

        // --- L√ìGICA ASISTENTE CASHEA ---
        const inputCasheaMonto = document.getElementById('casheaMontoTotal');
        const selectLinea = document.getElementById('casheaLinea');
        const selectCuotas = document.getElementById('casheaCuotas');
        const resCashea = document.getElementById('resultadoCashea');

        function actualizarCuotasCashea() {
            const linea = selectLinea.value;
            const monto = parseFloat(inputCasheaMonto.value) || 0;
            const contCuotasPrin = document.getElementById('contenedorCuotasPrincipal');

            contCuotasPrin.classList.toggle('d-none', linea === 'cotidiana');

            if (monto > 0) {
                resCashea.classList.remove('d-none');
                const inicial = monto * 0.40; // Pago inicial est√°ndar 40%
                const restante = monto - inicial;
                const nCuotas = linea === 'cotidiana' ? 1 : parseInt(selectCuotas.value);
                const montoCuota = restante / nCuotas;

                document.getElementById('casheaInicial').innerText = `$${inicial.toFixed(2)}`;
                document.getElementById('casheaMontoCuota').innerText = `$${montoCuota.toFixed(2)}`;
            } else {
                resCashea.classList.add('d-none');
            }
        }

        [inputCasheaMonto, selectLinea, selectCuotas].forEach(el => {
            el.addEventListener('input', actualizarCuotasCashea);
        });

        async function registrarCashea() {
            const monto = parseFloat(inputCasheaMonto.value);
            const linea = selectLinea.value;
            const nCuotas = linea === 'cotidiana' ? 1 : parseInt(selectCuotas.value);
            const inicial = monto * 0.40;
            const montoCuota = (monto - inicial) / nCuotas;

            if (!confirm(`¬øRegistrar pago inicial de $${inicial.toFixed(2)} y ${nCuotas} cuotas de $${montoCuota.toFixed(2)}?`)) return;

            // 1. Registrar pago inicial (hoy)
            await llamarBackend('saveFinance', {
                payload: { tipo: 'egreso', nombre: 'Cashea - Inicial', monto: inicial, fecha: new Date().toISOString(), ownerId: currentUser.id }
            });

            // 2. Registrar cuotas futuras
            const fechaBase = new Date(); // Podr√≠a ser una fecha seleccionada en el futuro
            for (let i = 1; i <= nCuotas; i++) {
                const fechaCuota = new Date(fechaBase);
                fechaCuota.setDate(fechaBase.getDate() + (i * 14)); // Intervalos exactos de 14 d√≠as

                await llamarBackend('saveFinance', {
                    payload: {
                        tipo: 'egreso',
                        nombre: `Cashea - Cuota ${i}/${nCuotas} (${linea})`,
                        monto: montoCuota,
                        fecha: fechaCuota.toISOString(),
                        ownerId: currentUser.id
                    }
                });
            }

            alert("Plan Cashea registrado con √©xito");
            cargarDatosIniciales();
        }

        // --- CALCULADORA DE INCIDENCIA (TIEMPO REAL) ---
        const inputCosto = document.getElementById('costoInicial');
        const inputIncid = document.getElementById('porcentajeIncidencia');

        [inputCosto, inputIncid].forEach(el => {
            el.addEventListener('input', () => {
                const costo = parseFloat(inputCosto.value) || 0;
                const porc = parseFloat(inputIncid.value) || 0;
                const total = costo + (costo * (porc / 100));
                document.getElementById('costoFinalCalc').innerText = `$${total.toFixed(2)} | Bs ${(total * tasaBCV).toFixed(2)}`;
            });
        });

        function renderizarFinanzas(finanzas) {
            const lista = document.getElementById('listaFinanzas');
            const displayDisponible = document.getElementById('dineroDisponible');
            lista.innerHTML = "";

            let totalIngresos = 0;
            let totalDeudas = 0;

            // Ordenar por fecha (asumiendo que la fecha es la columna D, √≠ndice 3)
            finanzas.sort((a, b) => new Date(a[3]) - new Date(b[3]));

            finanzas.forEach(f => {
                const monto = parseFloat(f[2]);
                const esIngreso = f[0].toLowerCase() === 'ingreso';
                const fechaFormateada = f[3] ? new Date(f[3]).toLocaleDateString() : 'S/F';

                if (esIngreso) totalIngresos += monto;
                else totalDeudas += monto;

                lista.innerHTML += `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${f[1]}</strong><br>
                            <small class="text-muted"><i class="bi bi-calendar"></i> ${fechaFormateada}</small>
                        </div>
                        <span class="badge ${esIngreso ? 'bg-success' : 'bg-danger'} rounded-pill">
                            ${esIngreso ? '+' : '-'}$${monto.toFixed(2)}
                        </span>
                    </li>
                `;
            });

            const disponible = totalIngresos - totalDeudas;
            displayDisponible.innerText = `$${disponible.toFixed(2)} | Bs ${(disponible * tasaBCV).toFixed(2)}`;
            displayDisponible.className = disponible >= 0 ? "text-success fw-bold" : "text-danger fw-bold";
        }

        // --- REGISTRAR NUEVO USUARIO ---
        document.getElementById('formNuevoUsuario').addEventListener('submit', async (e) => {
            e.preventDefault();
            const payload = {
                nombre: document.getElementById('regNombre').value,
                email: document.getElementById('regEmail').value,
                pass: document.getElementById('regPass').value,
                rol: 'Usuario'
            };

            const res = await llamarBackend('crearUsuario', { payload });
            if (res.success) {
                alert("Usuario creado con √©xito");
                e.target.reset();
                cargarListaCompartir(); // Refrescar lista
            }
        });

        // --- CARGAR OTROS USUARIOS PARA COMPARTIR ---
        async function cargarListaCompartir() {
            try {
                const data = await llamarBackend('getAllUsers');
                const contenedor = document.getElementById('listaUsuariosCompartir');
                contenedor.innerHTML = "";

                if (data.usuarios) {
                    data.usuarios.forEach(u => {
                        if (u.id == currentUser.id) return;

                        contenedor.innerHTML += `
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <span>${u.nombre}</span>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" 
                                           onchange="actualizarPermiso(${u.id}, this.checked)"
                                           ${u.tieneAcceso ? 'checked' : ''}>
                                </div>
                            </div>
                        `;
                    });
                }
            } catch (err) {
                console.warn("No se pudo cargar la lista de usuarios:", err);
            }
        }

        async function actualizarPermiso(idInvitado, otorgar) {
            await llamarBackend('gestionarPermiso', {
                idInvitado: idInvitado,
                accionPermiso: otorgar ? 'conceder' : 'revocar',
                userId: currentUser.id
            });
            console.log(`Permiso ${otorgar ? 'concedido' : 'revocado'} para usuario ${idInvitado}`);
        }

        // --- L√ìGICA DE INSTALACI√ìN PWA ---
        let deferredPrompt;
        const btnInstalar = document.getElementById('btnInstalar');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            btnInstalar.classList.remove('d-none');
        });

        btnInstalar.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    btnInstalar.classList.add('d-none');
                }
                deferredPrompt = null;
            }
        });

        window.addEventListener('appinstalled', () => {
            btnInstalar.classList.add('d-none');
            console.log('PWA instalada con √©xito');
        });

        // --- INICIO AUTOM√ÅTICO AL CARGAR ---
        window.addEventListener('DOMContentLoaded', () => {
            const session = JSON.parse(localStorage.getItem('plannerUser'));

            if (session && session.user) {
                currentUser = session.user;
                document.getElementById('loginWall').classList.add('d-none');
                cargarDatosIniciales();
            }
        });

        function cerrarSesion() {
            if (confirm("¬øEst√°s seguro de que quieres cerrar sesi√≥n?")) {
                localStorage.removeItem('plannerUser');
                location.reload();
            }
        }

    </script>
</body>

</html>
