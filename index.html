<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MarketPlanner OS</title>

    <!-- PWA Configuration -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0d6efd">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="MarketPlanner">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="MarketPlanner OS">

    <!-- Icons for PWA -->
    <link rel="icon" type="image/png" sizes="192x192" href="app_icon_marketplanner_1766378047051.png">
    <link rel="apple-touch-icon" href="app_icon_marketplanner_1766378047051.png">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js').catch(err => console.log("SW error", err));
            });
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="inventory.js"></script>
    <script src="savings.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>

<body>

    <div id="loginWall" class="position-fixed w-100 h-100" style="z-index: 2000; top: 0; left: 0;">
        <div class="container h-100 d-flex justify-content-center align-items-center">
            <div class="card shadow-lg p-4" style="max-width: 400px; width: 100%;">
                <div class="text-center mb-4">
                    <i class="bi bi-shield-lock-fill text-primary" style="font-size: 3rem;"></i>
                    <h3 class="mt-2">MarketPlanner OS</h3>
                    <p class="text-muted">Inicia sesi√≥n para continuar</p>
                </div>
                <form id="formLogin">
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" id="loginEmail" class="form-control" required placeholder="tu@email.com">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Contrase√±a</label>
                        <input type="password" id="loginPass" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 py-2">Entrar</button>
                    <div class="text-center mt-3">
                        <a href="#" onclick="toggleAuth(true)" class="text-decoration-none">¬øNo tienes cuenta?
                            Reg√≠strate</a>
                    </div>
                </form>

                <form id="formRegistro" style="display: none;">
                    <div class="mb-3">
                        <label class="form-label">Nombre Completo</label>
                        <input type="text" id="regNombreSelf" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" id="regEmailSelf" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Contrase√±a</label>
                        <input type="password" id="regPassSelf" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-success w-100 py-2">Registrarse</button>
                    <div class="text-center mt-3">
                        <a href="#" onclick="toggleAuth(false)" class="text-decoration-none">¬øYa tienes cuenta? Inicia
                            sesi√≥n</a>
                    </div>
                    <small class="text-muted d-block mt-2 text-center">Tu cuenta deber√° ser aprobada por un
                        administrador.</small>
                </form>
            </div>
        </div>
    </div>

    <nav class="navbar navbar-light sticky-top">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1"><i class="bi bi-cart4"></i> MarketPlanner</span>
            <div class="d-flex align-items-center">
                <button id="btnInstalar" class="btn btn-sm btn-outline-primary me-2 d-none">
                    <i class="bi bi-download"></i> Instalar App
                </button>
                <div class="text-primary text-end fw-bold px-2 py-1 rounded"
                    style="background: rgba(var(--primary-rgb), 0.1); border: 1px solid rgba(var(--primary-rgb), 0.2);">
                    <small>BCV: <span id="displayTasa" class="text-primary">0.00</span> Bs</small>
                </div>
            </div>
        </div>
    </nav>

    <ul class="nav nav-tabs nav-justified bg-white shadow-sm" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="inicio-tab" data-bs-toggle="tab" data-bs-target="#inicio"
                type="button">üè†
                Inicio</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="lista-tab" data-bs-toggle="tab" data-bs-target="#lista" type="button">üõí
                Lista</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="productos-tab" data-bs-toggle="tab" data-bs-target="#productos"
                type="button">üì¶
                Productos</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="gestion-tab" data-bs-toggle="tab" data-bs-target="#gestion" type="button">üí∞
                Gesti√≥n</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="perfil-tab" data-bs-toggle="tab" data-bs-target="#perfil" type="button">üë§
                Perfil</button>
        </li>
    </ul>

    <div class="container mt-3 tab-content" id="myTabContent">

        <div class="tab-pane fade show active" id="inicio" role="tabpanel">
            <div class="card shadow-sm border-0 mb-3 bg-primary text-white"
                style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="fw-bold mb-1">Hola, <span id="welcomeName">Usuario</span>! üëã</h5>
                            <p class="small opacity-75 mb-0">Resumen financiero de este mes</p>
                        </div>
                        <i class="bi bi-person-circle fs-1 opacity-50"></i>
                    </div>
                </div>
            </div>

            <!-- Dashboard con Gr√°ficas (Moved) -->
            <div class="card mb-3 shadow-sm">
                <div class="card-header py-2 d-flex justify-content-between align-items-center" style="cursor: pointer;"
                    data-bs-toggle="collapse" data-bs-target="#collapseDashboard">
                    <span class="small fw-bold text-uppercase">üìà Dashboard Financiero</span>
                    <i class="bi bi-graph-up text-primary"></i>
                </div>
                <!-- Default open on Desktop? Keep collapsed for mobile as before or show? -->
                <div id="collapseDashboard" class="collapse show">
                    <div class="card-body">
                        <!-- Resumen de M√©tricas -->
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <div class="p-2 rounded"
                                    style="background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);">
                                    <div class="small text-white opacity-75">Ingresos (Mes)</div>
                                    <h6 class="mb-0 text-white" id="statIngresosMes">$0.00</h6>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-2 rounded"
                                    style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                                    <div class="small text-white opacity-75">Gastos (Mes)</div>
                                    <h6 class="mb-0 text-white" id="statGastosMes">$0.00</h6>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-2 rounded"
                                    style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
                                    <div class="small text-dark opacity-75">Balance</div>
                                    <h6 class="mb-0 text-dark" id="statBalance">$0.00</h6>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-2 rounded"
                                    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                    <div class="small text-white opacity-75">Ahorros</div>
                                    <h6 class="mb-0 text-white" id="statAhorros">$0.00</h6>
                                </div>
                            </div>
                        </div>

                        <!-- Tabs para diferentes gr√°ficas -->
                        <ul class="nav nav-pills nav-fill mb-2 small" id="chartTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active py-1" id="tab-monthly" data-bs-toggle="tab"
                                    data-bs-target="#monthly-charts" type="button"
                                    style="font-size: 0.75rem;">Mensual</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link py-1" id="tab-weekly" data-bs-toggle="tab"
                                    data-bs-target="#weekly-charts" type="button"
                                    style="font-size: 0.75rem;">Semanal</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link py-1" id="tab-comparison" data-bs-toggle="tab"
                                    data-bs-target="#comparison-chart" type="button"
                                    style="font-size: 0.75rem;">Comparativa</button>
                            </li>
                        </ul>

                        <!-- Contenido de tabs -->
                        <div class="tab-content" id="chartTabsContent">
                            <div class="tab-pane fade show active" id="monthly-charts" role="tabpanel">
                                <canvas id="chartMensual" height="200"></canvas>
                            </div>
                            <div class="tab-pane fade" id="weekly-charts" role="tabpanel">
                                <canvas id="chartSemanal" height="200"></canvas>
                            </div>
                            <div class="tab-pane fade" id="comparison-chart" role="tabpanel">
                                <canvas id="chartComparativa" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="lista" role="tabpanel">

            <div class="search-container mb-3">
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" placeholder="Buscar producto o mercado..." id="buscador"
                        autocomplete="off">
                    <button class="btn btn-outline-primary" type="button" onclick="abrirEscanner('search')">
                        <i class="bi bi-barcode-scan"></i>
                    </button>
                </div>
                <div id="sugerenciasBusqueda" class="search-suggestions"></div>
            </div>

            <!-- Budget Dashboard -->
            <div class="card border-0 shadow-sm mb-3"
                style="background: var(--card-bg); border-radius: var(--radius-lg);">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-end mb-2">
                        <div>
                            <small class="text-muted fw-bold text-uppercase"
                                style="font-size: 0.7rem; letter-spacing: 0.5px;">Presupuesto</small>
                            <div class="d-flex align-items-center gap-2 cursor-pointer" onclick="editarPresupuesto()">
                                <h3 class="m-0 fw-bold" id="displayPresupuesto">$0.00</h3>
                                <i class="bi bi-pencil-square text-muted opacity-50"></i>
                            </div>
                        </div>
                        <div class="text-end">
                            <small class="text-muted d-block mb-1">Total Lista</small>
                            <h3 class="m-0 fw-bold text-primary" id="totalGeneralUSD">$0.00</h3>
                            <small class="text-muted" id="totalGeneralBS">Bs 0.00</small>
                        </div>
                    </div>

                    <!-- Progress Bar -->
                    <div class="progress"
                        style="height: 12px; border-radius: 6px; background-color: var(--primary-soft);">
                        <div id="budgetProgress" class="progress-bar bg-success" role="progressbar"
                            style="width: 0%; transition: width 0.5s ease;"></div>
                    </div>
                    <div class="d-flex justify-content-between mt-2 small text-muted">
                        <span id="budgetStatus">Dentro del l√≠mite</span>
                        <span id="budgetRemaining">Restante: $0.00</span>
                    </div>
                </div>
            </div>

            <div id="contenedorProductos" class="list-group">
                <!-- Los productos se cargan aqu√≠ -->
            </div>

            <button class="btn btn-primary fab" data-bs-toggle="modal" data-bs-target="#modalNuevo">
                <i class="bi bi-plus-lg"></i>
            </button>
        </div>

        <div class="tab-pane fade" id="gestion" role="tabpanel">

            <!-- Sub Nav -->
            <ul class="nav nav-pills nav-fill mb-3 text-uppercase small bg-light p-1 rounded" id="gestionTabs"
                role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active py-1" id="sub-pagos-tab" data-bs-toggle="tab"
                        data-bs-target="#sub-pagos" type="button">üîÑ Pagos</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link py-1" id="sub-gastos-tab" data-bs-toggle="tab" data-bs-target="#sub-gastos"
                        type="button">üí∏ Gastos</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link py-1" id="sub-ahorros-tab" data-bs-toggle="tab"
                        data-bs-target="#sub-ahorros" type="button">üê∑ Ahorros</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link py-1" id="sub-presupuestos-tab" data-bs-toggle="tab"
                        data-bs-target="#sub-presupuestos" type="button">üìä Presupuesto</button>
                </li>
            </ul>

            <div class="tab-content" id="gestionTabContent">

                <!-- PAGOS TAB -->
                <div class="tab-pane fade show active" id="sub-pagos" role="tabpanel">
                    <div class="mt-4">
                        <h6 class="small fw-bold text-uppercase text-muted letter-spacing-1 mb-3">Planificaci√≥n de Pagos
                        </h6>
                        <div
                            class="alert bg-primary-soft border-0 py-2 d-flex justify-content-between align-items-center">
                            <span class="small opacity-75">Disponible:</span>
                            <strong class="text-primary" id="dineroDisponible">$0.00</strong>
                        </div>

                        <!-- Calendario de Pagos -->
                        <div class="card shadow-sm mb-3">
                            <div class="calendar-header">
                                <button class="btn btn-sm btn-light" onclick="previousMonth()">
                                    <i class="bi bi-chevron-left"></i>
                                </button>
                                <div class="calendar-title" id="calendarTitle">Enero 2024</div>
                                <button class="btn btn-sm btn-light" onclick="nextMonth()">
                                    <i class="bi bi-chevron-right"></i>
                                </button>
                            </div>
                            <div class="calendar-grid" id="calendarGrid">
                                <!-- Generado din√°micamente -->
                            </div>
                        </div>

                        <ul class="list-group list-group-flush mb-5" id="listaFinanzas">
                            <!-- Din √°mico -->
                        </ul>
                    </div>

                    <!-- Gastos Recurrentes -->
                    <div class="card mb-3 shadow-sm">
                        <div class="card-header py-2 d-flex justify-content-between align-items-center"
                            style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#collapseRecurrentes">
                            <span class="small fw-bold text-uppercase">üîÅ Gastos Recurrentes</span>
                            <i class="bi bi-calendar-check text-primary"></i>
                        </div>
                        <div id="collapseRecurrentes" class="collapse">
                            <div class="card-body">
                                <button class="btn btn-sm btn-primary w-100 mb-3" data-bs-toggle="modal"
                                    data-bs-target="#modalRecurrente">
                                    <i class="bi bi-plus-circle"></i> Agregar Gasto Recurrente
                                </button>
                                <div id="listaRecurrentes" class="small">
                                    <!-- Lista din√°mica de gastos recurrentes -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Calculadora de Reparto -->
                    <div class="card mb-3 shadow-sm border-0 bg-primary-soft">
                        <div class="card-header border-0 pb-0 d-flex justify-content-between align-items-center"
                            style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#collapseReparto">
                            <span class="small fw-bold text-primary text-uppercase letter-spacing-1">üìä Reparto
                                (%)</span>
                            <i class="bi bi-chevron-down text-primary"></i>
                        </div>
                        <div id="collapseReparto" class="collapse">
                            <div class="card-body pt-2">
                                <div class="row g-2 align-items-end mb-3">
                                    <div class="col-8">
                                        <label class="form-label small mb-1 opacity-75">Monto Total ($)</label>
                                        <input type="number" id="montoReparto" class="form-control form-control-sm"
                                            placeholder="0.00" oninput="calcularReparto()">
                                    </div>
                                    <div class="col-4">
                                        <button class="btn btn-sm btn-primary w-100" onclick="agregarFilaPorcentaje()">+
                                            Fila</button>
                                    </div>
                                </div>
                                <div id="filasPorcentajes" class="small">
                                    <div class="row g-2 mb-2 align-items-center">
                                        <div class="col-5">
                                            <input type="text" class="form-control form-control-sm label-porcentaje"
                                                value="Ahorro">
                                        </div>
                                        <div class="col-3">
                                            <div class="input-group input-group-sm">
                                                <input type="number" class="form-control valor-porcentaje" value="20"
                                                    oninput="calcularReparto()">
                                                <span class="input-group-text">%</span>
                                            </div>
                                        </div>
                                        <div class="col-4 text-end fw-bold text-primary">
                                            <span class="resultado-porcentaje">$0.00</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-3 p-2 bg-white rounded-3 border d-flex justify-content-between small">
                                    <span>Restante: <strong id="repartoRestante">100%</strong></span>
                                    <strong id="montoRestante" class="text-primary">$0.00</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- GASTOS TAB -->
                <div class="tab-pane fade" id="sub-gastos" role="tabpanel">
                    <!-- Registro de Movimientos -->
                    <div class="card mb-3 shadow-sm">
                        <div class="card-header py-2 d-flex justify-content-between align-items-center"
                            style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#collapseRegistro">
                            <span class="small fw-bold text-uppercase">‚ûï Registrar Movimiento</span>
                            <i class="bi bi-plus-circle-fill text-primary"></i>
                        </div>
                        <div id="collapseRegistro" class="collapse show"> <!-- Default open in tab -->
                            <div class="card-body">
                                <form id="formFinanzas" class="row g-2 small">
                                    <div class="col-6">
                                        <select class="form-select form-select-sm" id="finTipo"
                                            onchange="toggleCompartirDeuda()">
                                            <option value="ingreso">Ingreso (+)</option>
                                            <option value="egreso">Egreso (-)</option>
                                        </select>
                                    </div>
                                    <div class="col-6">
                                        <input type="text" class="form-control form-control-sm" id="finCategoria"
                                            placeholder="Categor√≠a..." list="catList">
                                    </div>
                                    <div class="col-6">
                                        <input type="text" class="form-control form-control-sm" id="finConcepto"
                                            placeholder="Concepto..." required>
                                    </div>
                                    <div class="col-6">
                                        <input type="number" step="0.01" class="form-control form-control-sm"
                                            id="finMonto" placeholder="Monto ($)" required>
                                    </div>
                                    <div class="col-12">
                                        <input type="date" class="form-control form-control-sm" id="finFecha" required>
                                    </div>
                                    <div class="col-12" id="divCompartirDeuda" style="display: none;">
                                        <select class="form-select form-select-sm border-primary" id="finCompartirCon">
                                            <option value="">No compartir</option>
                                        </select>
                                    </div>
                                    <div class="col-12">
                                        <button type="submit" class="btn btn-primary btn-sm w-100">Guardar</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Gastos Variables Semanales -->
                    <div class="card mb-3 shadow-sm">
                        <div class="card-header py-2 d-flex justify-content-between align-items-center"
                            style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#collapseVariables">
                            <span class="small fw-bold text-uppercase">üìä Gastos Variables (Semanales)</span>
                            <i class="bi bi-cash-stack text-primary"></i>
                        </div>
                        <div id="collapseVariables" class="collapse">
                            <div class="card-body">
                                <div class="mb-3">
                                    <select class="form-select form-select-sm mb-2" id="categoriaVariable">
                                        <option value="Transporte">üöó Transporte</option>
                                        <option value="Comida">üçî Comida</option>
                                        <option value="Servicios">üîß Servicios</option>
                                        <option value="Otros">üì¶ Otros</option>
                                    </select>
                                    <div class="input-group input-group-sm">
                                        <input type="text" class="form-control" id="conceptoVariable"
                                            placeholder="Ej: Carrera de moto">
                                        <input type="number" step="0.01" class="form-control" id="montoVariable"
                                            placeholder="$">
                                        <button class="btn btn-primary" onclick="agregarGastoVariable()"><i
                                                class="bi bi-plus-lg"></i></button>
                                    </div>
                                </div>
                                <div id="resumenSemanal" class="alert bg-primary-soft border-0 mb-2">
                                    <div class="d-flex justify-content-between">
                                        <span class="small">Total de la semana:</span>
                                        <strong id="totalSemanalUSD" class="text-primary">$0.00</strong>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span class="small">En Bs:</span>
                                        <strong id="totalSemanalBS" class="text-muted">Bs 0.00</strong>
                                    </div>
                                </div>
                                <div id="listaVariables" class="mb-2">
                                    <!-- Lista de gastos de la semana -->
                                </div>
                                <button class="btn btn-sm btn-success w-100" onclick="pagarSemana()"
                                    id="btnPagarSemana">
                                    <i class="bi bi-check-circle"></i> Marcar como Pagado y Resetear
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Asistente Cashea -->
                    <div class="card mb-3 shadow-sm border-0">
                        <div class="card-header py-2 d-flex justify-content-between align-items-center"
                            style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#collapseCashea">
                            <span class="small fw-bold text-uppercase text-muted">üîµ Asistente Cashea</span>
                            <i class="bi bi-lightning-charge-fill text-primary"></i>
                        </div>
                        <div id="collapseCashea" class="collapse">
                            <div class="card-body">
                                <div class="row g-2 small">
                                    <div class="col-12">
                                        <input type="number" class="form-control form-control-sm" id="casheaMontoTotal"
                                            placeholder="Monto de la Compra ($)">
                                    </div>
                                    <div class="col-6">
                                        <select class="form-select form-select-sm" id="casheaLinea"
                                            onchange="actualizarCuotasCashea()">
                                            <option value="cotidiana">Cotidiana</option>
                                            <option value="principal" selected>Principal</option>
                                        </select>
                                    </div>
                                    <div class="col-6" id="contenedorCuotasPrincipal">
                                        <select class="form-select form-select-sm" id="casheaCuotas">
                                            <option value="3">3 Cuotas</option>
                                            <option value="6">6 Cuotas</option>
                                            <option value="9">9 Cuotas</option>
                                        </select>
                                    </div>
                                    <div id="resultadoCashea" class="col-12 d-none">
                                        <div class="p-2 bg-primary-soft rounded-3 mt-2">
                                            <div class="d-flex justify-content-between"><span>Inicial (40%):</span>
                                                <strong id="casheaInicial">$0.00</strong>
                                            </div>
                                            <div class="d-flex justify-content-between"><span>Por Cuota:</span> <strong
                                                    id="casheaMontoCuota">$0.00</strong></div>
                                            <button class="btn btn-sm btn-primary w-100 mt-2 py-1"
                                                onclick="registrarCashea()" style="font-size: 0.75rem">Registrar
                                                Cuotas</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AHORROS TAB -->
                <div class="tab-pane fade" id="sub-ahorros" role="tabpanel">
                    <!-- Ahorros -->
                    <div class="card mb-3 shadow-sm">
                        <div class="card-header py-2 d-flex justify-content-between align-items-center"
                            style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#collapseAhorros">
                            <span class="small fw-bold text-uppercase">üí∞ Ahorros</span>
                            <i class="bi bi-piggy-bank text-primary"></i>
                        </div>
                        <div id="collapseAhorros" class="collapse show">
                            <div class="card-body">
                                <div class="alert bg-success bg-opacity-10 border-0 mb-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <div class="small text-muted">Total en USD</div>
                                            <h5 class="mb-0 text-success" id="totalAhorrosUSD">$0.00</h5>
                                        </div>
                                        <div class="text-end">
                                            <div class="small text-muted">Total en Bs</div>
                                            <h5 class="mb-0 text-success" id="totalAhorrosBS">Bs 0.00</h5>
                                        </div>
                                    </div>
                                </div>
                                <div class="d-flex gap-2 mb-3">
                                    <button class="btn btn-sm btn-success flex-fill" data-bs-toggle="modal"
                                        data-bs-target="#modalAhorros" onclick="prepararAhorroModal('deposito')">
                                        <i class="bi bi-plus-circle"></i> Agregar Fondos
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger flex-fill" data-bs-toggle="modal"
                                        data-bs-target="#modalAhorros" onclick="prepararAhorroModal('retiro')">
                                        <i class="bi bi-dash-circle"></i> Retirar Fondos
                                    </button>
                                </div>
                                <div id="historialAhorros" class="small">
                                    <!-- Historial de transacciones -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Savings Goals Section -->
                    <div class="card mb-3 shadow-sm border-0">
                        <div class="card-header py-2 d-flex justify-content-between align-items-center bg-white">
                            <span class="small fw-bold text-uppercase text-primary"><i
                                    class="bi bi-piggy-bank-fill"></i>
                                Metas
                                de Ahorro</span>
                            <button class="btn btn-sm btn-outline-primary py-0" onclick="promptNuevaMeta()">+
                                Meta</button>
                        </div>
                        <div class="card-body p-2" id="savingsGoalsContainer">
                            <p class="text-muted text-center small my-2">Sin metas de ahorro activas.</p>
                        </div>
                    </div>
                </div>

                <!-- PRESUPUESTOS TAB -->
                <div class="tab-pane fade" id="sub-presupuestos" role="tabpanel">
                    <div class="alert alert-info text-center border-0 bg-primary-soft m-3">
                        <i class="bi bi-info-circle-fill text-primary mb-2 display-6"></i> <br>
                        <strong>Gesti√≥n de Presupuestos (v5)</strong><br>
                        <small>Pr√≥ximamente podr√°s asignar presupuestos a categor√≠as espec√≠ficas.</small>
                    </div>
                </div>

            </div> <!-- End Tab Content -->

        </div> <!-- FIN GESTION -->

        <!-- PRODUCTOS TAB -->
        <div class="tab-pane fade" id="productos" role="tabpanel">
            <div class="d-flex justify-content-center mb-3">
                <div class="btn-group btn-group-sm shadow-sm p-1 bg-white rounded-pill" role="group">
                    <input type="radio" class="btn-check" name="prodView" id="viewCatalog" checked
                        onclick="switchProductView('catalog')">
                    <label class="btn btn-outline-primary rounded-pill px-3" for="viewCatalog">üìñ Cat√°logo</label>
                    <input type="radio" class="btn-check" name="prodView" id="viewInventory"
                        onclick="switchProductView('inventory')">
                    <label class="btn btn-outline-primary rounded-pill px-3" for="viewInventory">ü•ò Mi Cocina</label>
                </div>
            </div>

            <div id="catalogView">
                <div class="input-group mb-3 shadow-sm rounded-pill overflow-hidden">
                    <span class="input-group-text bg-white border-0 ps-3"><i class="bi bi-search text-muted"></i></span>
                    <input type="text" id="buscadorCatalogo" class="form-control border-0 py-2"
                        placeholder="Buscar en el cat√°logo..." oninput="renderizarCatalogo()">
                    <button class="btn btn-primary px-3" onclick="abrirModalProducto()"> Nuevo <i
                            class="bi bi-plus-lg"></i></button>
                </div>

                <div class="row">
                    <div class="col-lg-8 col-md-7">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0 small fw-bold text-uppercase text-muted">Cat√°logo General</h6>
                            <span class="badge bg-soft-primary text-primary" id="catalogCount">0 productos</span>
                        </div>
                        <div id="gridProductos" class="products-grid"></div>
                    </div>

                    <div class="col-lg-4 col-md-5">
                        <div class="card shadow-sm border-0 rounded-4">
                            <div class="card-header bg-white py-2 border-0">
                                <span class="small fw-bold text-uppercase text-muted"><i class="bi bi-cart-check"></i>
                                    Lista de Compra</span>
                            </div>
                            <div class="card-body p-2" style="max-height: 450px; overflow-y: auto;">
                                <div id="shoppingListItems">
                                    <p class="text-muted text-center small my-4">Tu lista est√° vac√≠a</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="inventoryView" style="display: none;">
                <div class="card shadow-sm border-0 rounded-4 mb-3">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0 fw-bold">Mi Inventario (Stock Recurrente)</h6>
                            <button class="btn btn-sm btn-outline-primary"
                                onclick="inventoryManager.loadData().then(() => renderInventory())">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                        <div class="row g-2" id="inventoryGrid">
                            <!-- Items de inventario -->
                        </div>
                    </div>
                </div>
            </div>
        </div> <!-- FIN PRODUCTOS -->

        <div class="tab-pane fade" id="perfil" role="tabpanel">
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header py-2 bg-white">
                    <span class="small fw-bold text-uppercase text-muted"><i class="bi bi-shield-lock"></i>
                        Seguridad y
                        Privacidad</span>
                </div>
                <div class="card-body p-3">
                    <div id="seccionAdmin" class="d-none mb-3 p-3 bg-light rounded-4 border-0">
                        <h6 class="small fw-bold mb-3 text-primary text-uppercase">Gesti√≥n de Usuarios</h6>
                        <div class="table-responsive mb-3">
                            <table class="table table-sm table-borderless small align-middle mb-0">
                                <tbody id="tablaUsuariosAdmin"></tbody>
                            </table>
                        </div>
                        <button class="btn btn-sm btn-outline-primary w-100 py-1" style="font-size: 0.75rem"
                            data-bs-toggle="collapse" data-bs-target="#collapseAddUser">
                            + Registrar Nuevo Usuario
                        </button>
                        <div id="collapseAddUser" class="collapse mt-3">
                            <form id="formNuevoUsuario" class="row g-1">
                                <div class="col-6"><input type="text" id="regNombre"
                                        class="form-control form-control-sm" placeholder="Nombre"></div>
                                <div class="col-6"><input type="email" id="regEmail"
                                        class="form-control form-control-sm" placeholder="Email"></div>
                                <div class="col-6"><input type="password" id="regPass"
                                        class="form-control form-control-sm" placeholder="Pass"></div>
                                <div class="col-6"><button type="submit"
                                        class="btn btn-primary btn-sm w-100">Crear</button></div>
                            </form>
                        </div>
                    </div>

                    <h6 class="small fw-bold mb-2 text-muted text-uppercase" style="font-size: 0.7rem">Compartir acceso
                    </h6>
                    <div class="input-group input-group-sm mb-3">
                        <input type="email" id="shareEmailInput" class="form-control" placeholder="Email del usuario">
                        <button class="btn btn-outline-primary" type="button"
                            onclick="concederAccesoEmail()">Compartir</button>
                    </div>
                    <h6 class="small fw-bold mb-2 text-muted text-uppercase" style="font-size: 0.7rem">Usuarios con
                        acceso:</h6>
                    <div id="listaUsuariosCompartir" class="list-group list-group-flush small mb-4">
                        <div class="text-center p-3 opacity-50">Cargando...</div>
                    </div>

                    <button class="btn btn-outline-danger btn-sm w-100 py-2 rounded-3" onclick="cerrarSesion()">
                        <i class="bi bi-box-arrow-right me-1"></i> Cerrar Sesi√≥n
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scanner Modal -->
    <div class="modal fade" id="modalScanner" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 overflow-hidden" style="border-radius: 20px;">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold text-primary">Escaneando...</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                        onclick="detenerEscanner()"></button>
                </div>
                <div class="modal-body p-0">
                    <div id="reader" style="width: 100%; min-height: 300px;"></div>
                </div>
                <div class="modal-footer border-0 pt-0 justify-content-center">
                    <small class="text-muted">Apunta al c√≥digo de barras del producto</small>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalNuevo" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nuevo Producto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formProducto">
                        <div class="mb-2">
                            <label>Producto</label>
                            <input type="text" class="form-control" required>
                        </div>
                        <div class="row mb-2">
                            <div class="col">
                                <label>Precio ($)</label>
                                <input type="number" step="0.01" class="form-control" required>
                            </div>
                            <div class="col">
                                <label>Cantidad</label>
                                <input type="number" class="form-control" value="1" required>
                            </div>
                        </div>
                        <div class="mb-2">
                            <label>Mercado</label>
                            <input type="text" class="form-control" list="mercadosList">
                        </div>
                        <div class="mb-2">
                            <label>C√≥digo de Barras (Opcional)</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="prodBarcode"
                                    placeholder="Escanear o ingresar...">
                                <button class="btn btn-outline-primary" type="button" onclick="abrirEscanner('form')">
                                    <i class="bi bi-upc-scan"></i>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary w-100">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Gasto Recurrente -->
    <div class="modal fade" id="modalRecurrente" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Agregar Gasto Recurrente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formRecurrente">
                        <div class="mb-2">
                            <label class="form-label small">Nombre del Gasto</label>
                            <input type="text" class="form-control form-control-sm" id="recNombre"
                                placeholder="Ej: Renta de Internet" required>
                        </div>
                        <div class="mb-2">
                            <label class="form-label small">Monto (USD)</label>
                            <input type="number" step="0.01" class="form-control form-control-sm" id="recMonto"
                                placeholder="0.00" required oninput="actualizarConversionRecurrente()">
                            <small class="text-muted">‚âà Bs <span id="recConversionBS">0.00</span></small>
                        </div>
                        <div class="mb-2">
                            <label class="form-label small">Frecuencia</label>
                            <select class="form-select form-select-sm" id="recFrecuencia" required
                                onchange="actualizarDiaVencimiento()">
                                <option value="monthly">Mensual</option>
                                <option value="weekly">Semanal</option>
                            </select>
                        </div>
                        <div class="mb-2" id="divDiaVencimiento">
                            <label class="form-label small">D√≠a de Vencimiento</label>
                            <input type="number" class="form-control form-control-sm" id="recDia" min="1" max="31"
                                placeholder="D√≠a del mes" required>
                            <small class="text-muted" id="helperDia">D√≠a del mes (1-31)</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-sm btn-primary"
                        onclick="guardarGastoRecurrente()">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Ahorros -->
    <div class="modal fade" id="modalAhorros" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="tituloModalAhorros">Transacci√≥n de Ahorros</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formAhorros">
                        <input type="hidden" id="ahorroTipo" value="deposito">
                        <div class="mb-2">
                            <label class="form-label small">Moneda</label>
                            <select class="form-select form-select-sm" id="ahorroMoneda"
                                onchange="actualizarConversionAhorro()">
                                <option value="USD">USD üíµ</option>
                                <option value="BS">Bs üí∞</option>
                            </select>
                        </div>
                        <div class="mb-2">
                            <label class="form-label small">Monto</label>
                            <input type="number" step="0.01" class="form-control form-control-sm" id="ahorroMonto"
                                placeholder="0.00" required oninput="actualizarConversionAhorro()">
                            <small class="text-muted" id="ahorroConversion"></small>
                        </div>
                        <div class="mb-2">
                            <label class="form-label small">Nota (Opcional)</label>
                            <input type="text" class="form-control form-control-sm" id="ahorroNota"
                                placeholder="Ej: Ahorro mensual">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-sm btn-success" id="btnGuardarAhorro"
                        onclick="guardarAhorro()">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx1J1hxN5wb6evXxenQTcfvZZ0htOz1z2_s4fnrk-L0nck84iCBXdMw5OCCMACTj0ec/exec";
        let currentUser = null;
        let tasaBCV = 0;
        let html5QrCode = null;

        // --- FUNCIONES DE ESCANEO ---
        async function abrirEscanner(contexto) {
            const modal = new bootstrap.Modal(document.getElementById('modalScanner'));
            modal.show();

            html5QrCode = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 250, height: 150 } };

            try {
                await html5QrCode.start(
                    { facingMode: "environment" },
                    config,
                    async (decodedText) => {
                        console.log("Barcode detected:", decodedText);
                        detenerEscanner();
                        bootstrap.Modal.getInstance(document.getElementById('modalScanner')).hide();

                        if (contexto === 'search') {
                            document.getElementById('buscador').value = decodedText;
                            document.getElementById('buscador').dispatchEvent(new Event('input'));
                        } else if (contexto === 'form') {
                            document.getElementById('prodBarcode').value = decodedText;
                        }
                    }
                );
            } catch (err) {
                console.error("Error starting scanner:", err);
                alert("No se pudo iniciar el esc√°ner. Aseg√∫rate de dar permisos de c√°mara.");
                bootstrap.Modal.getInstance(document.getElementById('modalScanner')).hide();
            }
        }

        async function detenerEscanner() {
            if (html5QrCode) {
                try {
                    await html5QrCode.stop();
                    await html5QrCode.clear();
                    html5QrCode = null;
                } catch (err) {
                    console.warn("Error stopping scanner:", err);
                }
            }
        }

        // --- FUNCI√ìN PARA ENVIAR DATOS AL BACKEND ---
        async function llamarBackend(accion, payload = {}) {
            const url = SCRIPT_URL;
            const data = { action: accion, ...payload };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(data)
                });
                if (!response.ok) throw new Error("Error en la red");
                return await response.json();
            } catch (err) {
                console.warn("Error backend:", err);
                if (!navigator.onLine) {
                    alert("‚ö†Ô∏è Est√°s offline. Algunas funciones requieren internet.");
                }
                throw err;
            }
        }

        // --- L√ìGICA DE LOGIN ---
        document.getElementById('formLogin').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPass').value;

            try {
                const data = await llamarBackend('login', { email, password: pass });
                if (data.success) {
                    if (data.user.status === 'Pending') {
                        alert("‚è≥ Tu cuenta a√∫n no ha sido aprobada por un administrador.");
                        return;
                    }
                    if (data.user.status === 'Disabled') {
                        alert("üö´ Tu cuenta ha sido desactivada.");
                        return;
                    }
                    currentUser = data.user;

                    // --- PERSISTENCIA DE SESI√ìN ---
                    localStorage.setItem('plannerUser', JSON.stringify({
                        user: currentUser,
                        timestamp: new Date().getTime()
                    }));

                    document.getElementById('loginWall').classList.add('d-none'); // Quita el muro
                    cargarDatosIniciales();
                } else {
                    alert("Error: " + data.message);
                }
            } catch (err) {
                console.error(err);
                alert("Error de conexi√≥n con el servidor.");
            }
        });

        function toggleAuth(isRegister) {
            document.getElementById('formLogin').style.display = isRegister ? 'none' : 'block';
            document.getElementById('formRegistro').style.display = isRegister ? 'block' : 'none';
            document.querySelector('#loginWall h3').innerText = isRegister ? 'Reg√≠strate' : 'MarketPlanner OS';
        }

        document.getElementById('formRegistro').addEventListener('submit', async (e) => {
            e.preventDefault();
            const nombre = document.getElementById('regNombreSelf').value;
            const email = document.getElementById('regEmailSelf').value;
            const pass = document.getElementById('regPassSelf').value;

            try {
                // El backend crearUsuario deber√≠a verificar si ya existe
                const res = await llamarBackend('crearUsuario', {
                    payload: { nombre, email, pass, rol: 'Usuario', status: 'Pending' }
                });

                if (res.success) {
                    alert("‚úÖ Registro solicitado con √©xito. Espera a que un administrador apruebe tu acceso.");
                    toggleAuth(false);
                    e.target.reset();
                } else {
                    alert("‚ùå Error: " + res.message);
                }
            } catch (err) {
                alert("Error al intentar registrar.");
            }
        });

        // --- SISTEMA DE NOTIFICACIONES ---
        async function verificarNotificaciones(finanzas) {
            if (!("Notification" in window)) return;

            if (Notification.permission === "default") {
                await Notification.requestPermission();
            }

            if (Notification.permission === "granted") {
                const hoy = new Date();

                // 1. Buscar deudas que venzan en los pr√≥ximos 3 d√≠as
                const deudasProntas = finanzas.filter(f => {
                    const fecha = new Date(f[3]);
                    const difDias = Math.ceil((fecha - hoy) / (1000 * 60 * 60 * 24));
                    return f[0].toLowerCase() === 'egreso' && difDias >= 0 && difDias <= 3;
                });

                if (deudasProntas.length > 0) {
                    const nombresDeudas = deudasProntas.map(f => f[1]).join(", ");
                    new Notification("MarketPlanner: Pagos Pr√≥ximos", {
                        body: `Vencen pronto: ${nombresDeudas}. Revisa tu flujo de caja.`,
                        icon: 'app_icon_marketplanner_1766378047051.png'
                    });
                }

                // 2. Verificar gastos recurrentes pr√≥ximos
                const stored = localStorage.getItem('gastosRecurrentes_' + currentUser.id);
                if (stored) {
                    const gastosRec = JSON.parse(stored);
                    const recurrentesProntos = gastosRec.filter(g => {
                        const fechaVence = new Date(g.proximoPago);
                        const difDias = Math.ceil((fechaVence - hoy) / (1000 * 60 * 60 * 24));
                        return difDias >= 0 && difDias <= 3;
                    });

                    if (recurrentesProntos.length > 0) {
                        const nombresRec = recurrentesProntos.map(g => `${g.nombre} ($${g.monto.toFixed(2)})`).join(", ");
                        new Notification("MarketPlanner: Gastos Recurrentes", {
                            body: `Pr√≥ximos a vencer: ${nombresRec}`,
                            icon: 'app_icon_marketplanner_1766378047051.png',
                            tag: 'recurring-expenses'
                        });
                    }
                }
            }
        }

        // --- CARGAR DATOS (PRODUCTOS Y FINANZAS) ---
        async function cargarDatosIniciales() {
            try {
                const data = await llamarBackend('getInitialData', { userId: currentUser.id });
                if (!data.success) throw new Error(data.message);

                tasaBCV = data.tasa;
                document.getElementById('displayTasa').innerText = tasaBCV.toFixed(2);
                document.getElementById('welcomeName').innerText = currentUser.nombre;

                // Initialize Budget
                cargarPresupuesto();

                // Split rendering
                renderizarLista(data.products);
                renderizarCatalogo(data.products);
                renderizarFinanzas(data.finanzas);

                // Init Managers v5
                inventoryManager = new InventoryManager(currentUser.id);
                savingsManager = new SavingsManager(currentUser, {
                    syncTransaction: async (goalId, tx, ver) => {
                        return await llamarBackend('saveSavings', { payload: { ...tx, goalId, ownerId: currentUser.id } });
                    }
                });

                // Cargar nuevas funcionalidades
                cargarGastosRecurrentes();
                cargarGastosVariables();
                cargarDashboard();
                inventoryManager.loadData();

                verificarNotificaciones(data.finanzas);
                cargarListaCompartir();
                populateSharedWith();

                // Mostrar secci√≥n admin si aplica
                if (currentUser.rol === 'Admin') {
                    document.getElementById('seccionAdmin').classList.remove('d-none');
                    cargarUsuariosAdmin();
                }
            } catch (err) {
                console.error("Error al cargar datos:", err);
            }
        }

        async function cargarUsuariosAdmin() {
            const res = await llamarBackend('getAllUsers'); // Usamos el mismo endpoint pero adaptamos vista
            const tabla = document.getElementById('tablaUsuariosAdmin');
            if (!tabla) return;
            tabla.innerHTML = "";

            if (res.usuarios) {
                res.usuarios.forEach(u => {
                    const isPending = u.status === 'Pending';
                    const isDisabled = u.status === 'Disabled';

                    tabla.innerHTML += `
                                <tr>
                                    <td>${u.nombre}<br><small class="text-muted">${u.email}</small></td>
                                    <td>
                                        <span class="badge ${isPending ? 'bg-warning text-dark' : (isDisabled ? 'bg-danger' : 'bg-success')}">
                                            ${u.status || 'Active'}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="d-flex gap-1">
                                            ${isPending ?
                            `<button class="btn btn-sm btn-success p-1" onclick="cambiarStatus(${u.id}, 'Active')"><i class="bi bi-check-lg"></i></button>` :
                            `<button class="btn btn-sm btn-outline-danger p-1" onclick="cambiarStatus(${u.id}, 'Disabled')"><i class="bi bi-slash-circle"></i></button>`
                        }
                                            <button class="btn btn-sm btn-danger p-1" onclick="eliminarUsuario(${u.id})"><i class="bi bi-trash"></i></button>
                                        </div>
                                    </td>
                                </tr>
                            `;
                });
            }
        }

        async function cambiarStatus(targetId, status) {
            if (!confirm(`¬øCambiar estado a ${status}?`)) return;
            const res = await llamarBackend('updateUserStatus', { targetUserId: targetId, status, adminId: currentUser.id });
            if (res.success) {
                alert("Estado actualizado");
                cargarUsuariosAdmin();
            }
        }

        async function eliminarUsuario(targetId) {
            if (!confirm("‚ö†Ô∏è ¬øSeguro que deseas eliminar este usuario?")) return;
            const res = await llamarBackend('deleteUser', { targetUserId: targetId, adminId: currentUser.id });
            if (res.success) {
                alert("Usuario eliminado");
                cargarUsuariosAdmin();
            }
        }

        // --- PRECIO & PRESUPUESTO ---
        let budgetLimit = 0;

        function cargarPresupuesto() {
            const saved = localStorage.getItem('budgetLimit');
            if (saved) {
                budgetLimit = parseFloat(saved);
                document.getElementById('displayPresupuesto').innerText = `$${budgetLimit.toFixed(2)}`;
            }
        }

        function editarPresupuesto() {
            const newLimit = prompt("Ingresa el l√≠mite de tu presupuesto ($):", budgetLimit);
            if (newLimit !== null && !isNaN(newLimit)) {
                budgetLimit = parseFloat(newLimit);
                localStorage.setItem('budgetLimit', budgetLimit);
                document.getElementById('displayPresupuesto').innerText = `$${budgetLimit.toFixed(2)}`;
                renderizarLista(productosCache); // Re-calc UI
            }
        }

        function updateBudgetUI(currentTotal) {
            const bar = document.getElementById('budgetProgress');
            const status = document.getElementById('budgetStatus');
            const remaining = document.getElementById('budgetRemaining');

            if (budgetLimit <= 0) {
                bar.style.width = '0%';
                status.innerText = "Sin l√≠mite definido";
                remaining.innerText = "";
                return;
            }

            const percentage = Math.min((currentTotal / budgetLimit) * 100, 100);
            bar.style.width = `${percentage}%`;

            const diff = budgetLimit - currentTotal;
            remaining.innerText = diff >= 0 ? `Restante: $${diff.toFixed(2)}` : `Excedido: $${Math.abs(diff).toFixed(2)}`;

            bar.classList.remove('bg-success', 'bg-warning', 'bg-danger');
            if (percentage < 80) {
                bar.classList.add('bg-success');
                status.innerText = "Dentro del presupuesto";
                status.className = "text-success fw-bold";
            } else if (percentage < 100) {
                bar.classList.add('bg-warning');
                status.innerText = "¬°Cerca del l√≠mite!";
                status.className = "text-warning fw-bold";
            } else {
                bar.classList.add('bg-danger');
                status.innerText = "¬°Presupuesto Excedido!";
                status.className = "text-danger fw-bold";
            }
        }

        // --- RENDERIZADO DE PRODUCTOS (LISTA DE COMPRA) ---
        let productosCache = [];

        function renderizarLista(productos) {
            productosCache = productos; // Update global cache
            const contenedor = document.getElementById('contenedorProductos');
            const termino = document.getElementById('buscador').value.toLowerCase();

            contenedor.innerHTML = "";
            let totalUSD = 0;

            // Filter logic: In List Mode, we likely want ALL products that are currently "active" or just all for now?
            // User request implies "Shopping List" concept. 
            // For now, we will treat ALL products as "in the list" because the app currently has no "archive" status.
            // Future refactor: Add 'status' field to products.

            // Temporary: Show ALL products in List Tab (Legacy Behavior) but with new UI
            // But we want to separate "Catalog" from "List".
            // Since we don't have a backend change for "inList" boolean yet, we will assume everything is in list.
            // PROPOSAL: Filter by "cantidad > 0" if we had a catalog inventory system.
            // BASE: Just render all for now, as user manages them directly.

            productos.forEach(p => {
                const coincide = p[1].toLowerCase().includes(termino) || p[4].toLowerCase().includes(termino);
                if (!coincide) return;

                const subtotal = p[2] * p[3];
                totalUSD += subtotal;

                contenedor.innerHTML += `
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center gap-3">
                            <div class="bg-light rounded p-2 text-primary">
                                <i class="bi bi-basket2-fill h4 m-0"></i>
                            </div>
                            <div>
                                <div class="fw-bold text-main">${p[1]}</div>
                                <div class="small text-muted">
                                    <span class="badge bg-light text-dark border">${p[4]}</span> ‚Ä¢ ${p[2]} un. x $${p[3]}
                                </div>
                            </div>
                        </div>
                        <div class="text-end">
                            <span class="fw-bold text-primary display-6" style="font-size: 1.1rem;">$${subtotal.toFixed(2)}</span>
                            <div class="small text-muted">Bs ${(subtotal * tasaBCV).toFixed(2)}</div>
                        </div>
                        <div class="ms-2 ps-2 border-start">
                             <button class="btn btn-icon btn-link text-muted p-1" onclick="prepararEdicion(${p[0]})"><i class="bi bi-pencil-square"></i></button>
                             <button class="btn btn-icon btn-link text-danger p-1" onclick="eliminarProducto(${p[0]})"><i class="bi bi-trash"></i></button>
                        </div>
                    </div>
                `;
            });

            document.getElementById('totalGeneralUSD').innerText = `$${totalUSD.toFixed(2)}`;
            document.getElementById('totalGeneralBS').innerText = `Bs ${(totalUSD * tasaBCV).toFixed(2)}`;

            updateBudgetUI(totalUSD);
        }

        // --- RENDERIZADO DE CAT√ÅLOGO (HIST√ìRICO) ---
        function renderizarCatalogo(productos = productosCache) {
            const contenedor = document.getElementById('gridProductos');
            const termino = document.getElementById('buscadorCatalogo') ? document.getElementById('buscadorCatalogo').value.toLowerCase() : '';

            if (!contenedor) return;
            contenedor.innerHTML = "";

            productos.forEach(p => {
                if (termino && !p[1].toLowerCase().includes(termino)) return;

                contenedor.innerHTML += `
                   <div class="product-card p-3">
                       <div class="product-image-placeholder mb-2">
                           <i class="bi bi-box-seam"></i>
                       </div>
                       <div class="product-name text-truncate">${p[1]}</div>
                       <div class="product-market text-truncate"><i class="bi bi-shop"></i> ${p[4]}</div>
                       <div class="product-price"><strong>$${p[3].toFixed(2)}</strong></div>
                       <button class="btn btn-sm btn-outline-primary w-100" onclick="prepararEdicion(${p[0]})">Editar / Agregar</button>
                   </div>
               `;
            });
        }

        // Evento de b√∫squeda con sugerencias
        const buscador = document.getElementById('buscador');
        const sugerenciasContenedor = document.getElementById('sugerenciasBusqueda');

        buscador.addEventListener('input', async () => {
            const termino = buscador.value.toLowerCase().trim();

            if (termino.length < 2) {
                sugerenciasContenedor.style.display = 'none';
                renderizarLista(productosCache);
                return;
            }

            // Filtrar productos que coincidan para las sugerencias (incluye barcode)
            const coincidencias = productosCache.filter(p =>
                p[1].toLowerCase().includes(termino) ||
                p[4].toLowerCase().includes(termino) ||
                (p[6] && p[6].toString().includes(termino))
            ).sort((a, b) => a[3] - b[3]);

            if (coincidencias.length > 0) {
                sugerenciasContenedor.innerHTML = coincidencias.map(p => `
                    <div class="suggestion-item d-flex justify-content-between align-items-center" onclick="seleccionarSugerencia('${p[1]}')">
                        <div>
                            <div class="fw-bold">${p[1]}</div>
                            <small class="text-muted"><i class="bi bi-shop"></i> ${p[4]}</small>
                        </div>
                        <div class="text-end">
                            <span class="suggestion-price">$${p[3].toFixed(2)}</span><br>
                            <small class="text-muted" style="font-size: 0.75rem;">Bs ${(p[3] * tasaBCV).toFixed(2)}</small>
                        </div>
                    </div>
                `).join('');
                sugerenciasContenedor.style.display = 'block';
            } else {
                sugerenciasContenedor.style.display = 'none';
                // Si parece barcode y no hay local, buscar global
                if (/^\d{8,}$/.test(termino)) {
                    buscarBarcodeGlobal(termino);
                }
            }

            renderizarLista(productosCache);
        });

        async function buscarBarcodeGlobal(barcode) {
            try {
                // Buscamos en el historial por barcode
                const res = await llamarBackend('getPriceHistory', { barcode: barcode });
                if (res.success && res.history && res.history.length > 0) {
                    sugerenciasContenedor.innerHTML = `<div class="p-2 small fw-bold text-primary border-bottom">Encontrado en Historial:</div>` +
                        res.history.map(h => `
                        <div class="suggestion-item d-flex justify-content-between align-items-center" 
                             onclick="prepararNuevoDesdeHistorial('${h.nombre}', ${h.precio}, '${h.mercado}', '${barcode}')">
                            <div>
                                <div class="fw-bold">${h.nombre}</div>
                                <small class="text-muted"><i class="bi bi-shop"></i> ${h.mercado}</small>
                            </div>
                            <div class="text-end">
                                <span class="suggestion-price">$${h.precio.toFixed(2)}</span><br>
                                <button class="btn btn-sm btn-primary py-0 px-2 mt-1" style="font-size: 0.7rem;">+ Agregar</button>
                            </div>
                        </div>
                    `).join('');
                    sugerenciasContenedor.style.display = 'block';
                }
            } catch (err) {
                console.warn("Error global search:", err);
            }
        }

        window.prepararNuevoDesdeHistorial = (nombre, precio, mercado, barcode) => {
            currentEditId = null;
            document.querySelector('#modalNuevo .modal-title').innerText = "Agregar desde Historial";

            const inputs = document.getElementById('formProducto').elements;
            inputs[0].value = nombre;
            inputs[1].value = precio;
            inputs[2].value = 1;
            inputs[3].value = mercado;
            document.getElementById('prodBarcode').value = barcode;

            sugerenciasContenedor.style.display = 'none';
            bootstrap.Modal.getOrCreateInstance(document.getElementById('modalNuevo')).show();
        };

        function seleccionarSugerencia(nombre) {
            buscador.value = nombre;
            sugerenciasContenedor.style.display = 'none';
            renderizarLista(productosCache);
        }

        // Cerrar sugerencias al hacer clic fuera
        document.addEventListener('click', (e) => {
            if (!buscador.contains(e.target) && !sugerenciasContenedor.contains(e.target)) {
                sugerenciasContenedor.style.display = 'none';
            }
        });

        // --- MANEJO DE FORMULARIO DE PRODUCTO ---
        document.getElementById('formProducto').addEventListener('submit', async (e) => {
            e.preventDefault();
            const inputs = e.target.elements;

            // Seguridad: Validaci√≥n b√°sica antes de enviar
            const nombre = inputs[0].value.trim();
            const precio = parseFloat(inputs[1].value);
            const cantidad = parseInt(inputs[2].value);
            const mercado = inputs[3].value.trim();
            const barcode = document.getElementById('prodBarcode').value.trim();

            if (!nombre || isNaN(precio) || cantidad <= 0) {
                alert("Por favor, completa los campos correctamente.");
                return;
            }

            const payload = {
                userId: currentUser.id,
                nombre,
                precio,
                cantidad,
                mercado,
                barcode
            };

            try {
                const action = currentEditId ? 'updateProduct' : 'saveProduct';
                // Si es nuevo y hay barcode, usarlo como ID
                const finalId = currentEditId || (barcode ? barcode : null);
                const payloadFinal = finalId ? { id: finalId, payload } : { payload };

                const res = await llamarBackend(action, { ...payloadFinal, userId: currentUser.id });
                if (res.success) {
                    bootstrap.Modal.getInstance(document.getElementById('modalNuevo')).hide();
                    e.target.reset();
                    currentEditId = null;
                    document.querySelector('#modalNuevo .modal-title').innerText = "Nuevo Producto";
                    cargarDatosIniciales();
                } else {
                    alert("Error servidor: " + res.message);
                }
            } catch (err) {
                console.error(err);
                alert("Error cr√≠tico al procesar producto");
            }
        });

        let currentEditId = null;

        function prepararEdicion(id) {
            const p = productosCache.find(prod => prod[0] == id);
            if (!p) return;

            currentEditId = id;
            document.querySelector('#modalNuevo .modal-title').innerText = "Editar Producto";

            const inputs = document.getElementById('formProducto').elements;
            inputs[0].value = p[1]; // nombre
            inputs[1].value = p[3]; // precio
            inputs[2].value = p[2]; // cantidad
            inputs[3].value = p[4]; // mercado
            document.getElementById('prodBarcode').value = p[6] || '';

            bootstrap.Modal.getOrCreateInstance(document.getElementById('modalNuevo')).show();
        }

        async function eliminarProducto(id) {
            if (!confirm("¬øSeguro que deseas eliminar este producto?")) return;
            try {
                const res = await llamarBackend('deleteProduct', { id, userId: currentUser.id });
                if (res.success) {
                    cargarDatosIniciales();
                } else {
                    alert("No se pudo eliminar: " + res.message);
                }
            } catch (err) {
                console.error(err);
            }
        }

        // --- COMPARATIVA DE PRECIOS ---
        document.querySelector('#formProducto input[type="text"]').addEventListener('blur', async (e) => {
            const nombre = e.target.value.trim();
            if (nombre.length < 3) return;

            try {
                const res = await llamarBackend('getPriceHistory', { nombreProducto: nombre });
                if (res.success && res.history.length > 0) {
                    mostrarComparativa(res.history);
                }
            } catch (err) {
                console.warn("Error historial:", err);
            }
        });

        function mostrarComparativa(historial) {
            // Agrupar por mercado y quedarnos con el √∫ltimo precio
            const mercados = {};
            historial.forEach(h => {
                mercados[h.mercado] = h.precio;
            });

            // Encontrar el precio m√°s bajo
            const precios = Object.values(mercados);
            const minPrecio = Math.min(...precios);

            let html = '<div class="mt-2 small border rounded p-2 bg-light"><strong><i class="bi bi-info-circle"></i> Comparativa de Mercados:</strong><br>';
            for (const [mer, pre] of Object.entries(mercados)) {
                const esMejor = pre === minPrecio;
                html += `<div class="d-flex justify-content-between ${esMejor ? 'text-success fw-bold' : ''}">
                            <span>${mer}:</span>
                            <span>$${pre.toFixed(2)} ${esMejor ? 'üöÄ' : ''}</span>
                         </div>`;
            }
            if (precios.length > 1) {
                html += `<div class="mt-1 text-muted text-center" style="font-size: 0.8em;">* Basado en tus compras anteriores</div>`;
            }
            html += '</div>';

            const existing = document.getElementById('historialContenedor');
            if (existing) existing.remove();

            const div = document.createElement('div');
            div.id = 'historialContenedor';
            div.innerHTML = html;
            document.getElementById('formProducto').appendChild(div);
        }

        // --- VINCULAR BOTONES ---
        document.querySelector('#modalNuevo .btn-primary').addEventListener('click', () => {
            document.getElementById('formProducto').requestSubmit();
        });

        // Cargar Savings Module
    </script>
    <script src="savings.js"></script>
    <script>
        // Init Savings Manager when user loads
        let savingsManager = null;

        function initSavings() {
            if (currentUser && !savingsManager) {
                savingsManager = new SavingsManager(currentUser, new MockSavingsBackend());
                renderizarMetasAhorro();
            }
        }

        // --- L√ìGICA ASISTENTE CASHEA ---
        const inputCasheaMonto = document.getElementById('casheaMontoTotal');
        const selectLinea = document.getElementById('casheaLinea');
        const selectCuotas = document.getElementById('casheaCuotas');
        const resCashea = document.getElementById('resultadoCashea');

        function actualizarCuotasCashea() {
            const linea = selectLinea.value;
            const monto = parseFloat(inputCasheaMonto.value) || 0;
            const contCuotasPrin = document.getElementById('contenedorCuotasPrincipal');

            contCuotasPrin.classList.toggle('d-none', linea === 'cotidiana');

            if (monto > 0) {
                resCashea.classList.remove('d-none');
                const inicial = monto * 0.40; // Pago inicial est√°ndar 40%
                const restante = monto - inicial;
                const nCuotas = linea === 'cotidiana' ? 1 : parseInt(selectCuotas.value);
                const montoCuota = restante / nCuotas;

                document.getElementById('casheaInicial').innerText = `$${inicial.toFixed(2)}`;
                document.getElementById('casheaMontoCuota').innerText = `$${montoCuota.toFixed(2)}`;
            } else {
                resCashea.classList.add('d-none');
            }
        }

        [inputCasheaMonto, selectLinea, selectCuotas].forEach(el => {
            el.addEventListener('input', actualizarCuotasCashea);
        });

        async function registrarCashea() {
            const monto = parseFloat(inputCasheaMonto.value);
            const linea = selectLinea.value;
            const nCuotas = linea === 'cotidiana' ? 1 : parseInt(selectCuotas.value);
            const inicial = monto * 0.40;
            const montoCuota = (monto - inicial) / nCuotas;

            if (!confirm(`¬øRegistrar pago inicial de $${inicial.toFixed(2)} y ${nCuotas} cuotas de $${montoCuota.toFixed(2)}?`)) return;

            // 1. Registrar pago inicial (hoy)
            await llamarBackend('saveFinance', {
                payload: {
                    tipo: 'egreso',
                    nombre: 'Cashea - Inicial',
                    monto: inicial,
                    fecha: new Date().toISOString(),
                    ownerId: currentUser.id,
                    sharedWith: document.getElementById('finCompartirCon').value || null
                }
            });

            // 2. Registrar cuotas futuras
            const fechaBase = new Date(); // Podr√≠a ser una fecha seleccionada en el futuro
            for (let i = 1; i <= nCuotas; i++) {
                const fechaCuota = new Date(fechaBase);
                fechaCuota.setDate(fechaBase.getDate() + (i * 14)); // Intervalos exactos de 14 d√≠as

                await llamarBackend('saveFinance', {
                    payload: {
                        tipo: 'egreso',
                        nombre: `Cashea - Cuota ${i}/${nCuotas} (${linea})`,
                        monto: montoCuota,
                        fecha: fechaCuota.toISOString(),
                        ownerId: currentUser.id,
                        sharedWith: document.getElementById('finCompartirCon').value || null
                    }
                });
            }

            showToast("Plan Cashea registrado con √©xito", "success");
            cargarDatosIniciales();
        }

        // --- CALCULADORA DE REPARTO POR PORCENTAJES ---
        function agregarFilaPorcentaje() {
            const contenedor = document.getElementById('filasPorcentajes');
            const div = document.createElement('div');
            div.className = 'row g-2 mb-2 align-items-center';
            div.innerHTML = `
                <div class="col-5">
                    <input type="text" class="form-control form-control-sm label-porcentaje" placeholder="Etiqueta">
                </div>
                <div class="col-3">
                    <div class="input-group input-group-sm">
                        <input type="number" class="form-control valor-porcentaje" value="0" oninput="calcularReparto()">
                        <span class="input-group-text">%</span>
                    </div>
                </div>
                <div class="col-4 text-end d-flex align-items-center justify-content-end">
                    <strong class="resultado-porcentaje me-2">$0.00</strong>
                    <button class="btn btn-sm btn-outline-danger border-0 py-0 px-1" onclick="this.parentElement.parentElement.remove(); calcularReparto()">&times;</button>
                </div>
            `;
            contenedor.appendChild(div);
            calcularReparto();
        }

        function calcularReparto() {
            const monto = parseFloat(document.getElementById('montoReparto').value) || 0;
            const filas = document.querySelectorAll('#filasPorcentajes .row');
            let porcetajeTotal = 0;

            filas.forEach(fila => {
                const porc = parseFloat(fila.querySelector('.valor-porcentaje').value) || 0;
                porcetajeTotal += porc;
                const subtotal = monto * (porc / 100);
                fila.querySelector('.resultado-porcentaje').innerText = `$${subtotal.toFixed(2)}`;
            });

            const restPorc = 100 - porcetajeTotal;
            const restMonto = monto * (restPorc / 100);

            const displayRestPorc = document.getElementById('repartoRestante');
            displayRestPorc.innerText = `${restPorc}%`;
            displayRestPorc.className = restPorc < 0 ? 'text-danger' : 'text-dark';

            document.getElementById('montoRestante').innerText = `$${restMonto.toFixed(2)}`;
        }

        // --- MANEJO DE FORMULARIO DE FINANZAS ---
        document.getElementById('formFinanzas').addEventListener('submit', async (e) => {
            e.preventDefault();
            const tipo = document.getElementById('finTipo').value;
            const cat = document.getElementById('finCategoria').value;
            const conc = document.getElementById('finConcepto').value;
            const monto = parseFloat(document.getElementById('finMonto').value);
            const fecha = document.getElementById('finFecha').value;

            const payload = {
                tipo,
                nombre: `${cat ? '[' + cat + '] ' : ''}${conc}`,
                monto,
                fecha: new Date(fecha).toISOString(),
                ownerId: currentUser.id,
                sharedWith: document.getElementById('finCompartirCon').value || null
            };

            try {
                const res = await llamarBackend('saveFinance', { payload });
                if (res.success) {
                    showToast("Movimiento registrado", "success");
                    e.target.reset();
                    cargarDatosIniciales();
                } else {
                    showToast("Error: " + res.message, "error");
                }
            } catch (err) {
                console.error(err);
            }
        });

        function renderizarFinanzas(finanzas) {
            const lista = document.getElementById('listaFinanzas');
            const displayDisponible = document.getElementById('dineroDisponible');
            lista.innerHTML = "";

            let totalIngresos = 0;
            let totalDeudas = 0;

            const hoy = new Date();
            hoy.setHours(0, 0, 0, 0);

            // Ordenar por fecha
            finanzas.sort((a, b) => new Date(a[3]) - new Date(b[3]));

            finanzas.forEach(f => {
                const monto = parseFloat(f[2]);
                const esIngreso = f[0].toLowerCase() === 'ingreso';
                const fechaVence = new Date(f[3]);
                const fechaFormateada = f[3] ? fechaVence.toLocaleDateString() : 'S/F';

                if (esIngreso) totalIngresos += monto;
                else totalDeudas += monto;

                // Sugerencia: Estado visual (Vencido, Pr√≥ximo, Pagado)
                let estadoBadge = "";
                if (!esIngreso) {
                    if (fechaVence < hoy) estadoBadge = '<span class="badge bg-danger ms-1">Vencido</span>';
                    else if ((fechaVence - hoy) / (1000 * 60 * 60 * 24) <= 3) estadoBadge = '<span class="badge bg-warning text-dark ms-1">Pronto</span>';

                    // Indicador de compartido
                    if (f[5] || f.shared) { // f[5] es donde solemos poner el sharedWith en arrays
                        estadoBadge += ' <span class="badge bg-info ms-1"><i class="bi bi-people-fill"></i> Compartido</span>';
                    }
                }

                lista.innerHTML += `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${f[1]}</strong> ${estadoBadge}<br>
                            <small class="text-muted"><i class="bi bi-calendar"></i> ${fechaFormateada}</small>
                        </div>
                        <div class="text-end">
                            <span class="fw-bold ${esIngreso ? 'text-success' : 'text-danger'}">
                                ${esIngreso ? '+' : '-'}$${monto.toFixed(2)}
                            </span><br>
                            <small class="text-muted" style="font-size: 0.75rem;">Bs ${(monto * tasaBCV).toFixed(2)}</small>
                        </div>
                    </li>
                `;
            });

            const disponible = totalIngresos - totalDeudas;
            displayDisponible.innerText = `$${disponible.toFixed(2)} | Bs ${(disponible * tasaBCV).toFixed(2)}`;
            displayDisponible.className = disponible >= 0 ? "text-success fw-bold" : "text-danger fw-bold";
        }

        // --- REGISTRAR NUEVO USUARIO ---
        document.getElementById('formNuevoUsuario').addEventListener('submit', async (e) => {
            e.preventDefault();
            const payload = {
                nombre: document.getElementById('regNombre').value,
                email: document.getElementById('regEmail').value,
                pass: document.getElementById('regPass').value,
                rol: 'Usuario'
            };

            const res = await llamarBackend('crearUsuario', { payload });
            if (res.success) {
                showToast("Usuario creado con √©xito", "success");
                e.target.reset();
                cargarListaCompartir(); // Refrescar lista
                populateSharedWith(); // Refrescar dropdown
            }
        });

        async function populateSharedWith() {
            try {
                const data = await llamarBackend('getAllUsers');
                const select = document.getElementById('finCompartirCon');
                if (!select) return;

                const currentVal = select.value;
                select.innerHTML = '<option value="">No compartir</option>';

                if (data.usuarios) {
                    data.usuarios.forEach(u => {
                        if (u.id == currentUser.id) return;
                        if (u.status && u.status !== 'Active' && u.status !== '') return;
                        select.innerHTML += `<option value="${u.id}">${u.nombre}</option>`;
                    });
                }
                select.value = currentVal;
            } catch (err) { console.warn(err); }
        }

        function toggleCompartirDeuda() {
            const tipo = document.getElementById('finTipo').value;
            const div = document.getElementById('divCompartirDeuda');
            div.style.display = tipo === 'egreso' ? 'block' : 'none';
            if (tipo === 'egreso') populateSharedWith();
        }

        // --- CARGAR OTROS USUARIOS PARA COMPARTIR ---
        // --- GESTI√ìN DE PERMISOS (Email) ---
        async function cargarListaCompartir() {
            try {
                const data = await llamarBackend('getAllUsers'); // Returns all users with .tieneAcceso flag
                const contenedor = document.getElementById('listaUsuariosCompartir');
                contenedor.innerHTML = "";

                if (data.usuarios) {
                    const compartidos = data.usuarios.filter(u => u.tieneAcceso && u.id != currentUser.id);

                    if (compartidos.length === 0) {
                        contenedor.innerHTML = '<div class="text-muted text-center p-2 small">No has compartido tu lista con nadie.</div>';
                        return;
                    }

                    compartidos.forEach(u => {
                        contenedor.innerHTML += `
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <span>${u.nombre} <small class="text-muted">(${u.email || 'Sin email'})</small></span>
                                <button class="btn btn-sm btn-outline-danger border-0" onclick="actualizarPermiso(${u.id}, false)">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        `;
                    });
                }
            } catch (err) {
                console.warn("Error cargando permisos:", err);
            }
        }

        async function concederAccesoEmail() {
            const email = document.getElementById('shareEmailInput').value.trim();
            if (!email) {
                showToast("Ingresa un email v√°lido", "warning");
                return;
            }

            const res = await llamarBackend('gestionarPermiso', {
                targetEmail: email,
                accionPermiso: 'conceder',
                userId: currentUser.id
            });

            if (res.success) {
                showToast(`Acceso concedido a ${email}`, 'success');
                document.getElementById('shareEmailInput').value = '';
                cargarListaCompartir();
            } else {
                showToast("Error: " + res.message, 'error');
            }
        }

        async function actualizarPermiso(idInvitado, otorgar) {
            await llamarBackend('gestionarPermiso', {
                idInvitado: idInvitado,
                accionPermiso: otorgar ? 'conceder' : 'revocar',
                userId: currentUser.id
            });
            console.log(`Permiso ${otorgar ? 'concedido' : 'revocado'} para usuario ${idInvitado}`);
            cargarListaCompartir();
        }

        // --- L√ìGICA DE INSTALACI√ìN PWA ---
        let deferredPrompt;
        const btnInstalar = document.getElementById('btnInstalar');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            btnInstalar.classList.remove('d-none');
        });

        btnInstalar.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    btnInstalar.classList.add('d-none');
                }
                deferredPrompt = null;
            }
        });

        window.addEventListener('appinstalled', () => {
            btnInstalar.classList.add('d-none');
            console.log('PWA instalada con √©xito');
        });

        // --- INICIO AUTOM√ÅTICO AL CARGAR ---
        window.addEventListener('DOMContentLoaded', () => {
            const session = JSON.parse(localStorage.getItem('plannerUser'));

            if (session && session.user) {
                currentUser = session.user;
                document.getElementById('loginWall').classList.add('d-none');
                cargarDatosIniciales();
            }
        });

        async function cerrarSesion() {
            if (await showConfirmModal("Cerrar Sesi√≥n", "¬øEst√°s seguro de que quieres cerrar sesi√≥n?", "S√≠, cerrar", "Cancelar", true)) {
                localStorage.removeItem('plannerUser');
                location.reload();
            }
        }

        // ==================== NUEVAS FUNCIONALIDADES FINANCIERAS ====================

        // Variables globales para las nuevas funcionalidades
        let gastosRecurrentes = [];
        let gastosVariables = [];
        let ahorrosData = [];
        let chartsInstances = {
            mensual: null,
            semanal: null,
            comparativa: null
        };

        // ===== GASTOS RECURRENTES =====

        function actualizarConversionRecurrente() {
            const monto = parseFloat(document.getElementById('recMonto').value) || 0;
            document.getElementById('recConversionBS').textContent = (monto * tasaBCV).toFixed(2);
        }

        function actualizarDiaVencimiento() {
            const frecuencia = document.getElementById('recFrecuencia').value;
            const input = document.getElementById('recDia');
            const helper = document.getElementById('helperDia');

            if (frecuencia === 'weekly') {
                input.max = 7;
                input.placeholder = "D√≠a de la semana";
                helper.textContent = "D√≠a de la semana (1=Lunes, 7=Domingo)";
            } else {
                input.max = 31;
                input.placeholder = "D√≠a del mes";
                helper.textContent = "D√≠a del mes (1-31)";
            }
        }

        async function guardarGastoRecurrente() {
            const nombre = document.getElementById('recNombre').value.trim();
            const monto = parseFloat(document.getElementById('recMonto').value);
            const frecuencia = document.getElementById('recFrecuencia').value;
            const dia = parseInt(document.getElementById('recDia').value);

            if (!nombre || !monto || !dia) {
                showToast('Por favor completa todos los campos', 'warning');
                return;
            }

            const gasto = {
                id: Date.now() + '_' + currentUser.id,
                nombre,
                monto,
                frecuencia,
                diaVencimiento: dia,
                ownerId: currentUser.id,
                proximoPago: calcularProximoPago(frecuencia, dia)
            };

            try {
                // Intentar guardar en backend primero
                try {
                    const res = await llamarBackend('saveRecurringExpense', { payload: gasto });
                    if (res.success) {
                        console.log('Gasto recurrente guardado en backend');
                    }
                } catch (backendError) {
                    console.warn('Backend no disponible, usando localStorage:', backendError);
                }

                // Siempre guardar en localStorage como respaldo
                gastosRecurrentes.push(gasto);
                localStorage.setItem('gastosRecurrentes_' + currentUser.id, JSON.stringify(gastosRecurrentes));

                bootstrap.Modal.getInstance(document.getElementById('modalRecurrente')).hide();
                document.getElementById('formRecurrente').reset();

                cargarGastosRecurrentes();
                showToast('Gasto recurrente agregado con √©xito', 'success');
            } catch (err) {
                console.error(err);
                showToast('Error al guardar el gasto recurrente', 'error');
            }
        }

        function calcularProximoPago(frecuencia, dia) {
            const hoy = new Date();
            let proximaFecha = new Date();

            if (frecuencia === 'monthly') {
                proximaFecha.setDate(dia);
                if (proximaFecha <= hoy) {
                    proximaFecha.setMonth(proximaFecha.getMonth() + 1);
                }
            } else { // weekly
                const diaActual = hoy.getDay() || 7; // Domingo = 7
                let diasHasta = dia - diaActual;
                if (diasHasta <= 0) diasHasta += 7;
                proximaFecha.setDate(hoy.getDate() + diasHasta);
            }

            return proximaFecha.toISOString().split('T')[0];
        }

        async function cargarGastosRecurrentes() {
            // Intentar cargar desde backend primero
            try {
                const res = await llamarBackend('getRecurringExpenses', { userId: currentUser.id });
                if (res.success && res.data && res.data.length > 0) {
                    gastosRecurrentes = res.data;
                    // Sincronizar con localStorage
                    localStorage.setItem('gastosRecurrentes_' + currentUser.id, JSON.stringify(gastosRecurrentes));
                    console.log('Gastos recurrentes cargados desde backend');
                } else {
                    throw new Error('No data from backend');
                }
            } catch (backendError) {
                // Fallback a localStorage
                console.warn('Usando localStorage para gastos recurrentes');
                const stored = localStorage.getItem('gastosRecurrentes_' + currentUser.id);
                gastosRecurrentes = stored ? JSON.parse(stored) : [];
            }

            const lista = document.getElementById('listaRecurrentes');
            if (!lista) return;
            lista.innerHTML = '';

            if (gastosRecurrentes.length === 0) {
                lista.innerHTML = '<p class="text-muted text-center small">No hay gastos recurrentes</p>';
                return;
            }

            const hoy = new Date();
            gastosRecurrentes.forEach(g => {
                const fechaVence = new Date(g.proximoPago);
                const diasRestantes = Math.ceil((fechaVence - hoy) / (1000 * 60 * 60 * 24));

                let badge = '';
                if (diasRestantes < 0) {
                    badge = '<span class="badge bg-danger ms-1">Vencido</span>';
                } else if (diasRestantes <= 3) {
                    badge = '<span class="badge bg-warning text-dark ms-1">¬°Pr√≥ximo!</span>';
                }

                lista.innerHTML += `
                    <div class="border rounded p-2 mb-2">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>${g.nombre}</strong> ${badge}
                                <div class="small text-muted">
                                    ${g.frecuencia === 'monthly' ? 'üìÖ Mensual' : 'üìÜ Semanal'} - 
                                    Vence: ${new Date(g.proximoPago).toLocaleDateString()}
                                </div>
                            </div>
                            <div class="text-end">
                                <div class="fw-bold text-primary">$${parseFloat(g.monto).toFixed(2)}</div>
                                <small class="text-muted">Bs ${(parseFloat(g.monto) * tasaBCV).toFixed(2)}</small>
                            </div>
                        </div>
                        <div class="mt-2 d-flex gap-1">
                            <button class="btn btn-sm btn-success flex-fill" onclick="marcarRecurrentePagado('${g.id}')" style="font-size: 0.7rem;">
                                <i class="bi bi-check-circle"></i> Pagado
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="eliminarRecurrente('${g.id}')" style="font-size: 0.7rem;">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
        }

        async function marcarRecurrentePagado(id) {
            const gasto = gastosRecurrentes.find(g => g.id === id);
            if (!gasto) return;

            if (!await showConfirmModal("Confirmar Pago", `¬øMarcar "${gasto.nombre}" como pagado?`)) return;

            // Registrar el pago en finanzas
            await llamarBackend('saveFinance', {
                payload: {
                    tipo: 'egreso',
                    nombre: `${gasto.nombre} (Recurrente)`,
                    monto: gasto.monto,
                    fecha: new Date().toISOString(),
                    ownerId: currentUser.id
                }
            });

            // Actualizar pr√≥ximo pago
            const nuevaFecha = new Date(gasto.proximoPago);
            if (gasto.frecuencia === 'monthly') {
                nuevaFecha.setMonth(nuevaFecha.getMonth() + 1);
            } else {
                nuevaFecha.setDate(nuevaFecha.getDate() + 7);
            }
            gasto.proximoPago = nuevaFecha.toISOString().split('T')[0];

            // Actualizar en backend
            try {
                await llamarBackend('updateRecurringExpense', { payload: { id: gasto.id, proximoPago: gasto.proximoPago } });
            } catch (err) {
                console.warn('Error actualizando en backend:', err);
            }

            // Actualizar localStorage
            localStorage.setItem('gastosRecurrentes_' + currentUser.id, JSON.stringify(gastosRecurrentes));

            cargarGastosRecurrentes();
            cargarDatosIniciales();
            showToast('¬°Pago registrado! Pr√≥ximo vencimiento actualizado.', 'success');
        }

        async function eliminarRecurrente(id) {
            if (!await showConfirmModal("Eliminar Gasto", "¬øEliminar este gasto recurrente?", "Eliminar", "Cancelar", true)) return;

            // Eliminar del backend
            try {
                await llamarBackend('deleteRecurringExpense', { id, userId: currentUser.id });
            } catch (err) {
                console.warn('Error eliminando del backend:', err);
            }

            // Eliminar de localStorage
            gastosRecurrentes = gastosRecurrentes.filter(g => g.id !== id);
            localStorage.setItem('gastosRecurrentes_' + currentUser.id, JSON.stringify(gastosRecurrentes));
            cargarGastosRecurrentes();
        }

        // ===== GASTOS VARIABLES SEMANALES =====

        function getNumeroSemana() {
            const hoy = new Date();
            const inicio = new Date(hoy.getFullYear(), 0, 1);
            const dias = Math.floor((hoy - inicio) / (24 * 60 * 60 * 1000));
            return Math.ceil((dias + inicio.getDay() + 1) / 7);
        }

        function agregarGastoVariable() {
            const categoria = document.getElementById('categoriaVariable').value;
            const concepto = document.getElementById('conceptoVariable').value.trim();
            const monto = parseFloat(document.getElementById('montoVariable').value);

            if (!concepto || !monto || monto <= 0) {
                showToast('Por favor completa el concepto y monto', 'warning');
                return;
            }

            const semanaActual = getNumeroSemana();
            const stored = localStorage.getItem('gastosVariables_' + currentUser.id);
            let gastosSemanales = stored ? JSON.parse(stored) : [];

            // Buscar si ya existe un registro para esta semana y categor√≠a
            let registroSemana = gastosSemanales.find(g => g.semana === semanaActual && g.categoria === categoria);

            if (!registroSemana) {
                registroSemana = {
                    semana: semanaActual,
                    categoria: categoria,
                    gastos: [],
                    totalSemana: 0,
                    pagado: false,
                    ownerId: currentUser.id
                };
                gastosSemanales.push(registroSemana);
            }

            registroSemana.gastos.push({
                concepto,
                monto,
                fecha: new Date().toISOString()
            });

            registroSemana.totalSemana = registroSemana.gastos.reduce((sum, g) => sum + g.monto, 0);

            // Sync with backend
            try {
                await llamarBackend('saveVariableExpense', { payload: registroSemana });
            } catch (err) {
                console.warn("Backend sync failed for variable expense:", err);
            }

            localStorage.setItem('gastosVariables_' + currentUser.id, JSON.stringify(gastosSemanales));

            document.getElementById('conceptoVariable').value = '';
            document.getElementById('montoVariable').value = '';

            cargarGastosVariables();
        }

        async function cargarGastosVariables() {
            const semanaActual = getNumeroSemana();

            // Try loading from backend first
            try {
                const res = await llamarBackend('getVariableExpenses', { userId: currentUser.id });
                if (res.success && res.data) {
                    localStorage.setItem('gastosVariables_' + currentUser.id, JSON.stringify(res.data));
                }
            } catch (err) {
                console.warn("Backend fetch failed for variable expenses, using local storage");
            }

            const stored = localStorage.getItem('gastosVariables_' + currentUser.id);
            const gastosSemanales = stored ? JSON.parse(stored) : [];

            const registrosSemanaActual = gastosSemanales.filter(g => g.semana === semanaActual && !g.pagado);

            const lista = document.getElementById('listaVariables');
            lista.innerHTML = '';

            let totalSemana = 0;

            registrosSemanaActual.forEach(registro => {
                totalSemana += registro.totalSemana;

                registro.gastos.forEach(gasto => {
                    lista.innerHTML += `
                        <div class="d-flex justify-content-between align-items-center py-1 border-bottom">
                            <small>${gasto.concepto}</small>
                            <strong class="text-primary">$${gasto.monto.toFixed(2)}</strong>
                        </div>
                    `;
                });
            });

            document.getElementById('totalSemanalUSD').textContent = `$${totalSemana.toFixed(2)}`;
            document.getElementById('totalSemanalBS').textContent = `Bs ${(totalSemana * tasaBCV).toFixed(2)}`;

            document.getElementById('btnPagarSemana').disabled = totalSemana === 0;
        }

        async function pagarSemana() {
            const semanaActual = getNumeroSemana();
            const stored = localStorage.getItem('gastosVariables_' + currentUser.id);
            let gastosSemanales = stored ? JSON.parse(stored) : [];

            const registrosSemana = gastosSemanales.filter(g => g.semana === semanaActual && !g.pagado);

            if (registrosSemana.length === 0) return;

            const totalSemana = registrosSemana.reduce((sum, r) => sum + r.totalSemana, 0);

            if (!await showConfirmModal("Pagar Semana", `¬øMarcar como pagado el total de la semana: $${totalSemana.toFixed(2)}?`)) return;

            // Registrar en finanzas
            for (const registro of registrosSemana) {
                await llamarBackend('saveFinance', {
                    payload: {
                        tipo: 'egreso',
                        nombre: `${registro.categoria} - Semana ${semanaActual}`,
                        monto: registro.totalSemana,
                        fecha: new Date().toISOString(),
                        ownerId: currentUser.id
                    }
                });

                // Marcar como pagado en el registro de gastos variables del backend
                try {
                    await llamarBackend('markVariableAsPaid', { id: registro.id, userId: currentUser.id });
                } catch (err) {
                    console.warn("Error marking variable expense as paid on backend:", err);
                }

                registro.pagado = true;
            }

            localStorage.setItem('gastosVariables_' + currentUser.id, JSON.stringify(gastosSemanales));

            cargarGastosVariables();
            cargarDatosIniciales();
            showToast('¬°Semana marcada como pagada!', 'success');
        }

        // ===== AHORROS =====

        // ===== AHORROS (SAVINGS MANAGER INTEGRATION) =====

        // Render UI from SavingsManager
        function renderizarMetasAhorro() {
            const container = document.getElementById('savingsGoalsContainer');
            if (!savingsManager || !container) return;

            const goals = savingsManager.getAllGoals();
            container.innerHTML = "";

            if (goals.length === 0) {
                container.innerHTML = '<p class="text-muted text-center small my-2">Crea una meta para empezar a ahorrar.</p>';
                return;
            }

            goals.forEach(g => {
                const percent = Math.round(g.state.progressPercentage);
                const colorClass = percent >= 100 ? 'bg-success' : 'bg-primary';

                container.innerHTML += `
                    <div class="border rounded p-2 mb-2 bg-light">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <strong>${g.name}</strong>
                            <small class="text-muted">$${g.state.currentAmount} / $${g.targetDetails.amount}</small>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar ${colorClass}" role="progressbar" style="width: ${percent}%"></div>
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                             <small class="text-muted">${percent}% completado</small>
                             <div>
                                <button class="btn btn-sm btn-light border py-0 px-2" onclick="prepararTransaccionAhorro('${g.id}', 'DEPOSIT')">+</button>
                                <button class="btn btn-sm btn-light border py-0 px-2" onclick="prepararTransaccionAhorro('${g.id}', 'WITHDRAWAL')">-</button>
                             </div>
                        </div>
                    </div>
                `;
            });
        }

        function promptNuevaMeta() {
            const nombre = prompt("Nombre de la meta (ej: Viaje):");
            if (!nombre) return;
            const target = parseFloat(prompt("Monto objetivo ($):"));
            if (!target || isNaN(target)) return;

            savingsManager.createGoal(nombre, target);
            renderizarMetasAhorro();
        }

        let currentGoalId = null;

        function prepararTransaccionAhorro(goalId, tipo) {
            currentGoalId = goalId;
            const goal = savingsManager.getGoal(goalId);

            document.getElementById('ahorroTipo').value = tipo;
            document.getElementById('tituloModalAhorros').textContent =
                `${tipo === 'DEPOSIT' ? 'Depositar a' : 'Retirar de'} ${goal.name}`;

            const btn = document.getElementById('btnGuardarAhorro');
            btn.className = tipo === 'DEPOSIT' ? 'btn btn-sm btn-success' : 'btn btn-sm btn-danger';
            btn.innerHTML = tipo === 'DEPOSIT' ? 'Depositar' : 'Retirar';

            document.getElementById('formAhorros').reset();
            bootstrap.Modal.getOrCreateInstance(document.getElementById('modalAhorros')).show();
        }

        async function guardarAhorro() {
            if (!currentGoalId) return;

            const tipo = document.getElementById('ahorroTipo').value; // DEPOSIT or WITHDRAWAL
            const monto = parseFloat(document.getElementById('ahorroMonto').value);

            if (!monto || monto <= 0) {
                showToast('Por favor ingresa un monto v√°lido', 'warning');
                return;
            }

            try {
                const result = await savingsManager.addTransaction(currentGoalId, monto, tipo);

                if (result.success) {
                    bootstrap.Modal.getInstance(document.getElementById('modalAhorros')).hide();
                    renderizarMetasAhorro();

                    if (result.conflict) {
                        showInfoModal("Conflicto de Datos", "‚ö†Ô∏è Conflicto detectado: Alguien m√°s actualiz√≥ esta meta. Se han recargado los datos m√°s recientes.");
                    } else if (result.offline) {
                        showToast("Guardado en modo offline ‚òÅÔ∏è", 'info');
                    } else {
                        showToast(`${tipo === 'DEPOSIT' ? 'Fondos agregados' : 'Fondos retirados'} con √©xito`, 'success');
                    }
                }
            } catch (e) {
                console.error(e);
                showToast("Error al procesar ahorro: " + e.message, 'error');
            }
        }

        function cargarAhorros() {
            // Deprecated in favor of savingsManager but kept empty to prevent breakages if called elsewhere
        }



        // ===== DASHBOARD (REAL DATA) =====
        async function cargarDashboard() {
            try {
                const res = await llamarBackend('getFinanceStats', { userId: currentUser.id });
                if (!res.success) throw new Error(res.message);

                const stats = res.stats;

                // 1. Update Cards
                const cardIngresos = document.getElementById('statIngresosMes');
                const cardGastos = document.getElementById('statGastosMes');
                const cardBalance = document.getElementById('statBalance');
                const cardAhorros = document.getElementById('statAhorros');

                if (cardIngresos) cardIngresos.innerText = `$${stats.ingresosMes.toFixed(2)}`;
                if (cardGastos) cardGastos.innerText = `$${stats.gastosMes.toFixed(2)}`;
                if (cardBalance) cardBalance.innerText = `$${stats.balance.toFixed(2)}`;
                if (cardAhorros) cardAhorros.innerText = `$${stats.ahorrosTotal.toFixed(2)}`; // Updated key

                // 2. Render Charts
                // Monthly Chart (Ingresos vs Gastos vs Balance)
                renderChart('chartMensual', 'bar', {
                    labels: ['Ingresos', 'Gastos', 'Balance'],
                    datasets: [{
                        label: 'Mes Actual',
                        data: [stats.ingresosMes, stats.gastosMes, stats.balance],
                        backgroundColor: ['#84fab0', '#fa709a', '#a8edea'],
                        borderWidth: 0,
                        borderRadius: 4
                    }]
                }, 'mensual');

                // Weekly/Comparison Charts (Placeholder or Basic)
                renderChart('chartComparativa', 'doughnut', {
                    labels: ['Ingresos', 'Gastos'],
                    datasets: [{
                        data: [stats.ingresosMes, stats.gastosMes],
                        backgroundColor: ['#84fab0', '#fa709a'],
                        hoverOffset: 4
                    }]
                }, 'comparativa');

            } catch (e) {
                console.warn("Error loading dashboard", e);
            }
        }

        function renderChart(canvasId, type, data, key) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;

            if (chartsInstances[key]) {
                chartsInstances[key].destroy();
            }

            chartsInstances[key] = new Chart(ctx, {
                type: type,
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    },
                    scales: type === 'bar' ? {
                        y: { beginAtZero: true }
                    } : {}
                }
            });
        }

        // ===== PRESUPUESTOS POR CATEGOR√çA (v5) =====

        // Configuration
        const categoryLimits = {}; // { 'Carne': 50, 'Verduras': 30 }

        async function loadCategoryBudgets() {
            if (!currentUser) return;
            try {
                const res = await llamarBackend('getCategoryBudgets', { userId: currentUser.id });
                if (res.success) {
                    res.list.forEach(item => {
                        categoryLimits[item.category] = parseFloat(item.limit);
                    });
                    renderCategoryBudgets();
                }
            } catch (e) {
                console.error("Error loading budgets", e);
            }
        }

        async function setCategoryBudget(category, limit) {
            if (!category || isNaN(limit)) return;
            categoryLimits[category] = parseFloat(limit);
            renderCategoryBudgets();

            // Save to backend
            try {
                await llamarBackend('saveCategoryBudget', {
                    payload: {
                        ownerId: currentUser.id,
                        category: category,
                        limit: limit
                    }
                });
                showToast(`L√≠mite para ${category} actualizado`, 'success');
            } catch (e) {
                showToast("Error guardando l√≠mite", 'error');
            }
        }

        function renderCategoryBudgets() {
            const container = document.getElementById('categoryBudgetsList');
            if (!container) return; // Might not exist yet if we don't add HTML

            // Calculate actual spending per category from Shopping List (Cart + Pending) 
            // and potentially Finance history if we want a monthly view.
            // For "MarketPlanner", let's focus on THIS trip/list vs Limit.

            const spending = {};

            // From current shopping list
            shoppingList.forEach(item => {
                // Determine category? We have 'Mercado' but not Category in updated Product schema yet?
                // Wait, Product schema is: [id, nombre, cantidad, precio, mercado, CATEGORIA, ...]
                // Actually index 5 is Category! (See saveProduct backend code: "General")
                // We need to ensure we have the category in the shoppingList item.
                const cat = item.categoria || 'General';
                spending[cat] = (spending[cat] || 0) + (item.precio * item.quantity);
            });

            // Also need to know all available categories?
            // Let's use keys from spending + keys from limits
            const allCats = new Set([...Object.keys(spending), ...Object.keys(categoryLimits)]);

            let html = '';
            allCats.forEach(cat => {
                const spent = spending[cat] || 0;
                const limit = categoryLimits[cat] || 0;
                const pct = limit > 0 ? (spent / limit) * 100 : 0;
                const isOver = limit > 0 && spent > limit;

                html += `
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="fw-medium">${cat}</span>
                            <span class="small ${isOver ? 'text-danger fw-bold' : 'text-muted'}">
                                $${spent.toFixed(2)} / ${limit > 0 ? '$' + limit.toFixed(2) : '‚àû'}
                            </span>
                        </div>
                        <div class="progress" style="height: 6px; cursor: pointer;" onclick="promptBudgetLimit('${cat}', ${limit})">
                            <div class="progress-bar ${isOver ? 'bg-danger' : 'bg-info'}" 
                                role="progressbar" style="width: ${Math.min(pct, 100)}%"></div>
                        </div>
                    </div>
                 `;
            });

            container.innerHTML = html;
        }

        async function promptBudgetLimit(category, currentLimit) {
            // Simple prompt for now, could be improved with custom modal with inputs
            // Using a simple workaround for input since showConfirmModal doesn't support inputs yet
            // We'll trust the user has keyboard
            const newLimit = prompt(`Definir l√≠mite para ${category} ($):`, currentLimit || 0);
            if (newLimit !== null) {
                setCategoryBudget(category, newLimit);
            }
        }

        // ===== DASHBOARD Y GR√ÅFICAS (DUPLICADO - REMOVIDO) =====
        function switchProductView(view) {
            document.getElementById('catalogView').style.display = view === 'catalog' ? 'block' : 'none';
            document.getElementById('inventoryView').style.display = view === 'inventory' ? 'block' : 'none';
            if (view === 'inventory') renderInventory();
        }

        function renderInventory() {
            const container = document.getElementById('inventoryGrid');
            if (!container) return;
            container.innerHTML = "";

            inventoryManager.data.forEach(item => {
                const prod = productosCache.find(p => p[0] == item.productId);
                if (!prod) return;

                container.innerHTML += `
                    <div class="col-12">
                        <div class="list-group-item d-flex justify-content-between align-items-center bg-white border-0 shadow-sm rounded-3 mb-2 p-3">
                            <div>
                                <div class="fw-bold">${prod[1]}</div>
                                <div class="small text-muted">Stock: ${item.qty} / Min: ${item.min}</div>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <button class="btn btn-sm btn-outline-secondary" onclick="inventoryManager.updateStock(${item.productId}, -1).then(() => renderInventory())">-</button>
                                <span class="fw-bold px-2">${item.qty}</span>
                                <button class="btn btn-sm btn-outline-primary" onclick="inventoryManager.updateStock(${item.productId}, 1).then(() => renderInventory())">+</button>
                            </div>
                        </div>
                    </div>
                `;
            });
        async function loadProductsCatalog() {
            try {
                const res = await llamarBackend('getInitialData', { userId: currentUser.id });
                    if (res.success && res.products) {
                        allProducts = res.products;
                        renderProductsCatalog(allProducts);
                        loadMercadoFilter();
                        document.getElementById('catalogCount').textContent = `${allProducts.length} productos`;
                    }
                } catch (err) {
                    console.error('Error cargando cat√°logo:', err);
                    showToast('Error cargando cat√°logo de productos', 'error');
                }

                // Cargar lista de compra
                loadShoppingList();
                loadListHistory();
            }

            function renderProductsCatalog(products) {
                const grid = document.getElementById('productsGrid');
                if (!grid) return;

                if (products.length === 0) {
                    grid.innerHTML = '<p class="text-muted text-center col-span-full">No hay productos disponibles</p>';
                    return;
                }

                grid.innerHTML = products.map(p => {
                    const inList = shoppingList.some(item => item.productId === p[0]);
                    return `
                    <div class="product-card ${inList ? 'in-list' : ''}" data-id="${p[0]}">
                        ${inList ? '<span class="badge-in-list"><i class="bi bi-check-circle"></i> En lista</span>' : ''}
                        <div class="product-image-placeholder">
                            <i class="bi bi-box-seam"></i>
                        </div>
                        <div class="product-info">
                            <div class="product-name">${p[1]}</div>
                            <div class="product-market">
                                <i class="bi bi-shop"></i> ${p[4]}
                            </div>
                            <div class="product-price">
                                <strong>$${parseFloat(p[3]).toFixed(2)}</strong><br>
                                <small class="text-muted">Bs ${(parseFloat(p[3]) * tasaBCV).toFixed(2)}</small>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-primary w-100 add-to-list-btn" onclick="addToShoppingList('${p[0]}')" ${inList ? 'disabled' : ''}>
                            <i class="bi bi-cart-plus"></i> ${inList ? 'En lista' : 'Agregar'}
                        </button>
                    </div>
                `;
                }).join('');
            }

            function loadMercadoFilter() {
                const mercados = [...new Set(allProducts.map(p => p[4]))];
                const select = document.getElementById('filterMercado');
                if (!select) return;

                select.innerHTML = '<option value="">Todos los mercados</option>' +
                    mercados.map(m => `<option value="${m}">${m}</option>`).join('');
            }

            function filterProducts() {
                const searchTerm = document.getElementById('searchProductCatalog')?.value.toLowerCase() || '';
                const mercado = document.getElementById('filterMercado')?.value || '';

                const filtered = allProducts.filter(p => {
                    const matchSearch = p[1].toLowerCase().includes(searchTerm);
                    const matchMercado = !mercado || p[4] === mercado;
                    return matchSearch && matchMercado;
                });

                renderProductsCatalog(filtered);
                document.getElementById('catalogCount').textContent = `${filtered.length} productos`;
            }

            function clearProductFilters() {
                document.getElementById('searchProductCatalog').value = '';
                document.getElementById('filterMercado').value = '';
                filterProducts();
            }

            // Event listeners para filtros
            document.addEventListener('DOMContentLoaded', function () {
                const searchInput = document.getElementById('searchProductCatalog');
                const mercadoSelect = document.getElementById('filterMercado');

                if (searchInput) {
                    searchInput.addEventListener('input', filterProducts);
                }

                if (mercadoSelect) {
                    mercadoSelect.addEventListener('change', filterProducts);
                }
            });

            // ==================== LISTA DE COMPRA ====================

            function addToShoppingList(productId) {
                const product = allProducts.find(p => p[0] == productId);
                if (!product) return;

                if (shoppingList.some(item => item.productId == productId)) {
                    showToast('Producto ya est√° en la lista', 'info');
                    return;
                }

                shoppingList.push({
                    productId: product[0],
                    nombre: product[1],
                    mercado: product[4],
                    precio: parseFloat(product[3]),
                    quantity: 1,
                    checked: false
                });

                saveShoppingList();
                renderShoppingList();
                filterProducts(); // Re-render para actualizar badges
                showToast(`${product[1]} agregado a la lista`, 'success');
            }

            function removeFromShoppingList(productId) {
                shoppingList = shoppingList.filter(item => item.productId != productId);
                saveShoppingList();
                renderShoppingList();
                filterProducts();
                showToast('Producto eliminado de la lista', 'info');
            }

            function updateQuantity(productId, newQuantity) {
                const item = shoppingList.find(i => i.productId == productId);
                if (item && newQuantity > 0) {
                    item.quantity = parseInt(newQuantity);
                    saveShoppingList();
                    renderShoppingList();
                }
            }

            function incrementQuantity(productId) {
                const item = shoppingList.find(i => i.productId == productId);
                if (item) {
                    item.quantity++;
                    saveShoppingList();
                    renderShoppingList();
                }
            }

            function toggleItemCheck(productId) {
                const item = shoppingList.find(i => i.productId == productId);
                if (item) {
                    item.checked = !item.checked;
                    saveShoppingList();
                    renderShoppingList();
                }
            }

            function decrementQuantity(productId) {
                const item = shoppingList.find(i => i.productId == productId);
                if (item && item.quantity > 1) {
                    item.quantity--;
                    saveShoppingList();
                    renderShoppingList();
                }
            }

            function renderShoppingList() {
                const container = document.getElementById('shoppingListItems');
                if (!container) return;

                if (shoppingList.length === 0) {
                    container.innerHTML = `
                    <p class="text-muted text-center small my-4">
                        <i class="bi bi-cart-x fs-3 d-block mb-2"></i>
                        Tu lista est√° vac√≠a
                    </p>
                `;
                    updateListTotals(0, 0);
                    return;
                }

                // Split items
                const pending = shoppingList.filter(i => !i.checked);
                const inCart = shoppingList.filter(i => i.checked);

                let html = '';
                let totalPending = 0;
                let totalCart = 0;

                // Render Pending
                if (pending.length > 0) {
                    html += `<h6 class="small fw-bold text-muted text-uppercase mb-2">Pendiente (${pending.length})</h6>`;
                    html += pending.map(item => renderListItemHTML(item, false)).join('');
                    totalPending = pending.reduce((sum, i) => sum + (i.precio * i.quantity), 0);
                }

                // Render In Cart
                if (inCart.length > 0) {
                    html += `<h6 class="small fw-bold text-success text-uppercase mt-4 mb-2">En Carrito (${inCart.length})</h6>`;
                    html += inCart.map(item => renderListItemHTML(item, true)).join('');
                    totalCart = inCart.reduce((sum, i) => sum + (i.precio * i.quantity), 0);
                }

                container.innerHTML = html;
                updateListTotals(totalPending, totalCart);
            }

            function renderListItemHTML(item, isChecked) {
                const subtotal = item.precio * item.quantity;
                return `
                <div class="list-item ${isChecked ? 'bg-light opacity-75' : ''}" style="${isChecked ? 'border-left: 4px solid var(--success);' : ''}">
                    <div class="form-check d-flex align-items-center me-2">
                        <input class="form-check-input fs-5" type="checkbox" 
                            ${isChecked ? 'checked' : ''} 
                            onchange="toggleItemCheck('${item.productId}')">
                    </div>
                    <div class="item-info">
                        <strong class="${isChecked ? 'text-decoration-line-through text-muted' : ''}">${item.nombre}</strong>
                        <div class="small text-muted">${item.mercado}</div>
                        <div class="d-flex align-items-center mt-1 gap-2">
                            <small class="text-primary fw-bold">$${item.precio.toFixed(2)}</small>
                            <span class="text-muted" style="font-size: 0.8em;">x ${item.quantity}</span>
                        </div>
                    </div>
                    <div class="text-end">
                        <div class="fw-bold">$${subtotal.toFixed(2)}</div>
                        
                        <div class="item-quantity mt-1 justify-content-end">
                            <button class="qty-btn btn-sm py-0 px-1" onclick="decrementQuantity('${item.productId}')"><i class="bi bi-dash"></i></button>
                            <span class="mx-1 small fw-bold">${item.quantity}</span>
                            <button class="qty-btn btn-sm py-0 px-1" onclick="incrementQuantity('${item.productId}')"><i class="bi bi-plus"></i></button>
                        </div>
                    </div>
                    <button class="btn btn-link text-danger ms-2 p-0" onclick="removeFromShoppingList('${item.productId}')">
                        <i class="bi bi-x-circle"></i>
                    </button>
                </div>
            `;
            }

            function updateListTotals(pending, cart) {
                const total = pending + cart;
                document.getElementById('listCountBadge').textContent = shoppingList.length;

                // Main Display
                document.getElementById('listTotalUSD').textContent = `$${total.toFixed(2)}`;
                document.getElementById('listTotalBS').textContent = `Bs ${(total * tasaBCV).toFixed(2)}`;

                // Budget Bar Interaction (Check vs Limit)
                updateBudgetUI(total);

                // Update Checkout Button state
                const btnCheckout = document.getElementById('btnCheckout');
                if (btnCheckout) {
                    if (cart > 0) {
                        btnCheckout.disabled = false;
                        btnCheckout.innerHTML = `<i class="bi bi-bag-check-fill"></i> Pagar Carrito ($${cart.toFixed(2)})`;
                        btnCheckout.classList.replace('btn-secondary', 'btn-success');
                    } else {
                        btnCheckout.disabled = true;
                        btnCheckout.innerHTML = `<i class="bi bi-bag-check"></i> Nada en carrito`;
                        btnCheckout.classList.replace('btn-success', 'btn-secondary');
                    }
                }
            }

            async function processCheckout() {
                const inCart = shoppingList.filter(i => i.checked);
                if (inCart.length === 0) return;

                const totalCart = inCart.reduce((sum, i) => sum + (i.precio * i.quantity), 0);

                if (!await showConfirmModal("Finalizar Compra", `¬øFinalizar compra de ${inCart.length} productos por $${totalCart.toFixed(2)}?\n\nEsto registrar√° un Gasto y limpiar√° estos √≠tems de la lista.`)) return;

                // 1. Register Expense
                try {
                    await llamarBackend('saveFinance', {
                        payload: {
                            tipo: 'egreso',
                            nombre: `Compra Mercado (${inCart.length} items)`,
                            monto: totalCart,
                            fecha: new Date().toISOString(),
                            ownerId: currentUser.id,
                            detalles: inCart.map(i => `${i.quantity}x ${i.nombre}`).join(', ')
                        }
                    });

                    // 2. Remove Bought items
                    shoppingList = shoppingList.filter(i => !i.checked);
                    saveShoppingList();
                    renderShoppingList();

                    // 3. Refresh Finance Data
                    cargarDatosIniciales();

                    showToast("¬°Compra registrada con √©xito! üõçÔ∏è", 'success');
                } catch (e) {
                    console.error(e);
                    showToast("Error al procesar compra: " + e.message, 'error');
                }
            }

            function saveShoppingList() {
                if (currentUser) {
                    localStorage.setItem('shoppingList_' + currentUser.id, JSON.stringify(shoppingList));
                }
            }

            function loadShoppingList() {
                if (currentUser) {
                    const stored = localStorage.getItem('shoppingList_' + currentUser.id);
                    shoppingList = stored ? JSON.parse(stored) : [];
                    renderShoppingList();
                }
            }

            async function clearShoppingList() {
                if (shoppingList.length === 0) return;

                if (await showConfirmModal('Limpiar Lista', `¬øLimpiar toda la lista de compra (${shoppingList.length} productos)?`)) {
                    // Guardar en historial antes de limpiar
                    saveToHistory();
                    shoppingList = [];
                    saveShoppingList();
                    renderShoppingList();
                    filterProducts();
                    showToast('Lista de compra limpiada', 'success');
                }
            }

            // ==================== FUNCIONALIDADES OPCIONALES ====================

            // Exportar/Compartir lista
            function exportShoppingList() {
                if (shoppingList.length === 0) {
                    showToast('La lista de compra est√° vac√≠a', 'info');
                    return;
                }

                let total = shoppingList.reduce((sum, item) => sum + (item.precio * item.quantity), 0);

                let text = `üõí LISTA DE COMPRA - MarketPlanner\n`;
                text += `Fecha: ${new Date().toLocaleDateString()}\n`;
                text += `\n`;

                shoppingList.forEach(item => {
                    text += `‚Ä¢ ${item.nombre} (${item.quantity}x) - $${(item.precio * item.quantity).toFixed(2)}\n`;
                    text += `  ${item.mercado}\n`;
                });

                text += `\nüí∞ TOTAL: $${total.toFixed(2)} (Bs ${(total * tasaBCV).toFixed(2)})`;

                if (navigator.share) {
                    navigator.share({
                        title: 'Mi Lista de Compra',
                        text: text
                    }).then(() => {
                        showToast('Lista compartida exitosamente', 'success');
                    }).catch(err => {
                        console.log('Error sharing:', err);
                        copyToClipboard(text);
                    });
                } else {
                    copyToClipboard(text);
                }
            }

            function copyToClipboard(text) {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showToast('Lista copiada al portapapeles', 'success');
            }

            // Historial de listas
            function saveToHistory() {
                if (shoppingList.length === 0) return;

                const total = shoppingList.reduce((sum, item) => sum + (item.precio * item.quantity), 0);

                listHistory.unshift({
                    id: Date.now(),
                    date: new Date().toISOString(),
                    items: [...shoppingList],
                    total: total,
                    count: shoppingList.length
                });

                // Mantener solo √∫ltimas 10 listas
                if (listHistory.length > 10) {
                    listHistory = listHistory.slice(0, 10);
                }

                if (currentUser) {
                    localStorage.setItem('listHistory_' + currentUser.id, JSON.stringify(listHistory));
                }

                renderListHistory();
            }

            function loadListHistory() {
                if (currentUser) {
                    const stored = localStorage.getItem('listHistory_' + currentUser.id);
                    listHistory = stored ? JSON.parse(stored) : [];
                    renderListHistory();
                }
            }

            function renderListHistory() {
                const container = document.getElementById('listHistory');
                if (!container) return;

                if (listHistory.length === 0) {
                    container.innerHTML = '<p class="text-muted text-center my-2">Sin historial</p>';
                    return;
                }

                container.innerHTML = listHistory.map(list => {
                    const date = new Date(list.date).toLocaleDateString();
                    return `
                    <div class="history-item" onclick="loadHistoryList('${list.id}')">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${date}</strong>
                                <br><small class="text-muted">${list.count} productos</small>
                            </div>
                            <div class="text-end">
                                <strong class="text-primary">$${list.total.toFixed(2)}</strong>
                            </div>
                        </div>
                    </div>
                `;
                }).join('');
            }

            async function loadHistoryList(listId) {
                const list = listHistory.find(l => l.id == listId);
                if (!list) return;

                if (await showConfirmModal('Cargar Historial', `¬øCargar lista del ${new Date(list.date).toLocaleDateString()}?\n${list.count} productos - $${list.total.toFixed(2)}`)) {
                    shoppingList = [...list.items];
                    saveShoppingList();
                    renderShoppingList();
                    filterProducts();
                    showToast('Lista del historial cargada', 'success');
                }
            }


        // ==================== FIN NUEVAS FUNCIONALIDADES ====================
    </script>
    <script>
            // --- UX HELPERS: Modals & Toasts ---

            function showToast(message, type = 'info') {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `custom-toast ${type}`;

                let icon = 'bi-info-circle';
                if (type === 'success') icon = 'bi-check-circle-fill text-success';
                if (type === 'error') icon = 'bi-exclamation-triangle-fill text-danger';
                if (type === 'warning') icon = 'bi-exclamation-circle-fill text-warning';

                toast.innerHTML = `
                <i class="bi ${icon} fs-4"></i>
                <div class="flex-grow-1 fw-medium">${message}</div>
                <button class="btn-close small" onclick="this.parentElement.remove()"></button>
            `;

                container.appendChild(toast);

                // Auto remove after 4s
                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateY(-20px)';
                    setTimeout(() => toast.remove(), 300);
                }, 4000);
            }

            function showInfoModal(title, message) {
                return new Promise((resolve) => {
                    const modalEl = document.getElementById('customGenericModal');
                    const modal = new bootstrap.Modal(modalEl);

                    document.getElementById('customModalTitle').textContent = title;
                    document.getElementById('customModalBody').innerHTML = message; // Use innerHTML for potential HTML content
                    document.getElementById('customModalFooter').innerHTML = `
                    <button class="btn btn-primary w-100" data-bs-dismiss="modal">Entendido</button>
                `;

                    modalEl.addEventListener('hidden.bs.modal', () => {
                        resolve();
                    }, { once: true });

                    modal.show();
                });
            }

            function showConfirmModal(title, message, confirmText = 'Confirmar', cancelText = 'Cancelar', isDestructive = false) {
                return new Promise((resolve) => {
                    const modalEl = document.getElementById('customGenericModal');
                    const modal = new bootstrap.Modal(modalEl);

                    document.getElementById('customModalTitle').textContent = title;
                    document.getElementById('customModalBody').innerHTML = message; // Use innerHTML for potential HTML content

                    const btnClass = isDestructive ? 'btn-danger' : 'btn-primary';

                    document.getElementById('customModalFooter').innerHTML = `
                    <button class="btn btn-light flex-fill" data-bs-dismiss="modal">
                        ${cancelText}
                    </button>
                    <button class="btn ${btnClass} flex-fill" id="btnConfirmAction">
                        ${confirmText}
                    </button>
                `;

                    let confirmed = false;

                    const confirmBtn = document.getElementById('btnConfirmAction');
                    confirmBtn.onclick = () => {
                        confirmed = true;
                        modal.hide();
                    };

                    modalEl.addEventListener('hidden.bs.modal', () => {
                        resolve(confirmed);
                    }, { once: true });

                    modal.show();
                });
            }

            // --- BACKEND SIMULADO (Google Apps Script) ---
            function syncDarkMode() {
                const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                document.documentElement.setAttribute('data-bs-theme', isDark ? 'dark' : 'light');
            }
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', syncDarkMode);
            syncDarkMode();
    </script>
</body>

</html>
