<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MarketPlanner OS</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0d6efd">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js').catch(err => console.log("SW error", err));
            });
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --primary: #0066ff;
            --primary-soft: #eef5ff;
            --bg: #f5f7fb;
            --card-bg: #ffffff;
            --text-main: #1a1d23;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --radius-lg: 16px;
            --radius-md: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
            --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #0f172a;
                --card-bg: #1e293b;
                --text-main: #f8fafc;
                --text-muted: #94a3b8;
                --border: #334155;
                --primary-soft: #1e3a8a;
            }

            body {
                color-scheme: dark;
            }
        }

        body {
            background-color: var(--bg);
            color: var(--text-main);
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            transition: var(--transition);
            -webkit-font-smoothing: antialiased;
        }

        /* Minimalist Navbar and Tabs */
        .navbar {
            background: var(--card-bg) !important;
            border-bottom: 1px solid var(--border);
            padding: 1rem 0;
        }

        .navbar-brand {
            color: var(--primary) !important;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .nav-tabs {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
            padding: 0 0.5rem;
            gap: 1rem;
        }

        .nav-link {
            border: none !important;
            color: var(--text-muted) !important;
            font-weight: 500;
            font-size: 0.9rem;
            padding: 1rem 0.5rem !important;
            position: relative;
            transition: var(--transition);
        }

        .nav-link.active {
            background: none !important;
            color: var(--primary) !important;
        }

        .nav-link.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--primary);
            border-radius: 3px 3px 0 0;
        }

        /* Modern Cards */
        .card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
            overflow: hidden;
            transition: var(--transition);
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            background: transparent;
            border-bottom: 1px solid var(--border);
            padding: 1.25rem;
            font-weight: 600;
            color: var(--text-main);
        }

        .card-body {
            padding: 1.25rem;
        }

        .card-resumen {
            background: linear-gradient(135deg, var(--primary), #0052cc);
            border: none;
            color: white;
        }

        .card-resumen .text-primary,
        .card-resumen .text-muted {
            color: white !important;
            opacity: 0.9;
        }

        /* Floating Action Button */
        .fab {
            background: var(--primary);
            color: white;
            border: none;
            width: 56px;
            height: 56px;
            border-radius: 18px;
            position: fixed;
            bottom: 24px;
            right: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 4px 14px 0 rgba(0, 102, 255, 0.39);
            transition: var(--transition);
            z-index: 1000;
        }

        .fab:hover {
            transform: scale(1.1);
            background: #0052cc;
        }

        /* Modern Forms */
        .form-control,
        .form-select {
            background-color: var(--bg);
            border: 1.5px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--text-main);
            padding: 0.75rem 1rem;
            transition: var(--transition);
        }

        .form-control:focus {
            background-color: var(--card-bg);
            border-color: var(--primary);
            box-shadow: 0 0 0 4px var(--primary-soft);
        }

        /* List Items */
        .list-group-item {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: var(--radius-md) !important;
            margin-bottom: 0.5rem;
            padding: 1rem;
            transition: var(--transition);
        }

        .list-group-item:hover {
            border-color: var(--primary);
        }

        /* Badges */
        .badge {
            padding: 0.5em 0.8em;
            border-radius: 8px;
            font-weight: 500;
        }

        /* Login Wall */
        #loginWall {
            background: var(--bg) !important;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #loginWall .card {
            width: 100%;
            max-width: 400px;
            border: none;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        /* Search Suggestions */
        .search-suggestions {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-top: none;
            border-radius: 0 0 var(--radius-md) var(--radius-md);
            box-shadow: var(--shadow);
            z-index: 1050;
        }

        .suggestion-item {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
        }

        .suggestion-item:hover {
            background: var(--bg);
        }

        /* Transitions for interactive elements */
        .btn {
            border-radius: var(--radius-md);
            font-weight: 500;
            padding: 0.6rem 1.2rem;
            transition: var(--transition);
        }

        .btn-primary {
            background: var(--primary);
            border: none;
        }

        .btn-primary:hover {
            background: #0052cc;
            transform: translateY(-1px);
        }

        /* Adjustments for dark mode aesthetics */
        [data-bs-theme="dark"] .bg-light {
            background-color: var(--bg) !important;
        }

        [data-bs-theme="dark"] .text-muted {
            color: var(--text-muted) !important;
        }

        /* Scanner Overlay prominence */
        #modalScanner {
            z-index: 2050 !important;
        }

        /* ===== CALENDAR & PRODUCTS STYLES ===== */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px 12px 0 0;
        }

        .calendar-title {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e0e0e0;
            border-radius: 0 0 12px 12px;
            overflow: hidden;
        }

        .calendar-day-header {
            background: #f5f5f5;
            padding: 0.5rem;
            text-align: center;
            font-weight: 600;
            font-size: 0.75rem;
            color: #666;
        }

        .calendar-day {
            background: white;
            padding: 0.5rem;
            min-height: 70px;
            position: relative;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            flex-direction: column;
        }

        .calendar-day:hover {
            background: #f8f9fa;
        }

        .calendar-day.other-month {
            color: #ccc;
            background: #fafafa;
        }

        .calendar-day.today {
            background: #e3f2fd;
            font-weight: bold;
            border: 2px solid #2196f3;
        }

        .calendar-day-number {
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .event-dots {
            display: flex;
            gap: 3px;
            flex-wrap: wrap;
        }

        .event-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            display: inline-block;
        }

        .event-dot.income {
            background: #4caf50;
        }

        .event-dot.expense {
            background: #f44336;
        }

        .event-dot.recurring {
            background: #ff9800;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .product-card {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            position: relative;
            border: 2px solid transparent;
        }

        .product-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
            border-color: #667eea;
        }

        .product-card.in-list {
            border-color: #4caf50;
            background: #f1f8f4;
        }

        .product-image-placeholder {
            width: 100%;
            height: 100px;
            background: linear-gradient(135deg, #667eea22 0%, #764ba222 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            color: #667eea;
            margin-bottom: 0.75rem;
        }

        .product-name {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .product-market {
            font-size: 0.75rem;
            color: #666;
            margin-bottom: 0.5rem;
        }

        .product-price {
            margin-bottom: 0.75rem;
        }

        .product-price strong {
            font-size: 1.1rem;
            color: #667eea;
        }

        .badge-in-list {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: #4caf50;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .list-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            border-bottom: 1px solid #eee;
        }

        .list-item:hover {
            background: #f8f9fa;
        }

        .item-info {
            flex: 1;
            min-width: 0;
        }

        .item-quantity {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .qty-btn {
            width: 24px;
            height: 24px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .qty-btn:hover {
            background: #667eea;
            color: white;
        }

        .item-quantity input {
            width: 40px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 0.25rem;
            font-size: 0.85rem;
        }

        @media (max-width: 768px) {
            .calendar-day {
                min-height: 60px;
                font-size: 0.85rem;
            }

            .products-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>

<body>

    <div id="loginWall" class="position-fixed w-100 h-100" style="z-index: 2000; top: 0; left: 0;">
        <div class="container h-100 d-flex justify-content-center align-items-center">
            <div class="card shadow-lg p-4" style="max-width: 400px; width: 100%;">
                <div class="text-center mb-4">
                    <i class="bi bi-shield-lock-fill text-primary" style="font-size: 3rem;"></i>
                    <h3 class="mt-2">MarketPlanner OS</h3>
                    <p class="text-muted">Inicia sesi√≥n para continuar</p>
                </div>
                <form id="formLogin">
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" id="loginEmail" class="form-control" required placeholder="tu@email.com">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Contrase√±a</label>
                        <input type="password" id="loginPass" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 py-2">Entrar</button>
                    <div class="text-center mt-3">
                        <a href="#" onclick="toggleAuth(true)" class="text-decoration-none">¬øNo tienes cuenta?
                            Reg√≠strate</a>
                    </div>
                </form>

                <form id="formRegistro" style="display: none;">
                    <div class="mb-3">
                        <label class="form-label">Nombre Completo</label>
                        <input type="text" id="regNombreSelf" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" id="regEmailSelf" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Contrase√±a</label>
                        <input type="password" id="regPassSelf" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-success w-100 py-2">Registrarse</button>
                    <div class="text-center mt-3">
                        <a href="#" onclick="toggleAuth(false)" class="text-decoration-none">¬øYa tienes cuenta? Inicia
                            sesi√≥n</a>
                    </div>
                    <small class="text-muted d-block mt-2 text-center">Tu cuenta deber√° ser aprobada por un
                        administrador.</small>
                </form>
            </div>
        </div>
    </div>

    <nav class="navbar navbar-dark bg-primary sticky-top">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1"><i class="bi bi-cart4"></i> MarketPlanner</span>
            <div class="d-flex align-items-center">
                <button id="btnInstalar" class="btn btn-sm btn-outline-light me-2 d-none">
                    <i class="bi bi-download"></i> Instalar App
                </button>
                <div class="text-white text-end">
                    <small>BCV: <span id="displayTasa">0.00</span> Bs</small>
                </div>
            </div>
        </div>
    </nav>

    <ul class="nav nav-tabs nav-justified bg-white shadow-sm" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="lista-tab" data-bs-toggle="tab" data-bs-target="#lista" type="button">üõí
                Lista</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="productos-tab" data-bs-toggle="tab" data-bs-target="#productos"
                type="button">üè™
                Productos</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="finanzas-tab" data-bs-toggle="tab" data-bs-target="#finanzas" type="button">üí∞
                Finanzas</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="config-tab" data-bs-toggle="tab" data-bs-target="#config" type="button">‚öôÔ∏è
                Ajustes</button>
        </li>
    </ul>

    <div class="container mt-3 tab-content" id="myTabContent">

        <div class="tab-pane fade show active" id="lista" role="tabpanel">

            <div class="search-container mb-3">
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" placeholder="Buscar producto o mercado..." id="buscador"
                        autocomplete="off">
                    <button class="btn btn-outline-primary" type="button" onclick="abrirEscanner('search')">
                        <i class="bi bi-barcode-scan"></i>
                    </button>
                </div>
                <div id="sugerenciasBusqueda" class="search-suggestions"></div>
            </div>

            <div class="card card-resumen mb-3 shadow-sm">
                <div class="card-body py-2 d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="m-0 text-primary">Total Estimado</h6>
                        <small class="text-muted">Incidencia incluida</small>
                    </div>
                    <div class="text-end">
                        <h4 class="m-0" id="totalGeneralUSD">$0.00</h4>
                        <span class="precio-bs" id="totalGeneralBS">Bs 0.00</span>
                    </div>
                </div>
            </div>

            <div id="contenedorProductos" class="list-group">
                <!-- Los productos se cargan aqu√≠ -->
            </div>

            <button class="btn btn-primary fab" data-bs-toggle="modal" data-bs-target="#modalNuevo">
                <i class="bi bi-plus-lg"></i>
            </button>
        </div>

        <div class="tab-pane fade" id="finanzas" role="tabpanel">

            <!-- Calculadora de Reparto -->
            <div class="card mb-3 shadow-sm border-0 bg-primary-soft">
                <div class="card-header border-0 pb-0 d-flex justify-content-between align-items-center"
                    style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#collapseReparto">
                    <span class="small fw-bold text-primary text-uppercase letter-spacing-1">üìä Reparto (%)</span>
                    <i class="bi bi-chevron-down text-primary"></i>
                </div>
                <div id="collapseReparto" class="collapse">
                    <div class="card-body pt-2">
                        <div class="row g-2 align-items-end mb-3">
                            <div class="col-8">
                                <label class="form-label small mb-1 opacity-75">Monto Total ($)</label>
                                <input type="number" id="montoReparto" class="form-control form-control-sm"
                                    placeholder="0.00" oninput="calcularReparto()">
                            </div>
                            <div class="col-4">
                                <button class="btn btn-sm btn-primary w-100" onclick="agregarFilaPorcentaje()">+
                                    Fila</button>
                            </div>
                        </div>
                        <div id="filasPorcentajes" class="small">
                            <div class="row g-2 mb-2 align-items-center">
                                <div class="col-5">
                                    <input type="text" class="form-control form-control-sm label-porcentaje"
                                        value="Ahorro">
                                </div>
                                <div class="col-3">
                                    <div class="input-group input-group-sm">
                                        <input type="number" class="form-control valor-porcentaje" value="20"
                                            oninput="calcularReparto()">
                                        <span class="input-group-text">%</span>
                                    </div>
                                </div>
                                <div class="col-4 text-end fw-bold text-primary">
                                    <span class="resultado-porcentaje">$0.00</span>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3 p-2 bg-white rounded-3 border d-flex justify-content-between small">
                            <span>Restante: <strong id="repartoRestante">100%</strong></span>
                            <strong id="montoRestante" class="text-primary">$0.00</strong>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Registro de Movimientos -->
            <div class="card mb-3 shadow-sm">
                <div class="card-header py-2 d-flex justify-content-between align-items-center" style="cursor: pointer;"
                    data-bs-toggle="collapse" data-bs-target="#collapseRegistro">
                    <span class="small fw-bold text-uppercase">‚ûï Registrar Movimiento</span>
                    <i class="bi bi-plus-circle-fill text-primary"></i>
                </div>
                <div id="collapseRegistro" class="collapse">
                    <div class="card-body">
                        <form id="formFinanzas" class="row g-2 small">
                            <div class="col-6">
                                <select class="form-select form-select-sm" id="finTipo"
                                    onchange="toggleCompartirDeuda()">
                                    <option value="ingreso">Ingreso (+)</option>
                                    <option value="egreso">Egreso (-)</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <input type="text" class="form-control form-control-sm" id="finCategoria"
                                    placeholder="Categor√≠a..." list="catList">
                            </div>
                            <div class="col-6">
                                <input type="text" class="form-control form-control-sm" id="finConcepto"
                                    placeholder="Concepto..." required>
                            </div>
                            <div class="col-6">
                                <input type="number" step="0.01" class="form-control form-control-sm" id="finMonto"
                                    placeholder="Monto ($)" required>
                            </div>
                            <div class="col-12">
                                <input type="date" class="form-control form-control-sm" id="finFecha" required>
                            </div>
                            <div class="col-12" id="divCompartirDeuda" style="display: none;">
                                <select class="form-select form-select-sm border-primary" id="finCompartirCon">
                                    <option value="">No compartir</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary btn-sm w-100">Guardar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <!-- CIERRE Registro Movimiento Card -->

            <!-- Asistente Cashea -->
            <div class="card mb-3 shadow-sm border-0">
                <div class="card-header py-2 d-flex justify-content-between align-items-center" style="cursor: pointer;"
                    data-bs-toggle="collapse" data-bs-target="#collapseCashea">
                    <span class="small fw-bold text-uppercase text-muted">üîµ Asistente Cashea</span>
                    <i class="bi bi-lightning-charge-fill text-primary"></i>
                </div>
                <div id="collapseCashea" class="collapse">
                    <div class="card-body">
                        <div class="row g-2 small">
                            <div class="col-12">
                                <input type="number" class="form-control form-control-sm" id="casheaMontoTotal"
                                    placeholder="Monto de la Compra ($)">
                            </div>
                            <div class="col-6">
                                <select class="form-select form-select-sm" id="casheaLinea"
                                    onchange="actualizarCuotasCashea()">
                                    <option value="cotidiana">Cotidiana</option>
                                    <option value="principal" selected>Principal</option>
                                </select>
                            </div>
                            <div class="col-6" id="contenedorCuotasPrincipal">
                                <select class="form-select form-select-sm" id="casheaCuotas">
                                    <option value="3">3 Cuotas</option>
                                    <option value="6">6 Cuotas</option>
                                    <option value="9">9 Cuotas</option>
                                </select>
                            </div>
                            <div id="resultadoCashea" class="col-12 d-none">
                                <div class="p-2 bg-primary-soft rounded-3 mt-2">
                                    <div class="d-flex justify-content-between"><span>Inicial (40%):</span> <strong
                                            id="casheaInicial">$0.00</strong></div>
                                    <div class="d-flex justify-content-between"><span>Por Cuota:</span> <strong
                                            id="casheaMontoCuota">$0.00</strong></div>
                                    <button class="btn btn-sm btn-primary w-100 mt-2 py-1" onclick="registrarCashea()"
                                        style="font-size: 0.75rem">Registrar Cuotas</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-4">
                <h6 class="small fw-bold text-uppercase text-muted letter-spacing-1 mb-3">Planificaci√≥n de Pagos</h6>
                <div class="alert bg-primary-soft border-0 py-2 d-flex justify-content-between align-items-center">
                    <span class="small opacity-75">Disponible:</span>
                    <strong class="text-primary" id="dineroDisponible">$0.00</strong>
                </div>

                <!-- Calendario de Pagos -->
                <div class="card shadow-sm mb-3">
                    <div class="calendar-header">
                        <button class="btn btn-sm btn-light" onclick="previousMonth()">
                            <i class="bi bi-chevron-left"></i>
                        </button>
                        <div class="calendar-title" id="calendarTitle">Enero 2024</div>
                        <button class="btn btn-sm btn-light" onclick="nextMonth()">
                            <i class="bi bi-chevron-right"></i>
                        </button>
                    </div>
                    <div class="calendar-grid" id="calendarGrid">
                        <!-- Generado din√°micamente -->
                    </div>
                </div>

                <ul class="list-group list-group-flush mb-5" id="listaFinanzas">
                    <!-- Din √°mico -->
                </ul>
            </div>

            <!-- Gastos Recurrentes -->
            <div class="card mb-3 shadow-sm">
                <div class="card-header py-2 d-flex justify-content-between align-items-center" style="cursor: pointer;"
                    data-bs-toggle="collapse" data-bs-target="#collapseRecurrentes">
                    <span class="small fw-bold text-uppercase">üîÅ Gastos Recurrentes</span>
                    <i class="bi bi-calendar-check text-primary"></i>
                </div>
                <div id="collapseRecurrentes" class="collapse">
                    <div class="card-body">
                        <button class="btn btn-sm btn-primary w-100 mb-3" data-bs-toggle="modal"
                            data-bs-target="#modalRecurrente">
                            <i class="bi bi-plus-circle"></i> Agregar Gasto Recurrente
                        </button>
                        <div id="listaRecurrentes" class="small">
                            <!-- Lista din√°mica de gastos recurrentes -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gastos Variables Semanales -->
            <div class="card mb-3 shadow-sm">
                <div class="card-header py-2 d-flex justify-content-between align-items-center" style="cursor: pointer;"
                    data-bs-toggle="collapse" data-bs-target="#collapseVariables">
                    <span class="small fw-bold text-uppercase">üìä Gastos Variables (Semanales)</span>
                    <i class="bi bi-cash-stack text-primary"></i>
                </div>
                <div id="collapseVariables" class="collapse">
                    <div class="card-body">
                        <div class="mb-3">
                            <select class="form-select form-select-sm mb-2" id="categoriaVariable">
                                <option value="Transporte">üöó Transporte</option>
                                <option value="Comida">üçî Comida</option>
                                <option value="Servicios">üîß Servicios</option>
                                <option value="Otros">üì¶ Otros</option>
                            </select>
                            <div class="input-group input-group-sm">
                                <input type="text" class="form-control" id="conceptoVariable"
                                    placeholder="Ej: Carrera de moto">
                                <input type="number" step="0.01" class="form-control" id="montoVariable"
                                    placeholder="$">
                                <button class="btn btn-primary" onclick="agregarGastoVariable()"><i
                                        class="bi bi-plus-lg"></i></button>
                            </div>
                        </div>
                        <div id="resumenSemanal" class="alert bg-primary-soft border-0 mb-2">
                            <div class="d-flex justify-content-between">
                                <span class="small">Total de la semana:</span>
                                <strong id="totalSemanalUSD" class="text-primary">$0.00</strong>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span class="small">En Bs:</span>
                                <strong id="totalSemanalBS" class="text-muted">Bs 0.00</strong>
                            </div>
                        </div>
                        <div id="listaVariables" class="mb-2">
                            <!-- Lista de gastos de la semana -->
                        </div>
                        <button class="btn btn-sm btn-success w-100" onclick="pagarSemana()" id="btnPagarSemana">
                            <i class="bi bi-check-circle"></i> Marcar como Pagado y Resetear
                        </button>
                    </div>
                </div>
            </div>

            <!-- Ahorros -->
            <div class="card mb-3 shadow-sm">
                <div class="card-header py-2 d-flex justify-content-between align-items-center" style="cursor: pointer;"
                    data-bs-toggle="collapse" data-bs-target="#collapseAhorros">
                    <span class="small fw-bold text-uppercase">üí∞ Ahorros</span>
                    <i class="bi bi-piggy-bank text-primary"></i>
                </div>
                <div id="collapseAhorros" class="collapse">
                    <div class="card-body">
                        <div class="alert bg-success bg-opacity-10 border-0 mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="small text-muted">Total en USD</div>
                                    <h5 class="mb-0 text-success" id="totalAhorrosUSD">$0.00</h5>
                                </div>
                                <div class="text-end">
                                    <div class="small text-muted">Total en Bs</div>
                                    <h5 class="mb-0 text-success" id="totalAhorrosBS">Bs 0.00</h5>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex gap-2 mb-3">
                            <button class="btn btn-sm btn-success flex-fill" data-bs-toggle="modal"
                                data-bs-target="#modalAhorros" onclick="prepararAhorroModal('deposito')">
                                <i class="bi bi-plus-circle"></i> Agregar Fondos
                            </button>
                            <button class="btn btn-sm btn-outline-danger flex-fill" data-bs-toggle="modal"
                                data-bs-target="#modalAhorros" onclick="prepararAhorroModal('retiro')">
                                <i class="bi bi-dash-circle"></i> Retirar Fondos
                            </button>
                        </div>
                        <div id="historialAhorros" class="small">
                            <!-- Historial de transacciones -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dashboard con Gr√°ficas -->
            <div class="card mb-3 shadow-sm">
                <div class="card-header py-2 d-flex justify-content-between align-items-center" style="cursor: pointer;"
                    data-bs-toggle="collapse" data-bs-target="#collapseDashboard">
                    <span class="small fw-bold text-uppercase">üìà Dashboard Financiero</span>
                    <i class="bi bi-graph-up text-primary"></i>
                </div>
                <div id="collapseDashboard" class="collapse">
                    <div class="card-body">
                        <!-- Resumen de M√©tricas -->
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <div class="p-2 rounded"
                                    style="background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);">
                                    <div class="small text-white opacity-75">Ingresos (Mes)</div>
                                    <h6 class="mb-0 text-white" id="statIngresosMes">$0.00</h6>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-2 rounded"
                                    style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                                    <div class="small text-white opacity-75">Gastos (Mes)</div>
                                    <h6 class="mb-0 text-white" id="statGastosMes">$0.00</h6>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-2 rounded"
                                    style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
                                    <div class="small text-dark opacity-75">Balance</div>
                                    <h6 class="mb-0 text-dark" id="statBalance">$0.00</h6>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-2 rounded"
                                    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                    <div class="small text-white opacity-75">Ahorros</div>
                                    <h6 class="mb-0 text-white" id="statAhorros">$0.00</h6>
                                </div>
                            </div>
                        </div>

                        <!-- Tabs para diferentes gr√°ficas -->
                        <ul class="nav nav-pills nav-fill mb-2 small" id="chartTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active py-1" id="tab-monthly" data-bs-toggle="tab"
                                    data-bs-target="#monthly-charts" type="button"
                                    style="font-size: 0.75rem;">Mensual</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link py-1" id="tab-weekly" data-bs-toggle="tab"
                                    data-bs-target="#weekly-charts" type="button"
                                    style="font-size: 0.75rem;">Semanal</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link py-1" id="tab-comparison" data-bs-toggle="tab"
                                    data-bs-target="#comparison-chart" type="button"
                                    style="font-size: 0.75rem;">Comparativa</button>
                            </li>
                        </ul>

                        <!-- Contenido de tabs -->
                        <div class="tab-content" id="chartTabsContent">
                            <div class="tab-pane fade show active" id="monthly-charts" role="tabpanel">
                                <canvas id="chartMensual" height="200"></canvas>
                            </div>
                            <div class="tab-pane fade" id="weekly-charts" role="tabpanel">
                                <canvas id="chartSemanal" height="200"></canvas>
                            </div>
                            <div class="tab-pane fade" id="comparison-chart" role="tabpanel">
                                <canvas id="chartComparativa" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div> <!-- FIN FINANZAS -->

        <!-- PRODUCTOS TAB -->
        <div class="tab-pane fade" id="productos" role="tabpanel">

            <!-- Filtros y B√∫squeda -->
            <div class="card mb-3 shadow-sm">
                <div class="card-body p-2">
                    <div class="row g-2">
                        <div class="col-md-5">
                            <div class="input-group input-group-sm">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control" id="searchProductCatalog"
                                    placeholder="Buscar producto...">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <select class="form-select form-select-sm" id="filterMercado">
                                <option value="">Todos los mercados</option>
                                <!-- Se llena din√°micamente -->
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-sm btn-outline-secondary w-100" onclick="clearProductFilters()">
                                <i class="bi bi-x-circle"></i> Limpiar filtros
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Layout principal: Grid productos + Lista de compra -->
            <div class="row">
                <!-- Grid de Productos -->
                <div class="col-lg-8 col-md-7">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0"><i class="bi bi-grid-3x3-gap"></i> Cat√°logo de Productos</h6>
                        <span class="badge bg-primary" id="catalogCount">0 productos</span>
                    </div>
                    <div id="productsGrid" class="products-grid">
                        <!-- Cards generadas din√°micamente -->
                    </div>
                </div>

                <!-- Lista de Compra -->
                <div class="col-lg-4 col-md-5">
                    <div class="shopping-list-container sticky-top" style="top: 20px;">
                        <div class="card shadow-sm">
                            <div
                                class="card-header bg-primary text-white py-2 d-flex justify-content-between align-items-center">
                                <span><i class="bi bi-cart-check"></i> Mi Lista de Compra</span>
                                <span class="badge bg-white text-primary" id="listCountBadge">0</span>
                            </div>
                            <div class="card-body p-2" style="max-height: 500px; overflow-y: auto;">
                                <div id="shoppingListItems">
                                    <p class="text-muted text-center small my-4">
                                        <i class="bi bi-cart-x fs-3 d-block mb-2"></i>
                                        Tu lista est√° vac√≠a
                                    </p>
                                </div>
                            </div>
                            <div class="card-footer bg-light">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <strong>Total estimado:</strong>
                                    <div class="text-end">
                                        <div class="text-primary fw-bold" id="listTotalUSD">$0.00</div>
                                        <small class="text-muted" id="listTotalBS">Bs 0.00</small>
                                    </div>
                                </div>
                                <div class="d-grid gap-1">
                                    <button class="btn btn-sm btn-success" onclick="exportShoppingList()"
                                        id="btnExportList" disabled>
                                        <i class="bi bi-share"></i> Compartir Lista
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="clearShoppingList()">
                                        <i class="bi bi-trash"></i> Limpiar Lista
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Historial de listas -->
                        <div class="card shadow-sm mt-3">
                            <div class="card-header py-2" style="cursor: pointer;" data-bs-toggle="collapse"
                                data-bs-target="#collapseHistory">
                                <small class="fw-bold"><i class="bi bi-clock-history"></i> Historial de Listas</small>
                            </div>
                            <div class="collapse" id="collapseHistory">
                                <div class="card-body p-2" style="max-height: 200px; overflow-y: auto;">
                                    <div id="listHistory" class="small">
                                        <p class="text-muted text-center my-2">Sin historial</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div> <!-- FIN PRODUCTOS -->

        <div class="tab-pane fade" id="config" role="tabpanel">
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header py-2 bg-white">
                    <span class="small fw-bold text-uppercase text-muted"><i class="bi bi-shield-lock"></i> Seguridad y
                        Privacidad</span>
                </div>
                <div class="card-body p-3">
                    <div id="seccionAdmin" class="d-none mb-3 p-3 bg-light rounded-4 border-0">
                        <h6 class="small fw-bold mb-3 text-primary text-uppercase">Gesti√≥n de Usuarios</h6>
                        <div class="table-responsive mb-3">
                            <table class="table table-sm table-borderless small align-middle mb-0">
                                <tbody id="tablaUsuariosAdmin"></tbody>
                            </table>
                        </div>
                        <button class="btn btn-sm btn-outline-primary w-100 py-1" style="font-size: 0.75rem"
                            data-bs-toggle="collapse" data-bs-target="#collapseAddUser">
                            + Registrar Nuevo Usuario
                        </button>
                        <div id="collapseAddUser" class="collapse mt-3">
                            <form id="formNuevoUsuario" class="row g-1">
                                <div class="col-6"><input type="text" id="regNombre"
                                        class="form-control form-control-sm" placeholder="Nombre"></div>
                                <div class="col-6"><input type="email" id="regEmail"
                                        class="form-control form-control-sm" placeholder="Email"></div>
                                <div class="col-6"><input type="password" id="regPass"
                                        class="form-control form-control-sm" placeholder="Pass"></div>
                                <div class="col-6"><button type="submit"
                                        class="btn btn-primary btn-sm w-100">Crear</button></div>
                            </form>
                        </div>
                    </div>

                    <h6 class="small fw-bold mb-2 text-muted text-uppercase" style="font-size: 0.7rem">Compartir mis
                        datos con:</h6>
                    <div id="listaUsuariosCompartir" class="list-group list-group-flush small mb-4">
                        <div class="text-center p-3 opacity-50">Cargando lista de usuarios...</div>
                    </div>

                    <button class="btn btn-outline-danger btn-sm w-100 py-2 rounded-3" onclick="cerrarSesion()">
                        <i class="bi bi-box-arrow-right me-1"></i> Cerrar Sesi√≥n
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scanner Modal -->
    <div class="modal fade" id="modalScanner" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 overflow-hidden" style="border-radius: 20px;">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold text-primary">Escaneando...</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                        onclick="detenerEscanner()"></button>
                </div>
                <div class="modal-body p-0">
                    <div id="reader" style="width: 100%; min-height: 300px;"></div>
                </div>
                <div class="modal-footer border-0 pt-0 justify-content-center">
                    <small class="text-muted">Apunta al c√≥digo de barras del producto</small>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalNuevo" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nuevo Producto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formProducto">
                        <div class="mb-2">
                            <label>Producto</label>
                            <input type="text" class="form-control" required>
                        </div>
                        <div class="row mb-2">
                            <div class="col">
                                <label>Precio ($)</label>
                                <input type="number" step="0.01" class="form-control" required>
                            </div>
                            <div class="col">
                                <label>Cantidad</label>
                                <input type="number" class="form-control" value="1" required>
                            </div>
                        </div>
                        <div class="mb-2">
                            <label>Mercado</label>
                            <input type="text" class="form-control" list="mercadosList">
                        </div>
                        <div class="mb-2">
                            <label>C√≥digo de Barras (Opcional)</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="prodBarcode"
                                    placeholder="Escanear o ingresar...">
                                <button class="btn btn-outline-primary" type="button" onclick="abrirEscanner('form')">
                                    <i class="bi bi-upc-scan"></i>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary w-100">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Gasto Recurrente -->
    <div class="modal fade" id="modalRecurrente" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Agregar Gasto Recurrente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formRecurrente">
                        <div class="mb-2">
                            <label class="form-label small">Nombre del Gasto</label>
                            <input type="text" class="form-control form-control-sm" id="recNombre"
                                placeholder="Ej: Renta de Internet" required>
                        </div>
                        <div class="mb-2">
                            <label class="form-label small">Monto (USD)</label>
                            <input type="number" step="0.01" class="form-control form-control-sm" id="recMonto"
                                placeholder="0.00" required oninput="actualizarConversionRecurrente()">
                            <small class="text-muted">‚âà Bs <span id="recConversionBS">0.00</span></small>
                        </div>
                        <div class="mb-2">
                            <label class="form-label small">Frecuencia</label>
                            <select class="form-select form-select-sm" id="recFrecuencia" required
                                onchange="actualizarDiaVencimiento()">
                                <option value="monthly">Mensual</option>
                                <option value="weekly">Semanal</option>
                            </select>
                        </div>
                        <div class="mb-2" id="divDiaVencimiento">
                            <label class="form-label small">D√≠a de Vencimiento</label>
                            <input type="number" class="form-control form-control-sm" id="recDia" min="1" max="31"
                                placeholder="D√≠a del mes" required>
                            <small class="text-muted" id="helperDia">D√≠a del mes (1-31)</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-sm btn-primary"
                        onclick="guardarGastoRecurrente()">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Ahorros -->
    <div class="modal fade" id="modalAhorros" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="tituloModalAhorros">Transacci√≥n de Ahorros</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formAhorros">
                        <input type="hidden" id="ahorroTipo" value="deposito">
                        <div class="mb-2">
                            <label class="form-label small">Moneda</label>
                            <select class="form-select form-select-sm" id="ahorroMoneda"
                                onchange="actualizarConversionAhorro()">
                                <option value="USD">USD üíµ</option>
                                <option value="BS">Bs üí∞</option>
                            </select>
                        </div>
                        <div class="mb-2">
                            <label class="form-label small">Monto</label>
                            <input type="number" step="0.01" class="form-control form-control-sm" id="ahorroMonto"
                                placeholder="0.00" required oninput="actualizarConversionAhorro()">
                            <small class="text-muted" id="ahorroConversion"></small>
                        </div>
                        <div class="mb-2">
                            <label class="form-label small">Nota (Opcional)</label>
                            <input type="text" class="form-control form-control-sm" id="ahorroNota"
                                placeholder="Ej: Ahorro mensual">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-sm btn-success" id="btnGuardarAhorro"
                        onclick="guardarAhorro()">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx1J1hxN5wb6evXxenQTcfvZZ0htOz1z2_s4fnrk-L0nck84iCBXdMw5OCCMACTj0ec/exec";
        let currentUser = null;
        let tasaBCV = 0;
        let html5QrCode = null;

        // --- FUNCIONES DE ESCANEO ---
        async function abrirEscanner(contexto) {
            const modal = new bootstrap.Modal(document.getElementById('modalScanner'));
            modal.show();

            html5QrCode = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 250, height: 150 } };

            try {
                await html5QrCode.start(
                    { facingMode: "environment" },
                    config,
                    async (decodedText) => {
                        console.log("Barcode detected:", decodedText);
                        detenerEscanner();
                        bootstrap.Modal.getInstance(document.getElementById('modalScanner')).hide();

                        if (contexto === 'search') {
                            document.getElementById('buscador').value = decodedText;
                            document.getElementById('buscador').dispatchEvent(new Event('input'));
                        } else if (contexto === 'form') {
                            document.getElementById('prodBarcode').value = decodedText;
                        }
                    }
                );
            } catch (err) {
                console.error("Error starting scanner:", err);
                alert("No se pudo iniciar el esc√°ner. Aseg√∫rate de dar permisos de c√°mara.");
                bootstrap.Modal.getInstance(document.getElementById('modalScanner')).hide();
            }
        }

        async function detenerEscanner() {
            if (html5QrCode) {
                try {
                    await html5QrCode.stop();
                    await html5QrCode.clear();
                    html5QrCode = null;
                } catch (err) {
                    console.warn("Error stopping scanner:", err);
                }
            }
        }

        // --- FUNCI√ìN PARA ENVIAR DATOS AL BACKEND ---
        async function llamarBackend(accion, payload = {}) {
            const url = SCRIPT_URL;
            const data = { action: accion, ...payload };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(data)
                });
                if (!response.ok) throw new Error("Error en la red");
                return await response.json();
            } catch (err) {
                console.warn("Error backend:", err);
                if (!navigator.onLine) {
                    alert("‚ö†Ô∏è Est√°s offline. Algunas funciones requieren internet.");
                }
                throw err;
            }
        }

        // --- L√ìGICA DE LOGIN ---
        document.getElementById('formLogin').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPass').value;

            try {
                const data = await llamarBackend('login', { email, password: pass });
                if (data.success) {
                    if (data.user.status === 'Pending') {
                        alert("‚è≥ Tu cuenta a√∫n no ha sido aprobada por un administrador.");
                        return;
                    }
                    if (data.user.status === 'Disabled') {
                        alert("üö´ Tu cuenta ha sido desactivada.");
                        return;
                    }
                    currentUser = data.user;

                    // --- PERSISTENCIA DE SESI√ìN ---
                    localStorage.setItem('plannerUser', JSON.stringify({
                        user: currentUser,
                        timestamp: new Date().getTime()
                    }));

                    document.getElementById('loginWall').classList.add('d-none'); // Quita el muro
                    cargarDatosIniciales();
                } else {
                    alert("Error: " + data.message);
                }
            } catch (err) {
                console.error(err);
                alert("Error de conexi√≥n con el servidor.");
            }
        });

        function toggleAuth(isRegister) {
            document.getElementById('formLogin').style.display = isRegister ? 'none' : 'block';
            document.getElementById('formRegistro').style.display = isRegister ? 'block' : 'none';
            document.querySelector('#loginWall h3').innerText = isRegister ? 'Reg√≠strate' : 'MarketPlanner OS';
        }

        document.getElementById('formRegistro').addEventListener('submit', async (e) => {
            e.preventDefault();
            const nombre = document.getElementById('regNombreSelf').value;
            const email = document.getElementById('regEmailSelf').value;
            const pass = document.getElementById('regPassSelf').value;

            try {
                // El backend crearUsuario deber√≠a verificar si ya existe
                const res = await llamarBackend('crearUsuario', {
                    payload: { nombre, email, pass, rol: 'Usuario', status: 'Pending' }
                });

                if (res.success) {
                    alert("‚úÖ Registro solicitado con √©xito. Espera a que un administrador apruebe tu acceso.");
                    toggleAuth(false);
                    e.target.reset();
                } else {
                    alert("‚ùå Error: " + res.message);
                }
            } catch (err) {
                alert("Error al intentar registrar.");
            }
        });

        // --- SISTEMA DE NOTIFICACIONES ---
        async function verificarNotificaciones(finanzas) {
            if (!("Notification" in window)) return;

            if (Notification.permission === "default") {
                await Notification.requestPermission();
            }

            if (Notification.permission === "granted") {
                const hoy = new Date();

                // 1. Buscar deudas que venzan en los pr√≥ximos 3 d√≠as
                const deudasProntas = finanzas.filter(f => {
                    const fecha = new Date(f[3]);
                    const difDias = Math.ceil((fecha - hoy) / (1000 * 60 * 60 * 24));
                    return f[0].toLowerCase() === 'egreso' && difDias >= 0 && difDias <= 3;
                });

                if (deudasProntas.length > 0) {
                    const nombresDeudas = deudasProntas.map(f => f[1]).join(", ");
                    new Notification("MarketPlanner: Pagos Pr√≥ximos", {
                        body: `Vencen pronto: ${nombresDeudas}. Revisa tu flujo de caja.`,
                        icon: 'app_icon_marketplanner_1766378047051.png'
                    });
                }

                // 2. Verificar gastos recurrentes pr√≥ximos
                const stored = localStorage.getItem('gastosRecurrentes_' + currentUser.id);
                if (stored) {
                    const gastosRec = JSON.parse(stored);
                    const recurrentesProntos = gastosRec.filter(g => {
                        const fechaVence = new Date(g.proximoPago);
                        const difDias = Math.ceil((fechaVence - hoy) / (1000 * 60 * 60 * 24));
                        return difDias >= 0 && difDias <= 3;
                    });

                    if (recurrentesProntos.length > 0) {
                        const nombresRec = recurrentesProntos.map(g => `${g.nombre} ($${g.monto.toFixed(2)})`).join(", ");
                        new Notification("MarketPlanner: Gastos Recurrentes", {
                            body: `Pr√≥ximos a vencer: ${nombresRec}`,
                            icon: 'app_icon_marketplanner_1766378047051.png',
                            tag: 'recurring-expenses'
                        });
                    }
                }
            }
        }

        // --- CARGAR DATOS (PRODUCTOS Y FINANZAS) ---
        async function cargarDatosIniciales() {
            try {
                const data = await llamarBackend('getInitialData', { userId: currentUser.id });
                if (!data.success) throw new Error(data.message);

                tasaBCV = data.tasa;
                document.getElementById('displayTasa').innerText = tasaBCV.toFixed(2);

                renderizarProductos(data.products);
                renderizarFinanzas(data.finanzas);

                // Cargar nuevas funcionalidades
                cargarGastosRecurrentes();
                cargarGastosVariables();
                cargarAhorros();
                cargarDashboard();

                verificarNotificaciones(data.finanzas);
                cargarListaCompartir();
                populateSharedWith();

                // Mostrar secci√≥n admin si aplica
                if (currentUser.rol === 'Admin') {
                    document.getElementById('seccionAdmin').classList.remove('d-none');
                    cargarUsuariosAdmin();
                }
            } catch (err) {
                console.error("Error al cargar datos:", err);
            }
        }

        async function cargarUsuariosAdmin() {
            const res = await llamarBackend('getAllUsers'); // Usamos el mismo endpoint pero adaptamos vista
            const tabla = document.getElementById('tablaUsuariosAdmin');
            if (!tabla) return;
            tabla.innerHTML = "";

            if (res.usuarios) {
                res.usuarios.forEach(u => {
                    const isPending = u.status === 'Pending';
                    const isDisabled = u.status === 'Disabled';

                    tabla.innerHTML += `
                                <tr>
                                    <td>${u.nombre}<br><small class="text-muted">${u.email}</small></td>
                                    <td>
                                        <span class="badge ${isPending ? 'bg-warning text-dark' : (isDisabled ? 'bg-danger' : 'bg-success')}">
                                            ${u.status || 'Active'}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="d-flex gap-1">
                                            ${isPending ?
                            `<button class="btn btn-sm btn-success p-1" onclick="cambiarStatus(${u.id}, 'Active')"><i class="bi bi-check-lg"></i></button>` :
                            `<button class="btn btn-sm btn-outline-danger p-1" onclick="cambiarStatus(${u.id}, 'Disabled')"><i class="bi bi-slash-circle"></i></button>`
                        }
                                            <button class="btn btn-sm btn-danger p-1" onclick="eliminarUsuario(${u.id})"><i class="bi bi-trash"></i></button>
                                        </div>
                                    </td>
                                </tr>
                            `;
                });
            }
        }

        async function cambiarStatus(targetId, status) {
            if (!confirm(`¬øCambiar estado a ${status}?`)) return;
            const res = await llamarBackend('updateUserStatus', { targetUserId: targetId, status, adminId: currentUser.id });
            if (res.success) {
                alert("Estado actualizado");
                cargarUsuariosAdmin();
            }
        }

        async function eliminarUsuario(targetId) {
            if (!confirm("‚ö†Ô∏è ¬øSeguro que deseas eliminar este usuario?")) return;
            const res = await llamarBackend('deleteUser', { targetUserId: targetId, adminId: currentUser.id });
            if (res.success) {
                alert("Usuario eliminado");
                cargarUsuariosAdmin();
            }
        }

        // --- RENDERIZADO DE PRODUCTOS (CON B√öSQUEDA) ---
        let productosCache = []; // Para filtrar localmente

        function renderizarProductos(productos) {
            productosCache = productos;
            const contenedor = document.getElementById('contenedorProductos');
            const termino = document.getElementById('buscador').value.toLowerCase();

            contenedor.innerHTML = "";
            let totalUSD = 0;

            productos.forEach(p => {
                // p[1]=nombre, p[4]=mercado, p[6]=barcode
                const coincide = p[1].toLowerCase().includes(termino) ||
                    p[4].toLowerCase().includes(termino) ||
                    (p[6] && p[6].toString().includes(termino));
                if (!coincide) return;

                const subtotal = p[2] * p[3];
                totalUSD += subtotal;

                contenedor.innerHTML += `
                    <div class="list-group-item d-flex justify-content-between align-items-start">
                        <div class="ms-2 me-auto">
                            <div class="fw-bold">${p[1]} <span class="badge bg-info">${p[5] || 'General'}</span></div>
                            <small class="text-muted">üìç ${p[4]}</small><br>
                            <small>${p[2]} x $${p[3]}</small>
                        </div>
                        <div class="text-end">
                            <span class="fw-bold text-primary">$${subtotal.toFixed(2)}</span><br>
                            <small class="precio-bs">Bs ${(subtotal * tasaBCV).toFixed(2)}</small>
                            <div class="mt-1">
                                <button class="btn btn-sm btn-outline-secondary py-0 px-1" onclick="prepararEdicion(${p[0]})"><i class="bi bi-pencil small"></i></button>
                                <button class="btn btn-sm btn-outline-danger py-0 px-1" onclick="eliminarProducto(${p[0]})"><i class="bi bi-trash small"></i></button>
                            </div>
                        </div>
                    </div>
                `;
            });

            document.getElementById('totalGeneralUSD').innerText = `$${totalUSD.toFixed(2)}`;
            document.getElementById('totalGeneralBS').innerText = `Bs ${(totalUSD * tasaBCV).toFixed(2)}`;
        }

        // Evento de b√∫squeda con sugerencias
        const buscador = document.getElementById('buscador');
        const sugerenciasContenedor = document.getElementById('sugerenciasBusqueda');

        buscador.addEventListener('input', async () => {
            const termino = buscador.value.toLowerCase().trim();

            if (termino.length < 2) {
                sugerenciasContenedor.style.display = 'none';
                renderizarProductos(productosCache);
                return;
            }

            // Filtrar productos que coincidan para las sugerencias (incluye barcode)
            const coincidencias = productosCache.filter(p =>
                p[1].toLowerCase().includes(termino) ||
                p[4].toLowerCase().includes(termino) ||
                (p[6] && p[6].toString().includes(termino))
            ).sort((a, b) => a[3] - b[3]);

            if (coincidencias.length > 0) {
                sugerenciasContenedor.innerHTML = coincidencias.map(p => `
                    <div class="suggestion-item d-flex justify-content-between align-items-center" onclick="seleccionarSugerencia('${p[1]}')">
                        <div>
                            <div class="fw-bold">${p[1]}</div>
                            <small class="text-muted"><i class="bi bi-shop"></i> ${p[4]}</small>
                        </div>
                        <div class="text-end">
                            <span class="suggestion-price">$${p[3].toFixed(2)}</span><br>
                            <small class="text-muted" style="font-size: 0.75rem;">Bs ${(p[3] * tasaBCV).toFixed(2)}</small>
                        </div>
                    </div>
                `).join('');
                sugerenciasContenedor.style.display = 'block';
            } else {
                sugerenciasContenedor.style.display = 'none';
                // Si parece barcode y no hay local, buscar global
                if (/^\d{8,}$/.test(termino)) {
                    buscarBarcodeGlobal(termino);
                }
            }

            renderizarProductos(productosCache);
        });

        async function buscarBarcodeGlobal(barcode) {
            try {
                // Buscamos en el historial por barcode
                const res = await llamarBackend('getPriceHistory', { barcode: barcode });
                if (res.success && res.history && res.history.length > 0) {
                    sugerenciasContenedor.innerHTML = `<div class="p-2 small fw-bold text-primary border-bottom">Encontrado en Historial:</div>` +
                        res.history.map(h => `
                        <div class="suggestion-item d-flex justify-content-between align-items-center" 
                             onclick="prepararNuevoDesdeHistorial('${h.nombre}', ${h.precio}, '${h.mercado}', '${barcode}')">
                            <div>
                                <div class="fw-bold">${h.nombre}</div>
                                <small class="text-muted"><i class="bi bi-shop"></i> ${h.mercado}</small>
                            </div>
                            <div class="text-end">
                                <span class="suggestion-price">$${h.precio.toFixed(2)}</span><br>
                                <button class="btn btn-sm btn-primary py-0 px-2 mt-1" style="font-size: 0.7rem;">+ Agregar</button>
                            </div>
                        </div>
                    `).join('');
                    sugerenciasContenedor.style.display = 'block';
                }
            } catch (err) {
                console.warn("Error global search:", err);
            }
        }

        window.prepararNuevoDesdeHistorial = (nombre, precio, mercado, barcode) => {
            currentEditId = null;
            document.querySelector('#modalNuevo .modal-title').innerText = "Agregar desde Historial";

            const inputs = document.getElementById('formProducto').elements;
            inputs[0].value = nombre;
            inputs[1].value = precio;
            inputs[2].value = 1;
            inputs[3].value = mercado;
            document.getElementById('prodBarcode').value = barcode;

            sugerenciasContenedor.style.display = 'none';
            bootstrap.Modal.getOrCreateInstance(document.getElementById('modalNuevo')).show();
        };

        function seleccionarSugerencia(nombre) {
            buscador.value = nombre;
            sugerenciasContenedor.style.display = 'none';
            renderizarProductos(productosCache);
        }

        // Cerrar sugerencias al hacer clic fuera
        document.addEventListener('click', (e) => {
            if (!buscador.contains(e.target) && !sugerenciasContenedor.contains(e.target)) {
                sugerenciasContenedor.style.display = 'none';
            }
        });

        // --- MANEJO DE FORMULARIO DE PRODUCTO ---
        document.getElementById('formProducto').addEventListener('submit', async (e) => {
            e.preventDefault();
            const inputs = e.target.elements;

            // Seguridad: Validaci√≥n b√°sica antes de enviar
            const nombre = inputs[0].value.trim();
            const precio = parseFloat(inputs[1].value);
            const cantidad = parseInt(inputs[2].value);
            const mercado = inputs[3].value.trim();
            const barcode = document.getElementById('prodBarcode').value.trim();

            if (!nombre || isNaN(precio) || cantidad <= 0) {
                alert("Por favor, completa los campos correctamente.");
                return;
            }

            const payload = {
                userId: currentUser.id,
                nombre,
                precio,
                cantidad,
                mercado,
                barcode
            };

            try {
                const action = currentEditId ? 'updateProduct' : 'saveProduct';
                // Si es nuevo y hay barcode, usarlo como ID
                const finalId = currentEditId || (barcode ? barcode : null);
                const payloadFinal = finalId ? { id: finalId, payload } : { payload };

                const res = await llamarBackend(action, { ...payloadFinal, userId: currentUser.id });
                if (res.success) {
                    bootstrap.Modal.getInstance(document.getElementById('modalNuevo')).hide();
                    e.target.reset();
                    currentEditId = null;
                    document.querySelector('#modalNuevo .modal-title').innerText = "Nuevo Producto";
                    cargarDatosIniciales();
                } else {
                    alert("Error servidor: " + res.message);
                }
            } catch (err) {
                console.error(err);
                alert("Error cr√≠tico al procesar producto");
            }
        });

        let currentEditId = null;

        function prepararEdicion(id) {
            const p = productosCache.find(prod => prod[0] == id);
            if (!p) return;

            currentEditId = id;
            document.querySelector('#modalNuevo .modal-title').innerText = "Editar Producto";

            const inputs = document.getElementById('formProducto').elements;
            inputs[0].value = p[1]; // nombre
            inputs[1].value = p[3]; // precio
            inputs[2].value = p[2]; // cantidad
            inputs[3].value = p[4]; // mercado
            document.getElementById('prodBarcode').value = p[6] || '';

            bootstrap.Modal.getOrCreateInstance(document.getElementById('modalNuevo')).show();
        }

        async function eliminarProducto(id) {
            if (!confirm("¬øSeguro que deseas eliminar este producto?")) return;
            try {
                const res = await llamarBackend('deleteProduct', { id, userId: currentUser.id });
                if (res.success) {
                    cargarDatosIniciales();
                } else {
                    alert("No se pudo eliminar: " + res.message);
                }
            } catch (err) {
                console.error(err);
            }
        }

        // --- COMPARATIVA DE PRECIOS ---
        document.querySelector('#formProducto input[type="text"]').addEventListener('blur', async (e) => {
            const nombre = e.target.value.trim();
            if (nombre.length < 3) return;

            try {
                const res = await llamarBackend('getPriceHistory', { nombreProducto: nombre });
                if (res.success && res.history.length > 0) {
                    mostrarComparativa(res.history);
                }
            } catch (err) {
                console.warn("Error historial:", err);
            }
        });

        function mostrarComparativa(historial) {
            // Agrupar por mercado y quedarnos con el √∫ltimo precio
            const mercados = {};
            historial.forEach(h => {
                mercados[h.mercado] = h.precio;
            });

            // Encontrar el precio m√°s bajo
            const precios = Object.values(mercados);
            const minPrecio = Math.min(...precios);

            let html = '<div class="mt-2 small border rounded p-2 bg-light"><strong><i class="bi bi-info-circle"></i> Comparativa de Mercados:</strong><br>';
            for (const [mer, pre] of Object.entries(mercados)) {
                const esMejor = pre === minPrecio;
                html += `<div class="d-flex justify-content-between ${esMejor ? 'text-success fw-bold' : ''}">
                            <span>${mer}:</span>
                            <span>$${pre.toFixed(2)} ${esMejor ? 'üöÄ' : ''}</span>
                         </div>`;
            }
            if (precios.length > 1) {
                html += `<div class="mt-1 text-muted text-center" style="font-size: 0.8em;">* Basado en tus compras anteriores</div>`;
            }
            html += '</div>';

            const existing = document.getElementById('historialContenedor');
            if (existing) existing.remove();

            const div = document.createElement('div');
            div.id = 'historialContenedor';
            div.innerHTML = html;
            document.getElementById('formProducto').appendChild(div);
        }

        // Vincular bot√≥n guardar del modal
        document.querySelector('#modalNuevo .btn-primary').addEventListener('click', () => {
            document.getElementById('formProducto').requestSubmit();
        });

        // --- L√ìGICA ASISTENTE CASHEA ---
        const inputCasheaMonto = document.getElementById('casheaMontoTotal');
        const selectLinea = document.getElementById('casheaLinea');
        const selectCuotas = document.getElementById('casheaCuotas');
        const resCashea = document.getElementById('resultadoCashea');

        function actualizarCuotasCashea() {
            const linea = selectLinea.value;
            const monto = parseFloat(inputCasheaMonto.value) || 0;
            const contCuotasPrin = document.getElementById('contenedorCuotasPrincipal');

            contCuotasPrin.classList.toggle('d-none', linea === 'cotidiana');

            if (monto > 0) {
                resCashea.classList.remove('d-none');
                const inicial = monto * 0.40; // Pago inicial est√°ndar 40%
                const restante = monto - inicial;
                const nCuotas = linea === 'cotidiana' ? 1 : parseInt(selectCuotas.value);
                const montoCuota = restante / nCuotas;

                document.getElementById('casheaInicial').innerText = `$${inicial.toFixed(2)}`;
                document.getElementById('casheaMontoCuota').innerText = `$${montoCuota.toFixed(2)}`;
            } else {
                resCashea.classList.add('d-none');
            }
        }

        [inputCasheaMonto, selectLinea, selectCuotas].forEach(el => {
            el.addEventListener('input', actualizarCuotasCashea);
        });

        async function registrarCashea() {
            const monto = parseFloat(inputCasheaMonto.value);
            const linea = selectLinea.value;
            const nCuotas = linea === 'cotidiana' ? 1 : parseInt(selectCuotas.value);
            const inicial = monto * 0.40;
            const montoCuota = (monto - inicial) / nCuotas;

            if (!confirm(`¬øRegistrar pago inicial de $${inicial.toFixed(2)} y ${nCuotas} cuotas de $${montoCuota.toFixed(2)}?`)) return;

            // 1. Registrar pago inicial (hoy)
            await llamarBackend('saveFinance', {
                payload: {
                    tipo: 'egreso',
                    nombre: 'Cashea - Inicial',
                    monto: inicial,
                    fecha: new Date().toISOString(),
                    ownerId: currentUser.id,
                    sharedWith: document.getElementById('finCompartirCon').value || null
                }
            });

            // 2. Registrar cuotas futuras
            const fechaBase = new Date(); // Podr√≠a ser una fecha seleccionada en el futuro
            for (let i = 1; i <= nCuotas; i++) {
                const fechaCuota = new Date(fechaBase);
                fechaCuota.setDate(fechaBase.getDate() + (i * 14)); // Intervalos exactos de 14 d√≠as

                await llamarBackend('saveFinance', {
                    payload: {
                        tipo: 'egreso',
                        nombre: `Cashea - Cuota ${i}/${nCuotas} (${linea})`,
                        monto: montoCuota,
                        fecha: fechaCuota.toISOString(),
                        ownerId: currentUser.id,
                        sharedWith: document.getElementById('finCompartirCon').value || null
                    }
                });
            }

            alert("Plan Cashea registrado con √©xito");
            cargarDatosIniciales();
        }

        // --- CALCULADORA DE REPARTO POR PORCENTAJES ---
        function agregarFilaPorcentaje() {
            const contenedor = document.getElementById('filasPorcentajes');
            const div = document.createElement('div');
            div.className = 'row g-2 mb-2 align-items-center';
            div.innerHTML = `
                <div class="col-5">
                    <input type="text" class="form-control form-control-sm label-porcentaje" placeholder="Etiqueta">
                </div>
                <div class="col-3">
                    <div class="input-group input-group-sm">
                        <input type="number" class="form-control valor-porcentaje" value="0" oninput="calcularReparto()">
                        <span class="input-group-text">%</span>
                    </div>
                </div>
                <div class="col-4 text-end d-flex align-items-center justify-content-end">
                    <strong class="resultado-porcentaje me-2">$0.00</strong>
                    <button class="btn btn-sm btn-outline-danger border-0 py-0 px-1" onclick="this.parentElement.parentElement.remove(); calcularReparto()">&times;</button>
                </div>
            `;
            contenedor.appendChild(div);
            calcularReparto();
        }

        function calcularReparto() {
            const monto = parseFloat(document.getElementById('montoReparto').value) || 0;
            const filas = document.querySelectorAll('#filasPorcentajes .row');
            let porcetajeTotal = 0;

            filas.forEach(fila => {
                const porc = parseFloat(fila.querySelector('.valor-porcentaje').value) || 0;
                porcetajeTotal += porc;
                const subtotal = monto * (porc / 100);
                fila.querySelector('.resultado-porcentaje').innerText = `$${subtotal.toFixed(2)}`;
            });

            const restPorc = 100 - porcetajeTotal;
            const restMonto = monto * (restPorc / 100);

            const displayRestPorc = document.getElementById('repartoRestante');
            displayRestPorc.innerText = `${restPorc}%`;
            displayRestPorc.className = restPorc < 0 ? 'text-danger' : 'text-dark';

            document.getElementById('montoRestante').innerText = `$${restMonto.toFixed(2)}`;
        }

        // --- MANEJO DE FORMULARIO DE FINANZAS ---
        document.getElementById('formFinanzas').addEventListener('submit', async (e) => {
            e.preventDefault();
            const tipo = document.getElementById('finTipo').value;
            const cat = document.getElementById('finCategoria').value;
            const conc = document.getElementById('finConcepto').value;
            const monto = parseFloat(document.getElementById('finMonto').value);
            const fecha = document.getElementById('finFecha').value;

            const payload = {
                tipo,
                nombre: `${cat ? '[' + cat + '] ' : ''}${conc}`,
                monto,
                fecha: new Date(fecha).toISOString(),
                ownerId: currentUser.id,
                sharedWith: document.getElementById('finCompartirCon').value || null
            };

            try {
                const res = await llamarBackend('saveFinance', { payload });
                if (res.success) {
                    alert("Movimiento registrado");
                    e.target.reset();
                    cargarDatosIniciales();
                } else {
                    alert("Error: " + res.message);
                }
            } catch (err) {
                console.error(err);
            }
        });

        function renderizarFinanzas(finanzas) {
            const lista = document.getElementById('listaFinanzas');
            const displayDisponible = document.getElementById('dineroDisponible');
            lista.innerHTML = "";

            let totalIngresos = 0;
            let totalDeudas = 0;

            const hoy = new Date();
            hoy.setHours(0, 0, 0, 0);

            // Ordenar por fecha
            finanzas.sort((a, b) => new Date(a[3]) - new Date(b[3]));

            finanzas.forEach(f => {
                const monto = parseFloat(f[2]);
                const esIngreso = f[0].toLowerCase() === 'ingreso';
                const fechaVence = new Date(f[3]);
                const fechaFormateada = f[3] ? fechaVence.toLocaleDateString() : 'S/F';

                if (esIngreso) totalIngresos += monto;
                else totalDeudas += monto;

                // Sugerencia: Estado visual (Vencido, Pr√≥ximo, Pagado)
                let estadoBadge = "";
                if (!esIngreso) {
                    if (fechaVence < hoy) estadoBadge = '<span class="badge bg-danger ms-1">Vencido</span>';
                    else if ((fechaVence - hoy) / (1000 * 60 * 60 * 24) <= 3) estadoBadge = '<span class="badge bg-warning text-dark ms-1">Pronto</span>';

                    // Indicador de compartido
                    if (f[5] || f.shared) { // f[5] es donde solemos poner el sharedWith en arrays
                        estadoBadge += ' <span class="badge bg-info ms-1"><i class="bi bi-people-fill"></i> Compartido</span>';
                    }
                }

                lista.innerHTML += `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${f[1]}</strong> ${estadoBadge}<br>
                            <small class="text-muted"><i class="bi bi-calendar"></i> ${fechaFormateada}</small>
                        </div>
                        <div class="text-end">
                            <span class="fw-bold ${esIngreso ? 'text-success' : 'text-danger'}">
                                ${esIngreso ? '+' : '-'}$${monto.toFixed(2)}
                            </span><br>
                            <small class="text-muted" style="font-size: 0.75rem;">Bs ${(monto * tasaBCV).toFixed(2)}</small>
                        </div>
                    </li>
                `;
            });

            const disponible = totalIngresos - totalDeudas;
            displayDisponible.innerText = `$${disponible.toFixed(2)} | Bs ${(disponible * tasaBCV).toFixed(2)}`;
            displayDisponible.className = disponible >= 0 ? "text-success fw-bold" : "text-danger fw-bold";
        }

        // --- REGISTRAR NUEVO USUARIO ---
        document.getElementById('formNuevoUsuario').addEventListener('submit', async (e) => {
            e.preventDefault();
            const payload = {
                nombre: document.getElementById('regNombre').value,
                email: document.getElementById('regEmail').value,
                pass: document.getElementById('regPass').value,
                rol: 'Usuario'
            };

            const res = await llamarBackend('crearUsuario', { payload });
            if (res.success) {
                alert("Usuario creado con √©xito");
                e.target.reset();
                cargarListaCompartir(); // Refrescar lista
                populateSharedWith(); // Refrescar dropdown
            }
        });

        async function populateSharedWith() {
            try {
                const data = await llamarBackend('getAllUsers');
                const select = document.getElementById('finCompartirCon');
                if (!select) return;

                const currentVal = select.value;
                select.innerHTML = '<option value="">No compartir</option>';

                if (data.usuarios) {
                    data.usuarios.forEach(u => {
                        if (u.id == currentUser.id) return;
                        if (u.status && u.status !== 'Active' && u.status !== '') return;
                        select.innerHTML += `<option value="${u.id}">${u.nombre}</option>`;
                    });
                }
                select.value = currentVal;
            } catch (err) { console.warn(err); }
        }

        function toggleCompartirDeuda() {
            const tipo = document.getElementById('finTipo').value;
            const div = document.getElementById('divCompartirDeuda');
            div.style.display = tipo === 'egreso' ? 'block' : 'none';
            if (tipo === 'egreso') populateSharedWith();
        }

        // --- CARGAR OTROS USUARIOS PARA COMPARTIR ---
        async function cargarListaCompartir() {
            try {
                const data = await llamarBackend('getAllUsers');
                const contenedor = document.getElementById('listaUsuariosCompartir');
                contenedor.innerHTML = "";

                if (data.usuarios) {
                    data.usuarios.forEach(u => {
                        if (u.id == currentUser.id) return;
                        if (u.status && u.status !== 'Active' && u.status !== '') return;

                        contenedor.innerHTML += `
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <span>${u.nombre}</span>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" 
                                           onchange="actualizarPermiso(${u.id}, this.checked)"
                                           ${u.tieneAcceso ? 'checked' : ''}>
                                </div>
                            </div>
                        `;
                    });
                }
            } catch (err) {
                console.warn("No se pudo cargar la lista de usuarios:", err);
            }
        }

        async function actualizarPermiso(idInvitado, otorgar) {
            await llamarBackend('gestionarPermiso', {
                idInvitado: idInvitado,
                accionPermiso: otorgar ? 'conceder' : 'revocar',
                userId: currentUser.id
            });
            console.log(`Permiso ${otorgar ? 'concedido' : 'revocado'} para usuario ${idInvitado}`);
        }

        // --- L√ìGICA DE INSTALACI√ìN PWA ---
        let deferredPrompt;
        const btnInstalar = document.getElementById('btnInstalar');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            btnInstalar.classList.remove('d-none');
        });

        btnInstalar.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    btnInstalar.classList.add('d-none');
                }
                deferredPrompt = null;
            }
        });

        window.addEventListener('appinstalled', () => {
            btnInstalar.classList.add('d-none');
            console.log('PWA instalada con √©xito');
        });

        // --- INICIO AUTOM√ÅTICO AL CARGAR ---
        window.addEventListener('DOMContentLoaded', () => {
            const session = JSON.parse(localStorage.getItem('plannerUser'));

            if (session && session.user) {
                currentUser = session.user;
                document.getElementById('loginWall').classList.add('d-none');
                cargarDatosIniciales();
            }
        });

        function cerrarSesion() {
            if (confirm("¬øEst√°s seguro de que quieres cerrar sesi√≥n?")) {
                localStorage.removeItem('plannerUser');
                location.reload();
            }
        }

        // ==================== NUEVAS FUNCIONALIDADES FINANCIERAS ====================

        // Variables globales para las nuevas funcionalidades
        let gastosRecurrentes = [];
        let gastosVariables = [];
        let ahorrosData = [];
        let chartsInstances = {
            mensual: null,
            semanal: null,
            comparativa: null
        };

        // ===== GASTOS RECURRENTES =====

        function actualizarConversionRecurrente() {
            const monto = parseFloat(document.getElementById('recMonto').value) || 0;
            document.getElementById('recConversionBS').textContent = (monto * tasaBCV).toFixed(2);
        }

        function actualizarDiaVencimiento() {
            const frecuencia = document.getElementById('recFrecuencia').value;
            const input = document.getElementById('recDia');
            const helper = document.getElementById('helperDia');

            if (frecuencia === 'weekly') {
                input.max = 7;
                input.placeholder = "D√≠a de la semana";
                helper.textContent = "D√≠a de la semana (1=Lunes, 7=Domingo)";
            } else {
                input.max = 31;
                input.placeholder = "D√≠a del mes";
                helper.textContent = "D√≠a del mes (1-31)";
            }
        }

        async function guardarGastoRecurrente() {
            const nombre = document.getElementById('recNombre').value.trim();
            const monto = parseFloat(document.getElementById('recMonto').value);
            const frecuencia = document.getElementById('recFrecuencia').value;
            const dia = parseInt(document.getElementById('recDia').value);

            if (!nombre || !monto || !dia) {
                alert('Por favor completa todos los campos');
                return;
            }

            const gasto = {
                id: Date.now() + '_' + currentUser.id,
                nombre,
                monto,
                frecuencia,
                diaVencimiento: dia,
                ownerId: currentUser.id,
                proximoPago: calcularProximoPago(frecuencia, dia)
            };

            try {
                // Intentar guardar en backend primero
                try {
                    const res = await llamarBackend('saveRecurringExpense', { payload: gasto });
                    if (res.success) {
                        console.log('Gasto recurrente guardado en backend');
                    }
                } catch (backendError) {
                    console.warn('Backend no disponible, usando localStorage:', backendError);
                }

                // Siempre guardar en localStorage como respaldo
                gastosRecurrentes.push(gasto);
                localStorage.setItem('gastosRecurrentes_' + currentUser.id, JSON.stringify(gastosRecurrentes));

                bootstrap.Modal.getInstance(document.getElementById('modalRecurrente')).hide();
                document.getElementById('formRecurrente').reset();

                cargarGastosRecurrentes();
                alert('Gasto recurrente agregado con √©xito');
            } catch (err) {
                console.error(err);
                alert('Error al guardar el gasto recurrente');
            }
        }

        function calcularProximoPago(frecuencia, dia) {
            const hoy = new Date();
            let proximaFecha = new Date();

            if (frecuencia === 'monthly') {
                proximaFecha.setDate(dia);
                if (proximaFecha <= hoy) {
                    proximaFecha.setMonth(proximaFecha.getMonth() + 1);
                }
            } else { // weekly
                const diaActual = hoy.getDay() || 7; // Domingo = 7
                let diasHasta = dia - diaActual;
                if (diasHasta <= 0) diasHasta += 7;
                proximaFecha.setDate(hoy.getDate() + diasHasta);
            }

            return proximaFecha.toISOString().split('T')[0];
        }

        async function cargarGastosRecurrentes() {
            // Intentar cargar desde backend primero
            try {
                const res = await llamarBackend('getRecurringExpenses', { userId: currentUser.id });
                if (res.success && res.data && res.data.length > 0) {
                    gastosRecurrentes = res.data;
                    // Sincronizar con localStorage
                    localStorage.setItem('gastosRecurrentes_' + currentUser.id, JSON.stringify(gastosRecurrentes));
                    console.log('Gastos recurrentes cargados desde backend');
                } else {
                    throw new Error('No data from backend');
                }
            } catch (backendError) {
                // Fallback a localStorage
                console.warn('Usando localStorage para gastos recurrentes');
                const stored = localStorage.getItem('gastosRecurrentes_' + currentUser.id);
                gastosRecurrentes = stored ? JSON.parse(stored) : [];
            }

            const lista = document.getElementById('listaRecurrentes');
            if (!lista) return;
            lista.innerHTML = '';

            if (gastosRecurrentes.length === 0) {
                lista.innerHTML = '<p class="text-muted text-center small">No hay gastos recurrentes</p>';
                return;
            }

            const hoy = new Date();
            gastosRecurrentes.forEach(g => {
                const fechaVence = new Date(g.proximoPago);
                const diasRestantes = Math.ceil((fechaVence - hoy) / (1000 * 60 * 60 * 24));

                let badge = '';
                if (diasRestantes < 0) {
                    badge = '<span class="badge bg-danger ms-1">Vencido</span>';
                } else if (diasRestantes <= 3) {
                    badge = '<span class="badge bg-warning text-dark ms-1">¬°Pr√≥ximo!</span>';
                }

                lista.innerHTML += `
                    <div class="border rounded p-2 mb-2">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>${g.nombre}</strong> ${badge}
                                <div class="small text-muted">
                                    ${g.frecuencia === 'monthly' ? 'üìÖ Mensual' : 'üìÜ Semanal'} - 
                                    Vence: ${new Date(g.proximoPago).toLocaleDateString()}
                                </div>
                            </div>
                            <div class="text-end">
                                <div class="fw-bold text-primary">$${parseFloat(g.monto).toFixed(2)}</div>
                                <small class="text-muted">Bs ${(parseFloat(g.monto) * tasaBCV).toFixed(2)}</small>
                            </div>
                        </div>
                        <div class="mt-2 d-flex gap-1">
                            <button class="btn btn-sm btn-success flex-fill" onclick="marcarRecurrentePagado('${g.id}')" style="font-size: 0.7rem;">
                                <i class="bi bi-check-circle"></i> Pagado
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="eliminarRecurrente('${g.id}')" style="font-size: 0.7rem;">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
        }

        async function marcarRecurrentePagado(id) {
            const gasto = gastosRecurrentes.find(g => g.id === id);
            if (!gasto) return;

            if (!confirm(`¬øMarcar "${gasto.nombre}" como pagado?`)) return;

            // Registrar el pago en finanzas
            await llamarBackend('saveFinance', {
                payload: {
                    tipo: 'egreso',
                    nombre: `${gasto.nombre} (Recurrente)`,
                    monto: gasto.monto,
                    fecha: new Date().toISOString(),
                    ownerId: currentUser.id
                }
            });

            // Actualizar pr√≥ximo pago
            const nuevaFecha = new Date(gasto.proximoPago);
            if (gasto.frecuencia === 'monthly') {
                nuevaFecha.setMonth(nuevaFecha.getMonth() + 1);
            } else {
                nuevaFecha.setDate(nuevaFecha.getDate() + 7);
            }
            gasto.proximoPago = nuevaFecha.toISOString().split('T')[0];

            // Actualizar en backend
            try {
                await llamarBackend('updateRecurringExpense', { payload: { id: gasto.id, proximoPago: gasto.proximoPago } });
            } catch (err) {
                console.warn('Error actualizando en backend:', err);
            }

            // Actualizar localStorage
            localStorage.setItem('gastosRecurrentes_' + currentUser.id, JSON.stringify(gastosRecurrentes));

            cargarGastosRecurrentes();
            cargarDatosIniciales();
            alert('¬°Pago registrado! Pr√≥ximo vencimiento actualizado.');
        }

        async function eliminarRecurrente(id) {
            if (!confirm('¬øEliminar este gasto recurrente?')) return;

            // Eliminar del backend
            try {
                await llamarBackend('deleteRecurringExpense', { id, userId: currentUser.id });
            } catch (err) {
                console.warn('Error eliminando del backend:', err);
            }

            // Eliminar de localStorage
            gastosRecurrentes = gastosRecurrentes.filter(g => g.id !== id);
            localStorage.setItem('gastosRecurrentes_' + currentUser.id, JSON.stringify(gastosRecurrentes));
            cargarGastosRecurrentes();
        }

        // ===== GASTOS VARIABLES SEMANALES =====

        function getNumeroSemana() {
            const hoy = new Date();
            const inicio = new Date(hoy.getFullYear(), 0, 1);
            const dias = Math.floor((hoy - inicio) / (24 * 60 * 60 * 1000));
            return Math.ceil((dias + inicio.getDay() + 1) / 7);
        }

        function agregarGastoVariable() {
            const categoria = document.getElementById('categoriaVariable').value;
            const concepto = document.getElementById('conceptoVariable').value.trim();
            const monto = parseFloat(document.getElementById('montoVariable').value);

            if (!concepto || !monto || monto <= 0) {
                alert('Por favor completa el concepto y monto');
                return;
            }

            const semanaActual = getNumeroSemana();
            const stored = localStorage.getItem('gastosVariables_' + currentUser.id);
            let gastosSemanales = stored ? JSON.parse(stored) : [];

            // Buscar si ya existe un registro para esta semana y categor√≠a
            let registroSemana = gastosSemanales.find(g => g.semana === semanaActual && g.categoria === categoria);

            if (!registroSemana) {
                registroSemana = {
                    semana: semanaActual,
                    categoria: categoria,
                    gastos: [],
                    totalSemana: 0,
                    pagado: false,
                    ownerId: currentUser.id
                };
                gastosSemanales.push(registroSemana);
            }

            registroSemana.gastos.push({
                concepto,
                monto,
                fecha: new Date().toISOString()
            });

            registroSemana.totalSemana = registroSemana.gastos.reduce((sum, g) => sum + g.monto, 0);

            localStorage.setItem('gastosVariables_' + currentUser.id, JSON.stringify(gastosSemanales));

            document.getElementById('conceptoVariable').value = '';
            document.getElementById('montoVariable').value = '';

            cargarGastosVariables();
        }

        function cargarGastosVariables() {
            const semanaActual = getNumeroSemana();
            const stored = localStorage.getItem('gastosVariables_' + currentUser.id);
            const gastosSemanales = stored ? JSON.parse(stored) : [];

            const registrosSemanaActual = gastosSemanales.filter(g => g.semana === semanaActual && !g.pagado);

            const lista = document.getElementById('listaVariables');
            lista.innerHTML = '';

            let totalSemana = 0;

            registrosSemanaActual.forEach(registro => {
                totalSemana += registro.totalSemana;

                registro.gastos.forEach(gasto => {
                    lista.innerHTML += `
                        <div class="d-flex justify-content-between align-items-center py-1 border-bottom">
                            <small>${gasto.concepto}</small>
                            <strong class="text-primary">$${gasto.monto.toFixed(2)}</strong>
                        </div>
                    `;
                });
            });

            document.getElementById('totalSemanalUSD').textContent = `$${totalSemana.toFixed(2)}`;
            document.getElementById('totalSemanalBS').textContent = `Bs ${(totalSemana * tasaBCV).toFixed(2)}`;

            document.getElementById('btnPagarSemana').disabled = totalSemana === 0;
        }

        async function pagarSemana() {
            const semanaActual = getNumeroSemana();
            const stored = localStorage.getItem('gastosVariables_' + currentUser.id);
            let gastosSemanales = stored ? JSON.parse(stored) : [];

            const registrosSemana = gastosSemanales.filter(g => g.semana === semanaActual && !g.pagado);

            if (registrosSemana.length === 0) return;

            const totalSemana = registrosSemana.reduce((sum, r) => sum + r.totalSemana, 0);

            if (!confirm(`¬øMarcar como pagado el total de la semana: $${totalSemana.toFixed(2)}?`)) return;

            // Registrar en finanzas
            for (const registro of registrosSemana) {
                await llamarBackend('saveFinance', {
                    payload: {
                        tipo: 'egreso',
                        nombre: `${registro.categoria} - Semana ${semanaActual}`,
                        monto: registro.totalSemana,
                        fecha: new Date().toISOString(),
                        ownerId: currentUser.id
                    }
                });

                registro.pagado = true;
            }

            localStorage.setItem('gastosVariables_' + currentUser.id, JSON.stringify(gastosSemanales));

            cargarGastosVariables();
            cargarDatosIniciales();
            alert('¬°Semana marcada como pagada! Los gastos han sido registrados.');
        }

        // ===== AHORROS =====

        function prepararAhorroModal(tipo) {
            document.getElementById('ahorroTipo').value = tipo;
            document.getElementById('tituloModalAhorros').textContent =
                tipo === 'deposito' ? 'Agregar Fondos a Ahorros' : 'Retirar Fondos de Ahorros';

            const btn = document.getElementById('btnGuardarAhorro');
            btn.className = tipo === 'deposito' ? 'btn btn-sm btn-success' : 'btn btn-sm btn-danger';
            btn.innerHTML = '<i class="bi bi-' + (tipo === 'deposito' ? 'plus' : 'dash') + '-circle"></i> Guardar';

            document.getElementById('formAhorros').reset();
            document.getElementById('ahorroTipo').value = tipo;
        }

        function actualizarConversionAhorro() {
            const moneda = document.getElementById('ahorroMoneda').value;
            const monto = parseFloat(document.getElementById('ahorroMonto').value) || 0;
            const conversion = document.getElementById('ahorroConversion');

            if (moneda === 'BS') {
                const enUSD = monto / tasaBCV;
                conversion.textContent = `‚âà $${enUSD.toFixed(2)} USD`;
            } else {
                const enBS = monto * tasaBCV;
                conversion.textContent = `‚âà Bs ${enBS.toFixed(2)}`;
            }
        }

        async function guardarAhorro() {
            const tipo = document.getElementById('ahorroTipo').value;
            const moneda = document.getElementById('ahorroMoneda').value;
            const monto = parseFloat(document.getElementById('ahorroMonto').value);
            const nota = document.getElementById('ahorroNota').value.trim();

            if (!monto || monto <= 0) {
                alert('Por favor ingresa un monto v√°lido');
                return;
            }

            const transaccion = {
                id: Date.now(),
                tipo,
                monto,
                moneda,
                nota,
                fecha: new Date().toISOString(),
                ownerId: currentUser.id
            };

            const stored = localStorage.getItem('ahorros_' + currentUser.id);
            ahorrosData = stored ? JSON.parse(stored) : [];

            ahorrosData.push(transaccion);
            localStorage.setItem('ahorros_' + currentUser.id, JSON.stringify(ahorrosData));

            bootstrap.Modal.getInstance(document.getElementById('modalAhorros')).hide();

            cargarAhorros();
            alert(`${tipo === 'deposito' ? 'Fondos agregados' : 'Fondos retirados'} con √©xito`);
        }

        function cargarAhorros() {
            const stored = localStorage.getItem('ahorros_' + currentUser.id);
            ahorrosData = stored ? JSON.parse(stored) : [];

            let totalUSD = 0;
            let totalBS = 0;

            ahorrosData.forEach(t => {
                const factor = t.tipo === 'deposito' ? 1 : -1;

                if (t.moneda === 'USD') {
                    totalUSD += t.monto * factor;
                } else {
                    totalBS += t.monto * factor;
                }
            });

            // Mostrar totales
            document.getElementById('totalAhorrosUSD').textContent = `$${totalUSD.toFixed(2)}`;
            const totalBSConvertido = (totalUSD * tasaBCV) + totalBS;
            document.getElementById('totalAhorrosBS').textContent = `Bs ${totalBSConvertido.toFixed(2)}`;

            // Actualizar stat del dashboard
            document.getElementById('statAhorros').textContent = `$${totalUSD.toFixed(2)}`;

            // Mostrar historial
            const historial = document.getElementById('historialAhorros');
            historial.innerHTML = '';

            if (ahorrosData.length === 0) {
                historial.innerHTML = '<p class="text-muted text-center">No hay transacciones</p>';
                return;
            }

            // Mostrar √∫ltimas 10 transacciones
            const ultimas = [...ahorrosData].reverse().slice(0, 10);

            ultimas.forEach(t => {
                const icono = t.tipo === 'deposito' ? '‚ûï' : '‚ûñ';
                const clase = t.tipo === 'deposito' ? 'text-success' : 'text-danger';

                historial.innerHTML += `
                    <div class="d-flex justify-content-between align-items-center py-1 border-bottom">
                        <div>
                            <div class="small">${icono} ${t.nota || (t.tipo === 'deposito' ? 'Dep√≥sito' : 'Retiro')}</div>
                            <div class="text-muted" style="font-size: 0.7rem;">${new Date(t.fecha).toLocaleDateString()}</div>
                        </div>
                        <strong class="${clase}">${t.monto.toFixed(2)} ${t.moneda}</strong>
                    </div>
                `;
            });
        }

        // ===== DASHBOARD Y GR√ÅFICAS =====

        function cargarDashboard() {
            // Actualizar estad√≠sticas del mes actual
            actualizarEstadisticas();

            // Renderizar gr√°ficas
            renderizarGraficaMensual();
            renderizarGraficaSemanal();
            renderizarGraficaComparativa();
        }

        function actualizarEstadisticas() {
            const hoy = new Date();
            const mesActual = hoy.getMonth();
            const anioActual = hoy.getFullYear();

            // Obtener datos de finanzas del mes actual
            const stored = localStorage.getItem('plannerUser');
            if (!stored) return;

            // Calcular desde las finanzas cargadas (esto deber√≠a venir del backend idealmente)
            let ingresosMes = 0;
            let gastosMes = 0;

            // Por ahora usar valores de ejemplo - idealmente calcular desde data real
            document.getElementById('statIngresosMes').textContent = `$${ingresosMes.toFixed(2)}`;
            document.getElementById('statGastosMes').textContent = `$${gastosMes.toFixed(2)}`;
            document.getElementById('statBalance').textContent = `$${(ingresosMes - gastosMes).toFixed(2)}`;
        }

        function renderizarGraficaMensual() {
            const ctx = document.getElementById('chartMensual');
            if (!ctx) return;

            // Destroy previous instance if exists
            if (chartsInstances.mensual) {
                chartsInstances.mensual.destroy();
            }

            // Datos de ejemplo - en producci√≥n vendr√≠an del backend
            const meses = ['Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            const ingresos = [500, 600, 550, 700, 650, 720];
            const gastos = [400, 500, 480, 600, 550, 600];

            chartsInstances.mensual = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: meses,
                    datasets: [
                        {
                            label: 'Ingresos',
                            data: ingresos,
                            backgroundColor: 'rgba(132, 250, 176, 0.7)',
                            borderColor: 'rgba(132, 250, 176, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Gastos',
                            data: gastos,
                            backgroundColor: 'rgba(250, 112, 154, 0.7)',
                            borderColor: 'rgba(250, 112, 154, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function renderizarGraficaSemanal() {
            const ctx = document.getElementById('chartSemanal');
            if (!ctx) return;

            if (chartsInstances.semanal) {
                chartsInstances.semanal.destroy();
            }

            const semanas = ['S-8', 'S-7', 'S-6', 'S-5', 'S-4', 'S-3', 'S-2', 'S-1'];
            const ingresos = [120, 150, 130, 180, 160, 170, 190, 200];
            const gastos = [100, 120, 110, 150, 140, 145, 160, 155];

            chartsInstances.semanal = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: semanas,
                    datasets: [
                        {
                            label: 'Ingresos',
                            data: ingresos,
                            borderColor: 'rgba(132, 250, 176, 1)',
                            backgroundColor: 'rgba(132, 250, 176, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Gastos',
                            data: gastos,
                            borderColor: 'rgba(250, 112, 154, 1)',
                            backgroundColor: 'rgba(250, 112, 154, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function renderizarGraficaComparativa() {
            const ctx = document.getElementById('chartComparativa');
            if (!ctx) return;

            if (chartsInstances.comparativa) {
                chartsInstances.comparativa.destroy();
            }

            chartsInstances.comparativa = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Mensual', 'Semanal (promedio)'],
                    datasets: [
                        {
                            label: 'Ingresos',
                            data: [650, 165],
                            backgroundColor: 'rgba(132, 250, 176, 0.7)'
                        },
                        {
                            label: 'Gastos',
                            data: [550, 140],
                            backgroundColor: 'rgba(250, 112, 154, 0.7)'
                        },
                        {
                            label: 'Balance',
                            data: [100, 25],
                            backgroundColor: 'rgba(168, 237, 234, 0.7)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // ===== FUNCI√ìN HELPER PARA GENERAR DATOS DE PRUEBA =====

        window.generarDatosDemo = function () {
            if (!currentUser) {
                alert('Debes iniciar sesi√≥n primero');
                return;
            }

            if (!confirm('¬øGenerar datos de demostraci√≥n? Esto agregar√° gastos recurrentes, gastos variables y ahorros de ejemplo.')) {
                return;
            }

            // Limpiar datos existentes
            localStorage.removeItem('gastosRecurrentes_' + currentUser.id);
            localStorage.removeItem('gastosVariables_' + currentUser.id);
            localStorage.removeItem('ahorros_' + currentUser.id);

            // Gastos Recurrentes de ejemplo
            const gastosRecDemo = [
                {
                    id: Date.now() + '_1',
                    nombre: 'Internet',
                    monto: 15.00,
                    frecuencia: 'monthly',
                    diaVencimiento: 15,
                    ownerId: currentUser.id,
                    proximoPago: calcularProximoPago('monthly', 15)
                },
                {
                    id: Date.now() + '_2',
                    nombre: 'Telefon√≠a M√≥vil',
                    monto: 8.50,
                    frecuencia: 'monthly',
                    diaVencimiento: 5,
                    ownerId: currentUser.id,
                    proximoPago: calcularProximoPago('monthly', 5)
                },
                {
                    id: Date.now() + '_3',
                    nombre: 'Gimnasio',
                    monto: 25.00,
                    frecuencia: 'monthly',
                    diaVencimiento: 1,
                    ownerId: currentUser.id,
                    proximoPago: calcularProximoPago('monthly', 1)
                }
            ];
            localStorage.setItem('gastosRecurrentes_' + currentUser.id, JSON.stringify(gastosRecDemo));

            // Gastos Variables de ejemplo
            const semanaActual = getNumeroSemana();
            const gastosVarDemo = [
                {
                    semana: semanaActual,
                    categoria: 'Transporte',
                    gastos: [
                        { concepto: 'Carrera moto taxi', monto: 2.50, fecha: new Date().toISOString() },
                        { concepto: 'Bus', monto: 1.00, fecha: new Date().toISOString() },
                        { concepto: 'Carrera moto taxi', monto: 3.00, fecha: new Date().toISOString() }
                    ],
                    totalSemana: 6.50,
                    pagado: false,
                    ownerId: currentUser.id
                },
                {
                    semana: semanaActual,
                    categoria: 'Comida',
                    gastos: [
                        { concepto: 'Almuerzo', monto: 5.00, fecha: new Date().toISOString() },
                        { concepto: 'Snacks', monto: 2.50, fecha: new Date().toISOString() }
                    ],
                    totalSemana: 7.50,
                    pagado: false,
                    ownerId: currentUser.id
                }
            ];
            localStorage.setItem('gastosVariables_' + currentUser.id, JSON.stringify(gastosVarDemo));

            // Ahorros de ejemplo
            const ahorrosDemo = [
                {
                    id: Date.now() - 10000,
                    tipo: 'deposito',
                    monto: 100.00,
                    moneda: 'USD',
                    nota: 'Ahorro inicial',
                    fecha: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString(),
                    ownerId: currentUser.id
                },
                {
                    id: Date.now() - 5000,
                    tipo: 'deposito',
                    monto: 500,
                    moneda: 'BS',
                    nota: 'Ahorro en bol√≠vares',
                    fecha: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString(),
                    ownerId: currentUser.id
                },
                {
                    id: Date.now(),
                    tipo: 'deposito',
                    monto: 50.00,
                    moneda: 'USD',
                    nota: 'Ahorro mensual',
                    fecha: new Date().toISOString(),
                    ownerId: currentUser.id
                }
            ];
            localStorage.setItem('ahorros_' + currentUser.id, JSON.stringify(ahorrosDemo));

            // Recargar todo
            cargarGastosRecurrentes();
            cargarGastosVariables();
            cargarAhorros();
            cargarDashboard();

            alert('‚úÖ Datos de demostraci√≥n generados!\n\nüîÅ 3 gastos recurrentes\nüìä 2 categor√≠as de gastos variables\nüí∞ 3 transacciones de ahorro');
        };

        // ==================== CALENDARIO DE PAGOS ====================

        let currentCalendarDate = new Date();
        let calendarEvents = [];

        function renderCalendar(year, month) {
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const prevLastDay = new Date(year, month, 0);

            const firstDayIndex = firstDay.getDay();
            const lastDateMonth = lastDay.getDate();
            const prevLastDate = prevLastDay.getDate();

            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            const dayNames = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];

            document.getElementById('calendarTitle').textContent = `${monthNames[month]} ${year}`;

            let html = '';

            // Headers de d√≠as
            dayNames.forEach(day => {
                html += `<div class="calendar-day-header">${day}</div>`;
            });

            // D√≠as del mes anterior
            for (let i = firstDayIndex; i > 0; i--) {
                html += `<div class="calendar-day other-month">
                    <div class="calendar-day-number">${prevLastDate - i + 1}</div>
                </div>`;
            }

            // D√≠as del mes actual
            const today = new Date();
            for (let day = 1; day <= lastDateMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isToday = day === today.getDate() && month === today.getMonth() && year === today.getFullYear();
                const events = calendarEvents.filter(e => e.date === dateStr);

                html += `<div class="calendar-day ${isToday ? 'today' : ''}" onclick="showEventDetails('${dateStr}')">
                    <div class="calendar-day-number">${day}</div>
                    <div class="event-dots">`;

                events.forEach(event => {
                    html += `<span class="event-dot ${event.type}" title="${event.title}"></span>`;
                });

                html += `</div></div>`;
            }

            // D√≠as del pr√≥ximo mes
            const nextDays = 42 - (firstDayIndex + lastDateMonth);
            for (let day = 1; day <= nextDays; day++) {
                html += `<div class="calendar-day other-month">
                    <div class="calendar-day-number">${day}</div>
                </div>`;
            }

            document.getElementById('calendarGrid').innerHTML = html;
        }

        function previousMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
        }

        function nextMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
        }

        function loadCalendarEvents() {
            calendarEvents = [];

            // Agregar finanzas regulares
            const finanzas = JSON.parse(localStorage.getItem('finanzas_' + currentUser?.id) || '[]');
            finanzas.forEach(f => {
                if (f[3]) {
                    const fecha = f[3].split('T')[0];
                    calendarEvents.push({
                        date: fecha,
                        type: f[0].toLowerCase() === 'ingreso' ? 'income' : 'expense',
                        title: f[1],
                        amount: f[2]
                    });
                }
            });

            // Agregar gastos recurrentes
            if (gastosRecurrentes && gastosRecurrentes.length > 0) {
                gastosRecurrentes.forEach(g => {
                    calendarEvents.push({
                        date: g.proximoPago,
                        type: 'recurring',
                        title: g.nombre,
                        amount: g.monto
                    });
                });
            }

            renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
        }

        function showEventDetails(dateStr) {
            const events = calendarEvents.filter(e => e.date === dateStr);
            if (events.length === 0) return;

            let html = '<div style="padding: 1rem;">';
            html += `<h6 class="mb-3">Eventos del ${dateStr}</h6>`;

            events.forEach(event => {
                const color = event.type === 'income' ? '#4caf50' : event.type === 'expense' ? '#f44336' : '#ff9800';
                html += `<div class="mb-2 p-2 border-start border-3" style="border-color: ${color} !important;">
                    <strong>${event.title}</strong><br>
                    <small class="text-muted">${event.type === 'income' ? 'Ingreso' : event.type === 'recurring' ? 'Gasto Recurrente' : 'Egreso'}</small><br>
                    <span class="fw-bold" style="color: ${color};">$${parseFloat(event.amount).toFixed(2)}</span>
                </div>`;
            });

            html += '</div>';

            // Mostrar en un modal simple
            if (confirm(`${events.length} evento(s) para ${dateStr}\n\nVer detalles?`)) {
                alert(events.map(e => `${e.title}: $${e.amount}`).join('\n'));
            }
        }

        // ==================== CAT√ÅLOGO DE PRODUCTOS ====================

        let allProducts = [];
        let shoppingList = [];
        let listHistory = [];

        async function loadProductsCatalog() {
            try {
                const res = await llamarBackend('getInitialData', { userId: currentUser.id });
                if (res.success && res.products) {
                    allProducts = res.products;
                    renderProductsCatalog(allProducts);
                    loadMercadoFilter();
                    document.getElementById('catalogCount').textContent = `${allProducts.length} productos`;
                }
            } catch (err) {
                console.error('Error cargando cat√°logo:', err);
            }

            // Cargar lista de compra
            loadShoppingList();
            loadListHistory();
        }

        function renderProductsCatalog(products) {
            const grid = document.getElementById('productsGrid');
            if (!grid) return;

            if (products.length === 0) {
                grid.innerHTML = '<p class="text-muted text-center col-span-full">No hay productos disponibles</p>';
                return;
            }

            grid.innerHTML = products.map(p => {
                const inList = shoppingList.some(item => item.productId === p[0]);
                return `
                    <div class="product-card ${inList ? 'in-list' : ''}" data-id="${p[0]}">
                        ${inList ? '<span class="badge-in-list"><i class="bi bi-check-circle"></i> En lista</span>' : ''}
                        <div class="product-image-placeholder">
                            <i class="bi bi-box-seam"></i>
                        </div>
                        <div class="product-info">
                            <div class="product-name">${p[1]}</div>
                            <div class="product-market">
                                <i class="bi bi-shop"></i> ${p[4]}
                            </div>
                            <div class="product-price">
                                <strong>$${parseFloat(p[3]).toFixed(2)}</strong><br>
                                <small class="text-muted">Bs ${(parseFloat(p[3]) * tasaBCV).toFixed(2)}</small>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-primary w-100 add-to-list-btn" onclick="addToShoppingList('${p[0]}')" ${inList ? 'disabled' : ''}>
                            <i class="bi bi-cart-plus"></i> ${inList ? 'En lista' : 'Agregar'}
                        </button>
                    </div>
                `;
            }).join('');
        }

        function loadMercadoFilter() {
            const mercados = [...new Set(allProducts.map(p => p[4]))];
            const select = document.getElementById('filterMercado');
            if (!select) return;

            select.innerHTML = '<option value="">Todos los mercados</option>' +
                mercados.map(m => `<option value="${m}">${m}</option>`).join('');
        }

        function filterProducts() {
            const searchTerm = document.getElementById('searchProductCatalog')?.value.toLowerCase() || '';
            const mercado = document.getElementById('filterMercado')?.value || '';

            const filtered = allProducts.filter(p => {
                const matchSearch = p[1].toLowerCase().includes(searchTerm);
                const matchMercado = !mercado || p[4] === mercado;
                return matchSearch && matchMercado;
            });

            renderProductsCatalog(filtered);
            document.getElementById('catalogCount').textContent = `${filtered.length} productos`;
        }

        function clearProductFilters() {
            document.getElementById('searchProductCatalog').value = '';
            document.getElementById('filterMercado').value = '';
            filterProducts();
        }

        // Event listeners para filtros
        document.addEventListener('DOMContentLoaded', function () {
            const searchInput = document.getElementById('searchProductCatalog');
            const mercadoSelect = document.getElementById('filterMercado');

            if (searchInput) {
                searchInput.addEventListener('input', filterProducts);
            }

            if (mercadoSelect) {
                mercadoSelect.addEventListener('change', filterProducts);
            }
        });

        // ==================== LISTA DE COMPRA ====================

        function addToShoppingList(productId) {
            const product = allProducts.find(p => p[0] == productId);
            if (!product) return;

            if (shoppingList.some(item => item.productId == productId)) {
                showToast('Producto ya est√° en la lista', 'info');
                return;
            }

            shoppingList.push({
                productId: product[0],
                nombre: product[1],
                mercado: product[4],
                precio: parseFloat(product[3]),
                quantity: 1
            });

            saveShoppingList();
            renderShoppingList();
            filterProducts(); // Re-render para actualizar badges
            showToast(`${product[1]} agregado a la lista`, 'success');
        }

        function removeFromShoppingList(productId) {
            shoppingList = shoppingList.filter(item => item.productId != productId);
            saveShoppingList();
            renderShoppingList();
            filterProducts();
            showToast('Producto eliminado de la lista', 'info');
        }

        function updateQuantity(productId, newQuantity) {
            const item = shoppingList.find(i => i.productId == productId);
            if (item && newQuantity > 0) {
                item.quantity = parseInt(newQuantity);
                saveShoppingList();
                renderShoppingList();
            }
        }

        function incrementQuantity(productId) {
            const item = shoppingList.find(i => i.productId == productId);
            if (item) {
                item.quantity++;
                saveShoppingList();
                renderShoppingList();
            }
        }

        function decrementQuantity(productId) {
            const item = shoppingList.find(i => i.productId == productId);
            if (item && item.quantity > 1) {
                item.quantity--;
                saveShoppingList();
                renderShoppingList();
            }
        }

        function renderShoppingList() {
            const container = document.getElementById('shoppingListItems');
            if (!container) return;

            if (shoppingList.length === 0) {
                container.innerHTML = `
                    <p class="text-muted text-center small my-4">
                        <i class="bi bi-cart-x fs-3 d-block mb-2"></i>
                        Tu lista est√° vac√≠a
                    </p>
                `;
                document.getElementById('listCountBadge').textContent = '0';
                document.getElementById('listTotalUSD').textContent = '$0.00';
                document.getElementById('listTotalBS').textContent = 'Bs 0.00';
                document.getElementById('btnExportList').disabled = true;
                return;
            }

            let total = 0;
            container.innerHTML = shoppingList.map(item => {
                const subtotal = item.precio * item.quantity;
                total += subtotal;

                return `
                    <div class="list-item">
                        <div class="item-info">
                            <strong>${item.nombre}</strong>
                            <small class="text-muted d-block">${item.mercado}</small>
                            <small class="text-primary">$${item.precio.toFixed(2)} c/u</small>
                        </div>
                        <div class="item-quantity">
                            <button class="qty-btn" onclick="decrementQuantity('${item.productId}')">
                                <i class="bi bi-dash"></i>
                            </button>
                            <input type="number" value="${item.quantity}" min="1" 
                                onchange="updateQuantity('${item.productId}', this.value)">
                            <button class="qty-btn" onclick="incrementQuantity('${item.productId}')">
                                <i class="bi bi-plus"></i>
                            </button>
                        </div>
                        <div class="item-price">$${subtotal.toFixed(2)}</div>
                        <button class="btn-remove-item" onclick="removeFromShoppingList('${item.productId}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                `;
            }).join('');

            document.getElementById('listCountBadge').textContent = shoppingList.length;
            document.getElementById('listTotalUSD').textContent = `$${total.toFixed(2)}`;
            document.getElementById('listTotalBS').textContent = `Bs ${(total * tasaBCV).toFixed(2)}`;
            document.getElementById('btnExportList').disabled = false;
        }

        function saveShoppingList() {
            if (currentUser) {
                localStorage.setItem('shoppingList_' + currentUser.id, JSON.stringify(shoppingList));
            }
        }

        function loadShoppingList() {
            if (currentUser) {
                const stored = localStorage.getItem('shoppingList_' + currentUser.id);
                shoppingList = stored ? JSON.parse(stored) : [];
                renderShoppingList();
            }
        }

        function clearShoppingList() {
            if (shoppingList.length === 0) return;

            if (confirm(`¬øLimpiar toda la lista de compra (${shoppingList.length} productos)?`)) {
                // Guardar en historial antes de limpiar
                saveToHistory();
                shoppingList = [];
                saveShoppingList();
                renderShoppingList();
                filterProducts();
                showToast('Lista de compra limpiada', 'success');
            }
        }

        // ==================== FUNCIONALIDADES OPCIONALES ====================

        // Exportar/Compartir lista
        function exportShoppingList() {
            if (shoppingList.length === 0) return;

            let total = shoppingList.reduce((sum, item) => sum + (item.precio * item.quantity), 0);

            let text = `üõí LISTA DE COMPRA - MarketPlanner\n`;
            text += `Fecha: ${new Date().toLocaleDateString()}\n`;
            text += `\n`;

            shoppingList.forEach(item => {
                text += `‚Ä¢ ${item.nombre} (${item.quantity}x) - $${(item.precio * item.quantity).toFixed(2)}\n`;
                text += `  ${item.mercado}\n`;
            });

            text += `\nüí∞ TOTAL: $${total.toFixed(2)} (Bs ${(total * tasaBCV).toFixed(2)})`;

            if (navigator.share) {
                navigator.share({
                    title: 'Mi Lista de Compra',
                    text: text
                }).then(() => {
                    showToast('Lista compartida exitosamente', 'success');
                }).catch(err => {
                    console.log('Error sharing:', err);
                    copyToClipboard(text);
                });
            } else {
                copyToClipboard(text);
            }
        }

        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            showToast('Lista copiada al portapapeles', 'success');
        }

        // Historial de listas
        function saveToHistory() {
            if (shoppingList.length === 0) return;

            const total = shoppingList.reduce((sum, item) => sum + (item.precio * item.quantity), 0);

            listHistory.unshift({
                id: Date.now(),
                date: new Date().toISOString(),
                items: [...shoppingList],
                total: total,
                count: shoppingList.length
            });

            // Mantener solo √∫ltimas 10 listas
            if (listHistory.length > 10) {
                listHistory = listHistory.slice(0, 10);
            }

            if (currentUser) {
                localStorage.setItem('listHistory_' + currentUser.id, JSON.stringify(listHistory));
            }

            renderListHistory();
        }

        function loadListHistory() {
            if (currentUser) {
                const stored = localStorage.getItem('listHistory_' + currentUser.id);
                listHistory = stored ? JSON.parse(stored) : [];
                renderListHistory();
            }
        }

        function renderListHistory() {
            const container = document.getElementById('listHistory');
            if (!container) return;

            if (listHistory.length === 0) {
                container.innerHTML = '<p class="text-muted text-center my-2">Sin historial</p>';
                return;
            }

            container.innerHTML = listHistory.map(list => {
                const date = new Date(list.date).toLocaleDateString();
                return `
                    <div class="history-item" onclick="loadHistoryList('${list.id}')">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${date}</strong>
                                <br><small class="text-muted">${list.count} productos</small>
                            </div>
                            <div class="text-end">
                                <strong class="text-primary">$${list.total.toFixed(2)}</strong>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function loadHistoryList(listId) {
            const list = listHistory.find(l => l.id == listId);
            if (!list) return;

            if (confirm(`¬øCargar lista del ${new Date(list.date).toLocaleDateString()}?\n${list.count} productos - $${list.total.toFixed(2)}`)) {
                shoppingList = [...list.items];
                saveShoppingList();
                renderShoppingList();
                filterProducts();
                showToast('Lista del historial cargada', 'success');
            }
        }

        // Toast notifications
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `custom-toast ${type}`;
            toast.innerHTML = `
                <div class="d-flex align-items-center gap-2">
                    <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;

            let container = document.querySelector('.toast-container');
            if (!container) {
                container = document.createElement('div');
                container.className = 'toast-container';
                document.body.appendChild(container);
            }

            container.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ==================== INICIALIZATION ====================

        // Extender cargarDatosIniciales para incluir calendario y productos
        const originalCargarDatosIniciales = cargarDatosIniciales;
        cargarDatosIniciales = async function () {
            await originalCargarDatosIniciales();
            if (currentUser) {
                loadCalendarEvents();
                loadProductsCatalog();
            }
        };

        // ==================== FIN NUEVAS FUNCIONALIDADES ====================
    </script>
    <script>
        // --- SYNC DARK MODE ATTRIBUTE ---
        function syncDarkMode() {
            const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            document.documentElement.setAttribute('data-bs-theme', isDark ? 'dark' : 'light');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', syncDarkMode);
        syncDarkMode();
    </script>
</body>

</html>
